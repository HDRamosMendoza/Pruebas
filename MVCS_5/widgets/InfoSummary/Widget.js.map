{"version":3,"sources":["../../../widgets/InfoSummary/Widget.js"],"names":["define","BaseWidget","LayerInfos","utils","dom","domClass","domConstruct","on","domStyle","declare","lang","html","dojoColor","all","array","DeferredList","Deferred","query","fx","gfx","xhr","_WidgetsInTemplateMixin","Graphic","Point","SimpleMarkerSymbol","PictureMarkerSymbol","SimpleLineSymbol","SimpleFillSymbol","Color","Query","QueryTask","FeatureSet","arcgisUtils","jsonUtils","esriRequest","SimpleRenderer","jsonUtil","ClusterLayer","LayerDrawingOptions","baseClass","name","opLayerInfos","layerList","UNIQUE_APPEND_VAL_CL","widgetChange","refreshInterval","refreshIntervalValue","configLayerInfos","legendNodes","currentQueryList","symbols","row","postCreate","inherited","arguments","inPanelOverrides","appConfig","theme","config","layerInfos","_initWidget","_forceClose","themeName","dcThemes","p","getPanel","indexOf","containerNode","parentNode","style","display","widgetManager","closeWidget","id","getParent","_toggleBox","ss","i","length","outerHTML","aw","widgets","widgetOnScreen","ii","isThemeWidget","getWidgetById","_switchNodeToClose","_closeDropMenu","iconClickHandler","remove","undefined","hidePanel","iconNodeThemes","iconNodes","hitch","firstChild","className","padding","_updateBackgroundColors","isDartTheme","isDashboardTheme","contains","pageHeader","add","updateForDartTheme","updateForBoxTheme","updateForTabTheme","updateForLaunchpadTheme","updateForBillboardTheme","updateForPlateauTheme","updateForDashboardTheme","top","children","fc","isOnScreen","right","left","lastUpdated","useDarkText","startup","showAllFeatures","mapExtentChangedHandler","map","_mapExtentChange","onOpen","_updatePanelHeader","styles","_updateStyleColor","visibleSubLayers","key","layerListLayer","li","lo","layerObject","orgRenderer","setRenderer","newRenderer","setLayerDrawingOptions","optionsArray","drawingOptions","renderer","subLayerId","console","log","refresh","_Pl","parentLayerID","getLayer","l","visibleLayers","_foundIt","sub_layers_id_loop","subVizLyrId","push","layers","x","subLayerLoop","o","visLayers","inVisLayers","plVis","parentLayerVisible","loPlVis","type","visible","splice","graphicsLayerIds","setVisibility","updatePanelVisibility","_parentLayer","expandList","legendOpen","isLoaded","visScaleRange","_inVisibleRange","updateList","parentLayer","setVisibleLayers","refreshEnabled","enableRefresh","infoWindow","highlight","c","byId","countEnabled","listDisabled","toggleLegend","checkedTime","itemId","getItem","tempVal","setInterval","refreshLayers","clearInterval","portalUrl","window","substr","url","content","f","requestTime","Date","now","then","response","itemModified","modified","update","lastModifiedTime","_updatePanelTime","_updateItem","modifiedTime","innerHTML","_d","_f","dateFormat","fieldFormatter","getFormattedDate","lyr","featureCollection","_updateLayerItem","responseLayer","list","fields","k","pl","layerDefinition","symbolData","featureDisplayOptions","refreshFeatures","_loadList","featureSet","graphics","responseFeatureSetFeatures","features","mapFeatureSetFeatures","responseSR","_getSpatialReference","mapSR","forEach","gra","g","geometry","geom","rings","paths","points","y","attributes","mixin","spatialReference","wkid","transform","fs","shouldUpdate","JSON","stringify","requiresReload","layerListExtentChanged","clear","sr","j","item","go","getGraphicOptions","setAttributes","_infoTemplate","setInfoTemplate","countFeatures","hasOwnProperty","firstFeature","graphicOptions","getInstance","itemInfo","operLayerInfos","wmLayerInfos","getLayerInfoArrayOfWebmap","getLayerInfoArray","_updateLayerIDs","upgradeFields","_upgradeFields","_createPanelUI","_addFilterChanged","_addVisibleChanged","_addZoomChanged","removeIDs","getUrl","configLayer","jimuLayerInfo","config_layer_loop","getLayerInfoById","updated","wm_layer_loop","_opLayer","originOpLayer","originOperLayer","urlId","_compareURL","_compareItemID","subId","_compareSubId","layer","sort","a","b","opLayer","geomMatch","_compareGeom","fieldMatch","_compareFields","fcLayers","fcLayer","geometryType","matchingFields","filter","fn","configField","lyrInfo","oidFieldName","objectIdField","firstLayerFieldName","firstLayerFieldAlias","layerFields","layer_field_loop","_i","alias","keyFieldName","keyFieldAlias","infoTemplate","info","fieldInfos","getInfoTemplate","subLayers","getSubLayers","sub_layers_loop","sli","sl","title","popupFields","popup_field_loop","popupField","fieldName","label","parseFloat","wabVersion","own","changedLayerInfoArray","layerInfo","clId","getFilter","_initFeatures","_updateVisibility","vis","isShowInMap","_toggleLayerUI","changedLayerInfos","traversal","panelTitle","w","width","displayPanelIcon","removeClass","mainPanelText","addClass","pageBody","pageTitle","panelMainIcon","mainPanelIcon","jimuLayerInfos","numClusterLayers","_updateUI","_clearChildNodes","pageMain","updateEnd","clusterType","updateThemeClusterSymbol","getLayerType","layerType","getLayerObject","updateLayerList","_updateEnd","addMapLayers","results","lid","target","updating","sd","_styleColor","_rgb","fromHex","xx","evenOdd","r","rr","bb","gg","clusterSymbol","color","outline","removeOldClusterLayers","lInfos","deleteLayers","layer_info_loop","potentialNewClusterID","clusteringEnabled","dl","_dl","setTopLayerVisible","removeLayer","destroy","ids","Object","keys","reverse","addLayer","lyrType","ll","selfType","_checkSelfType","_checkListDisabled","_getClusterLayer","parentLayerInfo","_lyr","empty","getFeatureLayers","featureLayers","fl","updateRenderer","_addPanelItem","_lo","symbolType","fromJson","symbol","_onRecNodeMouseover","rec","isLightTheme","_onRecNodeMouseout","potentialNewID","cssAry","create","expandClass","isInScale","setStyle","recIcon","panelImageData","toString","img","document","createElement","icon","src","_createImageDataDiv","set","recLabel","recNum","node","_addLegend","_updateNode","nodeCount","_toggleLayerVisibility","_toggleLegend","_class","legendNode","_getListFields","infoTemp","_getInfoTemplate","fieldInfo","displayOptions","field","groupField","updateCount","_addSearching","clusterFeatures","clusterGraphics","_features","z","clusterGraphic","setTimeout","_updateList","_removeSearching","getFeatures","disabled","eD","eU","eS","clusterLayer","n","configChange","_layers","reloadData","refreshData","countColor","_highLightColor","toDom","displayFeatureCount","_setupSymbols","sym","h","parent","isCustom","height","ar","setWidth","setHeight","size","setSize","mySurface","createSurface","descriptors","getShapeDescriptors","shape","createShape","defaultShape","setFill","fill","setStroke","stroke","applyTransform","dx","dy","styleName","removeDownClass","addDownClass","_updateNodes","removeUpClass","addUpClass","removeExpandClass","addExpandClass","removeGroupItemUpClass","addGroupItemUpClass","removeGroupItemDownClass","addGroupItemDownClass","removeGroupItemClass","addGroupItemClass","nodes","obj","e","stopPropagation","hide","hasSubLayerId","_vis","currentLayerInfo","handleMapExtentChange","levelChange","flashFeatures","visibility","visScalRange","isCurrentScaleInTheScaleRange","_append","evt","currentTarget","_toggleGroup","slice","fI","toggle","gII","gIIUp","gIIDown","lId","getElementById","_idx","childNodes","openGroups","groupOpen","idx","onAppConfigChanged","reason","changedData","_clearMap","bc","getComputedStyle","getPropertyValue","fromRgb","toHex","setStyleColor","_clear","continuousRefreshEnabled","_close","onClose","disableRefresh","hasChildNodes","removeChild","lastChild","visibleAtMapScale","queries","_clearList","groupEnabled","initalLoad","uNode","_needsGeom","maxRecordCount","q","_getQuery","queryFeatures","queryIds","qt","execute","executeForIds","featurePromises","s_id","updateNode","previousSibling","_queries","queryIDs","count","_chunkRequest","fullFeatures","localizeNumber","updateExpand","IDs","max","needsGeom","def","outFields","objectIds","returnGeometry","queryList","queryResults","allFeatures","apply","resolve","countOnly","_graphicsLayer","_fields","groupNodes","finalGroupNodes","finalDomNodes","groupAdded","feature","getSymbol","oidName","_layer","flds","isNames","displayStringObj","getDisplayString","displayString","aliasNames","firstValue","groupNode","groupContainer","displayValue","groupType","featureValue","_value","appendVal","groupByField","groupByRendererOptions","groubByFields","groupByValues","values","expression_loop","_val","exp","value","expParts","split","isNaN","eval","replace","gId","addGroup","node_loop","iii","gNode","groupTitle","_getFormattedValue","clone","inGrpList","groupCountNode","imageContainer","cNames","countNode","result","featureItem","_panToFeature","_margin","_txtAlign","isRTL","localeCompare","cE","appendChild","sortedNodes","_a","_b","fdn","place","loaded","queryPending","en","displayField","_checkAliasName","hasLabel","append","trim","_fieldsMap","Array","isArray","_getFieldByName","intField","_checkIntField","domainField","_checkDomainField","dateField","_checkDateField","formatDateValue","formatDomainValue","formatNumberValue","infoTemplates","v","num","options","format","localizeNumberByFieldInfo","domain","codedValues","cvs","cv","code","d","parseInt","localizeDateByFieldInfo","localizeDate","testTypes","_checkDisplayField","displayFields","featureField","includeField","flashGraphics","_flashFeature","color2","STYLE_CIRCLE","STYLE_SOLID","STYLE_DIAGONAL_CROSS","dShape","getDojoShape","animateStroke","duration","start","strokeStyle","end","play","_clearFeature","gl","path","Math","ceil","getExtent","getCenter","_pan","setFeatures","select","show","centerPoint","extent","centerAt","ext","collectionTypes","isCollection","where","fullExtent","queryCount"],"mappings":"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","file":"Widget.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright © 2014 - 2018 Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\n/*jshint loopfunc: true */\r\ndefine(['jimu/BaseWidget',\r\n'jimu/LayerInfos/LayerInfos',\r\n'jimu/utils',\r\n'dojo/dom',\r\n'dojo/dom-class',\r\n'dojo/dom-construct',\r\n'dojo/on',\r\n'dojo/dom-style',\r\n'dojo/_base/declare',\r\n'dojo/_base/lang',\r\n'dojo/_base/html',\r\n'dojo/_base/Color',\r\n'dojo/promise/all',\r\n'dojo/_base/array',\r\n'dojo/DeferredList',\r\n'dojo/Deferred',\r\n'dojo/query',\r\n\"dojox/gfx/fx\",\r\n'dojox/gfx',\r\n'dojo/_base/xhr',\r\n'dijit/_WidgetsInTemplateMixin',\r\n'esri/graphic',\r\n'esri/geometry/Point',\r\n'esri/symbols/SimpleMarkerSymbol',\r\n'esri/symbols/PictureMarkerSymbol',\r\n'esri/symbols/SimpleLineSymbol',\r\n'esri/symbols/SimpleFillSymbol',\r\n'esri/Color',\r\n'esri/tasks/query',\r\n'esri/tasks/QueryTask',\r\n\"esri/tasks/FeatureSet\",\r\n\"esri/arcgis/utils\",\r\n'esri/symbols/jsonUtils',\r\n'esri/request',\r\n\"esri/renderers/SimpleRenderer\",\r\n\"esri/renderers/jsonUtils\",\r\n'./js/ClusterLayer',\r\n'esri/layers/LayerDrawingOptions'\r\n],\r\nfunction (BaseWidget,\r\n  LayerInfos,\r\n  utils,\r\n  dom,\r\n  domClass,\r\n  domConstruct,\r\n  on,\r\n  domStyle,\r\n  declare,\r\n  lang,\r\n  html,\r\n  dojoColor,\r\n  all,\r\n  array,\r\n  DeferredList,\r\n  Deferred,\r\n  query,\r\n  fx,\r\n  gfx,\r\n  xhr,\r\n  _WidgetsInTemplateMixin,\r\n  Graphic,\r\n  Point,\r\n  SimpleMarkerSymbol,\r\n  PictureMarkerSymbol,\r\n  SimpleLineSymbol,\r\n  SimpleFillSymbol,\r\n  Color,\r\n  Query,\r\n  QueryTask,\r\n  FeatureSet,\r\n  arcgisUtils,\r\n  jsonUtils,\r\n  esriRequest,\r\n  SimpleRenderer,\r\n  jsonUtil,\r\n  ClusterLayer,\r\n  LayerDrawingOptions\r\n  ) {\r\n  return declare([BaseWidget, _WidgetsInTemplateMixin], {\r\n    baseClass: 'jimu-widget-InfoSummary',\r\n\r\n    name: \"InfoSummary\",\r\n    opLayerInfos: null,\r\n    layerList: {},\r\n    UNIQUE_APPEND_VAL_CL: \"_CL\",\r\n    widgetChange: false,\r\n    refreshInterval: 0,\r\n    refreshIntervalValue: 0,\r\n    configLayerInfos: [],\r\n    legendNodes: [],\r\n    currentQueryList: [],\r\n    symbols: [],\r\n    row: null,\r\n\r\n    postCreate: function () {\r\n      this.inherited(arguments);\r\n      this.inPanelOverrides(this.appConfig.theme.name);\r\n      this.configLayerInfos = this.config.layerInfos;\r\n      this.layerList = {};\r\n      //populates this.layerInfos and creates the panel\r\n      this._initWidget();\r\n    },\r\n\r\n    _forceClose: function () {\r\n      var themeName = this.appConfig.theme.name;\r\n      var dcThemes = ['LaunchpadTheme', 'DartTheme', 'FoldableTheme',\r\n        'JewelryBoxTheme', 'BillboardTheme', 'TabTheme', 'DashboardTheme'];\r\n      var p = this.getPanel();\r\n      if (dcThemes.indexOf(themeName) > -1) {\r\n        p.containerNode.parentNode.style.display = 'none';\r\n        p.containerNode.style.display = 'none';\r\n        this.widgetManager.closeWidget(this.id);\r\n      } else if (themeName === 'BoxTheme') {\r\n        p.containerNode.parentNode.style.display = 'none';\r\n        p.containerNode.style.display = 'none';\r\n        if (p.getParent && p.getParent()._toggleBox) {\r\n          var ss = query('.icon-node-active');\r\n          for (var i = 0; i < ss.length; i++) {\r\n            if (ss[i].outerHTML.indexOf(this.id) > -1) {\r\n              p.getParent()._toggleBox();\r\n            }\r\n          }\r\n        }\r\n      } else if (themeName === 'PlateauTheme') {\r\n        p.containerNode.parentNode.style.display = 'none';\r\n        p.containerNode.style.display = 'none';\r\n        this.widgetManager.closeWidget(this.id);\r\n        if (!this.aw) {\r\n          var widgets = this.widgetManager.appConfig.widgetOnScreen.widgets;\r\n          for (var ii = 0; ii < this.widgetManager.appConfig.widgetOnScreen.widgets.length; ii++) {\r\n            if (widgets[ii].isThemeWidget) {\r\n              this.aw = this.widgetManager.getWidgetById(widgets[ii].id);\r\n              this.aw._switchNodeToClose(this.id);\r\n              this.aw._closeDropMenu();\r\n              break;\r\n            }\r\n          }\r\n        } else {\r\n          this.aw._switchNodeToClose(this.id);\r\n          this.aw._closeDropMenu();\r\n        }\r\n      }\r\n    },\r\n\r\n    inPanelOverrides: function (themeName) {\r\n      if (typeof (this.iconClickHandler) !== 'undefined') {\r\n        this.iconClickHandler.remove();\r\n        this.iconClickHandler = undefined;\r\n      }\r\n\r\n      var p = this.getPanel();\r\n\r\n      if (this.config.hidePanel) {\r\n        var iconNodeThemes = ['DartTheme', 'BoxTheme', 'FoldableTheme', 'JewelryBoxTheme', 'PlateauTheme'];\r\n\r\n        var iconNodes;\r\n        if (themeName === 'LaunchpadTheme') {\r\n          this._forceClose();\r\n          iconNodes = query('.selected');\r\n          if (iconNodes.length > 0) {\r\n            if (iconNodes[0].parentNode.outerHTML.indexOf(this.id) > -1) {\r\n              this.iconClickHandler = on(iconNodes[0], 'click', lang.hitch(this, this._forceClose));\r\n            }\r\n          }\r\n        } else if (iconNodeThemes.indexOf(themeName) > -1) {\r\n          if (themeName === 'BoxTheme') {\r\n            this._forceClose(); //did this for box...make sure it doesn't jack others up\r\n          }\r\n          iconNodes = query('.icon-node');\r\n          for (var i = 0; i < iconNodes.length; i++) {\r\n            if (iconNodes[i].outerHTML.indexOf(this.id) > -1) {\r\n              this.iconClickHandler = on(iconNodes[i], 'click', lang.hitch(this, this._forceClose));\r\n            }\r\n          }\r\n        }\r\n      } else {\r\n        //TODO test if this has the class .jimu-widget-frame.jimu-container\r\n        if (p.containerNode && p.containerNode.firstChild && p.containerNode.firstChild.className) {\r\n          p.containerNode.firstChild.style.padding = '0px 0px 10px 0px';\r\n        }\r\n\r\n        //change associated with the tab theme...all others will show the background color behind refresh text and panel image\r\n        if (['TabTheme', 'BillboardTheme', 'PlateauTheme', 'DashboardTheme'].indexOf(themeName) === -1) {\r\n          this._updateBackgroundColors(true);\r\n        }\r\n\r\n        this.isDartTheme = themeName === \"DartTheme\";\r\n        this.isDashboardTheme = themeName === 'DashboardTheme';\r\n        if (domClass.contains(this.pageHeader, this.isDartTheme ? 'pageHeader-border' : 'pageHeader-border-dart')) {\r\n          domClass.remove(this.pageHeader, this.isDartTheme ? 'pageHeader-border' : 'pageHeader-border-dart');\r\n        }\r\n        domClass.add(this.pageHeader, this.isDartTheme ? 'pageHeader-border-dart' : 'pageHeader-border');\r\n\r\n        switch (themeName) {\r\n          case 'DartTheme':\r\n            this.updateForDartTheme(p);\r\n            break;\r\n          case 'BoxTheme':\r\n            this.updateForBoxTheme(p);\r\n            break;\r\n          case 'TabTheme':\r\n            this.updateForTabTheme(p);\r\n            break;\r\n          case 'LaunchpadTheme':\r\n            this.updateForLaunchpadTheme(p);\r\n            break;\r\n          case 'BillboardTheme':\r\n            this.updateForBillboardTheme(p);\r\n            break;\r\n          case 'PlateauTheme':\r\n            this.updateForPlateauTheme(p);\r\n            break;\r\n          case 'DashboardTheme':\r\n            this.updateForDashboardTheme(p);\r\n            break;\r\n        }\r\n      }\r\n    },\r\n\r\n    updateForLaunchpadTheme: function (p) {\r\n      p.containerNode.style.top = '30px';\r\n    },\r\n\r\n    updateForTabTheme: function (p) {\r\n      if (p.containerNode.children.length > 0) {\r\n        var fc = p.containerNode.children[0];\r\n        if (fc.children.length > 1) {\r\n          fc.children[1].style.padding = '14px 0px 14px 0px';\r\n        }\r\n      }\r\n      if (!p.config.isOnScreen) {\r\n        this._updateBackgroundColors(false);\r\n      }\r\n    },\r\n\r\n    updateForBoxTheme: function (p) {\r\n      p.containerNode.parentNode.style.top = '140px';\r\n    },\r\n\r\n    updateForDartTheme: function (p) {\r\n      p.containerNode.style.right = '0px';\r\n      p.containerNode.style.left = '0px';\r\n    },\r\n\r\n    updateForBillboardTheme: function () {\r\n      this._updateBackgroundColors(false);\r\n    },\r\n\r\n    updateForPlateauTheme: function () {\r\n      this._updateBackgroundColors(false);\r\n    },\r\n\r\n    updateForDashboardTheme: function () {\r\n      this._updateBackgroundColors(false);\r\n    },\r\n\r\n    _updateBackgroundColors: function (add) {\r\n      //deal with text color\r\n      if (domClass.contains(this.lastUpdated, add ? 'lastUpdated-tab' : 'lastUpdated')) {\r\n        domClass.remove(this.lastUpdated, add ? 'lastUpdated-tab' : 'lastUpdated');\r\n      }\r\n      domClass.add(this.lastUpdated, add ? 'lastUpdated' : 'lastUpdated-tab');\r\n\r\n      add = add && this.appConfig.theme.name !== 'DashboardTheme';\r\n      this.useDarkText = !add;\r\n\r\n      //deal with background color for page header\r\n      if (domClass.contains(this.pageHeader, 'jimu-main-background') && !add) {\r\n        domClass.remove(this.pageHeader, 'jimu-main-background');\r\n      } else if (!domClass.contains(this.pageHeader, 'jimu-main-background') && add) {\r\n        domClass.add(this.pageHeader, 'jimu-main-background');\r\n      }\r\n      if (domClass.contains(this.pageHeader, 'dart-bgcolor') && !add) {\r\n        domClass.remove(this.pageHeader, 'dart-bgcolor');\r\n      } else if (!domClass.contains(this.pageHeader, 'dart-bgcolor') && add) {\r\n        domClass.add(this.pageHeader, 'dart-bgcolor');\r\n      }\r\n      if (domClass.contains(this.pageHeader, 'box-bgcolor') && !add) {\r\n        domClass.remove(this.pageHeader, 'box-bgcolor');\r\n      } else if (!domClass.contains(this.pageHeader, 'box-bgcolor') && add) {\r\n        domClass.add(this.pageHeader, 'box-bgcolor');\r\n      }\r\n    },\r\n\r\n    startup: function () {\r\n      this.inherited(arguments);\r\n      if (!this.hidePanel && !this.showAllFeatures) {\r\n        this.mapExtentChangedHandler = this.map.on(\"extent-change\", lang.hitch(this, this._mapExtentChange));\r\n        this._mapExtentChange();\r\n      } else if (this.showAllFeatures) {\r\n        this._mapExtentChange();\r\n      }\r\n    },\r\n\r\n    onOpen: function () {\r\n      this.widgetChange = false;\r\n\r\n      if (!this.hidePanel) {\r\n        this._updatePanelHeader();\r\n      } else {\r\n        if (this.appConfig.theme.name !== 'BoxTheme') {\r\n          this._forceClose();\r\n        }\r\n      }\r\n      if (this.appConfig.theme.styles && this.appConfig.theme.styles[0]) {\r\n        this._updateStyleColor(this.appConfig.theme.styles[0]);\r\n      }\r\n\r\n      var visibleSubLayers = [];\r\n      //update the renderer for the layer in the layer list if a new one has been defined\r\n      for (var key in this.layerList) {\r\n        var layerListLayer = this.layerList[key];\r\n        var li = layerListLayer.li;\r\n        var lo = layerListLayer.layerObject;\r\n        if (li && li.orgRenderer) {\r\n          if (lo.setRenderer) {\r\n            lo.setRenderer(li.newRenderer);\r\n          } else if (lo.setLayerDrawingOptions) {\r\n            var optionsArray = [];\r\n            var drawingOptions = new LayerDrawingOptions();\r\n            drawingOptions.renderer = li.newRenderer;\r\n            optionsArray[li.subLayerId] = drawingOptions;\r\n            lo.setLayerDrawingOptions(optionsArray);\r\n          } else {\r\n            console.log(\"Error setting the new renderer...will use the default rendering of the layer\");\r\n          }\r\n          if (typeof (lo.refresh) === 'function') {\r\n            lo.refresh();\r\n          }\r\n        }\r\n\r\n        var _Pl;\r\n        if (lo && lo.layerInfos) {\r\n          _Pl = lo;\r\n        } else if (li && typeof (li.parentLayerID) !== 'undefined') {\r\n          _Pl = this.map.getLayer(li.parentLayerID);\r\n        }\r\n\r\n        var l;\r\n        if (_Pl && _Pl.visibleLayers) {\r\n          var _foundIt = false;\r\n          sub_layers_id_loop:\r\n          for (var ii = 0; ii < visibleSubLayers.length; ii++) {\r\n            var subVizLyrId = visibleSubLayers[ii].id;\r\n            if (subVizLyrId === _Pl.id) {\r\n              _foundIt = true;\r\n              break sub_layers_id_loop;\r\n            }\r\n          }\r\n          if (visibleSubLayers.length === 0 || !_foundIt) {\r\n            visibleSubLayers.push({\r\n              id: _Pl.id,\r\n              layers: _Pl.visibleLayers\r\n            });\r\n          }\r\n          var x = 0;\r\n          subLayerLoop:\r\n          for (x; x < visibleSubLayers.length; x++) {\r\n            var o = visibleSubLayers[x];\r\n            if (o.id === _Pl.id) {\r\n              break subLayerLoop;\r\n            }\r\n          }\r\n          var visLayers = visibleSubLayers[x].layers;\r\n          if (_Pl.layerInfos) {\r\n            //Handle MapService layers\r\n            if (_Pl.layerInfos.length > 0) {\r\n              if (li && typeof (li.subLayerId) !== 'undefined') {\r\n                var inVisLayers = visLayers.indexOf(li.subLayerId) > -1;\r\n                var plVis = layerListLayer.parentLayerVisible;\r\n                var loPlVis = layerListLayer.layerObject.parentLayerVisible;\r\n                if (layerListLayer.type === \"ClusterLayer\" && (inVisLayers || plVis || loPlVis)) {\r\n                  layerListLayer.parentLayerVisible = true;\r\n                  layerListLayer.layerObject.parentLayerVisible = true;\r\n                  layerListLayer.visible = true;\r\n                  if (inVisLayers) {\r\n                    visLayers.splice(visLayers.indexOf(li.subLayerId), 1);\r\n                  }\r\n                } else if (inVisLayers || plVis) {\r\n                  layerListLayer.parentLayerVisible = true;\r\n                  layerListLayer.visible = true;\r\n                  if (visLayers.indexOf(li.subLayerId) === -1) {\r\n                    visLayers.push(li.subLayerId);\r\n                  }\r\n                }else {\r\n                  layerListLayer.parentLayerVisible = false;\r\n                  layerListLayer.visible = false;\r\n                  if (inVisLayers) {\r\n                    visLayers.splice(visLayers.indexOf(li.subLayerId), 1);\r\n                  }\r\n                  if (layerListLayer.type === \"ClusterLayer\") {\r\n                    layerListLayer.layerObject.parentLayerVisible = false;\r\n                    if (this.map.graphicsLayerIds.indexOf(layerListLayer.id) > -1) {\r\n                      l = this.map.getLayer(layerListLayer.id);\r\n                      l.setVisibility(false);\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            }\r\n            visibleSubLayers[x].layers = visLayers;\r\n          }\r\n          this.updatePanelVisibility(layerListLayer, key, layerListLayer);\r\n        } else if (lo) {\r\n          //Handle non MapService layers\r\n          if (layerListLayer.type === \"ClusterLayer\") {\r\n            if (lo._parentLayer) {\r\n              if (this.map.graphicsLayerIds.indexOf(layerListLayer.id) > -1) {\r\n                l = this.map.getLayer(layerListLayer.id);\r\n                if (typeof (layerListLayer.layerObject.parentLayerVisible) === 'undefined') {\r\n                  layerListLayer.parentLayerVisible = lo._parentLayer.visible;\r\n                  layerListLayer.layerObject.parentLayerVisible = lo._parentLayer.visible;\r\n                }\r\n                l.setVisibility(layerListLayer.layerObject.parentLayerVisible);\r\n              }\r\n              if (lo._parentLayer.setVisibility) {\r\n                lo._parentLayer.setVisibility(false);\r\n              }\r\n            }\r\n          }\r\n          this.updatePanelVisibility(lo, key, layerListLayer);\r\n        }\r\n\r\n        if (this.showAllFeatures && this.config.expandList && layerListLayer.legendOpen && !layerListLayer.isLoaded) {\r\n          var visScaleRange = layerListLayer.visScaleRange;\r\n          if(typeof(visScaleRange) !== 'undefined'){\r\n            visScaleRange = this._inVisibleRange(layerListLayer, key);\r\n          }\r\n          if (layerListLayer.visible && visScaleRange) {\r\n            layerListLayer.updateList = true;\r\n          }\r\n        }\r\n      }\r\n\r\n      for (var i = 0; i < visibleSubLayers.length; i++) {\r\n        var parentLayer = this.map.getLayer(visibleSubLayers[i].id);\r\n        if (parentLayer) {\r\n          parentLayer.setVisibleLayers(visibleSubLayers[i].layers);\r\n        }\r\n      }\r\n\r\n      if (!this.hidePanel && !this.showAllFeatures) {\r\n        if (typeof (this.mapExtentChangedHandler) === 'undefined') {\r\n          this.mapExtentChangedHandler = this.map.on(\"extent-change\", lang.hitch(this, this._mapExtentChange));\r\n          this._mapExtentChange();\r\n        }\r\n      }\r\n\r\n      //if refresh is enabled set refereshInterval on any widget source layers with refresh set to true\r\n      //and call setInterval to refresh the static graphics\r\n      if (this.config.refreshEnabled) {\r\n        this.enableRefresh();\r\n      }\r\n\r\n      if (this.map.infoWindow) {\r\n        this.map.infoWindow.highlight = true;\r\n      }\r\n    },\r\n\r\n    updatePanelVisibility: function (lo, key, layerListLayer) {\r\n      if (!this.hidePanel) {\r\n        if (typeof (lo.visible) !== 'undefined') {\r\n          //var visScaleRange = this._inVisibleRange(layerListLayer, key);\r\n          var visScaleRange = layerListLayer.visScaleRange;\r\n          var c = dom.byId(\"recLabel_\" + key);\r\n          if (!lo.visible) {\r\n            if (domClass.contains(\"recIcon_\" + key, \"active\")) {\r\n              domClass.remove(\"recIcon_\" + key, \"active\");\r\n            }\r\n            if (this.config.countEnabled) {\r\n              if (domClass.contains(\"recNum_\" + key, \"recNum\")) {\r\n                domClass.remove(\"recNum_\" + key, \"recNum\");\r\n                domClass.add(\"recNum_\" + key, \"recNumInActive\");\r\n              }\r\n            }\r\n            if (c && c.firstChild) {\r\n              domClass.add(c.firstChild, \"inActive\");\r\n            }\r\n            if (!layerListLayer.listDisabled) {\r\n              if (!domClass.contains(\"exp_\" + key, \"expandInActive\")) {\r\n                domClass.add(\"exp_\" + key, \"expandInActive\");\r\n              }\r\n              layerListLayer.toggleLegend.remove();\r\n            }\r\n            if (domClass.contains(\"rec_\" + key, \"rec\")) {\r\n              domClass.add(\"rec_\" + key, \"recDefault\");\r\n            }\r\n          } else {\r\n            if (!domClass.contains(\"recIcon_\" + key, \"active\")) {\r\n              domClass.add(\"recIcon_\" + key, \"active\");\r\n            }\r\n            if (this.config.countEnabled) {\r\n              if (domClass.contains(\"recNum_\" + key, \"recNumInActive\")) {\r\n                domClass.remove(\"recNum_\" + key, \"recNumInActive\");\r\n                domClass.add(\"recNum_\" + key, \"recNum\");\r\n              }\r\n            }\r\n            if (c && c.firstChild) {\r\n              domClass.remove(c.firstChild, \"inActive\");\r\n            }\r\n            if (!layerListLayer.listDisabled) {\r\n              if (typeof(visScaleRange) === 'undefined' || visScaleRange) {\r\n                if (domClass.contains(\"exp_\" + key, \"expandInActive\")) {\r\n                  domClass.remove(\"exp_\" + key, \"expandInActive\");\r\n                }\r\n              }\r\n            }\r\n            if (domClass.contains(\"rec_\" + key, \"recDefault\")) {\r\n              domClass.remove(\"rec_\" + key, \"recDefault\");\r\n            }\r\n          }\r\n        }\r\n      }\r\n    },\r\n\r\n    enableRefresh: function () {\r\n      //set refreshItereval on all widget source layers that support it\r\n      var layerListLayer = null;\r\n      var checkedTime = false;\r\n      for (var key in this.layerList) {\r\n        var id;\r\n        layerListLayer = this.layerList[key];\r\n        if (layerListLayer.li) {\r\n          id = layerListLayer.li.itemId;\r\n        }\r\n        if (layerListLayer.type !== \"ClusterLayer\") {\r\n          layerListLayer = layerListLayer.layerObject;\r\n        } else {\r\n          for (var i = 0; i < this.layerInfos.length; i++) {\r\n            var l = this.layerInfos[i];\r\n            if (l.layerObject) {\r\n              layerListLayer = l.layerObject;\r\n              break;\r\n            }\r\n          }\r\n        }\r\n        if (!checkedTime && id) {\r\n          this.getItem(id);\r\n          checkedTime = true;\r\n        }\r\n        if (layerListLayer) {\r\n          layerListLayer.refreshInterval = this.config.refreshInterval;\r\n        }\r\n      }\r\n\r\n      var tempVal = this.config.refreshInterval * 60000;\r\n      if (this.refreshInterval === 0 && this.refreshIntervalValue === 0) {\r\n        //set the refresh interval based on the configs interval value\r\n        this.refreshIntervalValue = tempVal;\r\n        this.refreshInterval = setInterval(lang.hitch(this, this.refreshLayers), (this.refreshIntervalValue));\r\n      } else if (this.refreshIntervalValue !== 0 && (this.refreshIntervalValue !== tempVal)) {\r\n        //clear and update the refresh interval if the configs refresh interval has changed\r\n        this.refreshIntervalValue = tempVal;\r\n        clearInterval(this.refreshInterval);\r\n        this.refreshInterval = 0;\r\n        this.refreshInterval = setInterval(lang.hitch(this, this.refreshLayers), (this.refreshIntervalValue));\r\n      }\r\n    },\r\n\r\n    getItem: function (id) {\r\n      var portalUrl = window.portalUrl.substr(-1) !== '/' ? window.portalUrl += '/' : window.portalUrl;\r\n      var url = portalUrl + \"sharing/rest/content/items/\" + id;\r\n      esriRequest({\r\n        url: url,\r\n        content: {\r\n          f: \"json\",\r\n          requestTime: Date.now()\r\n        }\r\n      }).then(lang.hitch(this, function (response) {\r\n        if (response) {\r\n          var itemModified = response.modified;\r\n          var update = true;\r\n          if (this.lastModifiedTime) {\r\n            update = this.lastModifiedTime < itemModified;\r\n          }\r\n          if (this.currentQueryList.indexOf(id) > -1) {\r\n            this.currentQueryList.splice(this.currentQueryList.indexOf(id), 1);\r\n          }\r\n          if (update) {\r\n            this.lastModifiedTime = itemModified;\r\n            this._updatePanelTime(itemModified);\r\n            esriRequest({\r\n              url: url + '/data',\r\n              content: {\r\n                f: \"json\",\r\n                requestTime: Date.now()\r\n              }\r\n            }).then(lang.hitch(this, this._updateItem, id));\r\n          }\r\n        }\r\n      }));\r\n    },\r\n\r\n    _updatePanelTime: function (modifiedTime) {\r\n      if (!this.hidePanel) {\r\n        this.lastUpdated.innerHTML = \"<div></div>\";\r\n        var _d = new Date(modifiedTime);\r\n        var _f = { dateFormat: 'shortDateShortTime' };\r\n        this.lastUpdated.innerHTML = utils.fieldFormatter.getFormattedDate(_d, _f);\r\n      }\r\n    },\r\n\r\n    refreshLayers: function () {\r\n      for (var key in this.layerList) {\r\n        var lyr = this.layerList[key];\r\n        var id;\r\n        if (lyr.li && lyr.li.itemId) {\r\n          id = lyr.li.itemId;\r\n        } else if (lyr.layerObject.itemId) {\r\n          id = lyr.layerObject.itemId;\r\n        }\r\n\r\n        if (id) {\r\n          if (this.currentQueryList.indexOf(id) === -1) {\r\n            this.currentQueryList.push(id);\r\n            this.getItem(id);\r\n          }\r\n        }\r\n      }\r\n    },\r\n\r\n    _updateItem: function (id, response) {\r\n      var featureCollection = response;\r\n      for (var i = 0; i < featureCollection.layers.length; i++) {\r\n        this._updateLayerItem(featureCollection.layers[i], this.lastModifiedTime);\r\n      }\r\n      this.currentQueryList.splice(this.currentQueryList.indexOf(id), 1);\r\n    },\r\n\r\n    //TDOO ensure this functions as expected when filter by map extent id disabled\r\n    _updateLayerItem: function (responseLayer) {\r\n      var layerListLayer;\r\n      var parentLayer;\r\n      var list, fields;\r\n      for (var k in this.layerList) {\r\n        var lyr = this.layerList[k];\r\n        if (lyr.pl && lyr.pl.layerDefinition) {\r\n          if (lyr.pl.layerDefinition.name === responseLayer.layerDefinition.name) {\r\n            layerListLayer = lyr;\r\n            parentLayer = lyr.pl;\r\n            break;\r\n          }\r\n        } else if (lyr.layerObject._parentLayer) {\r\n          if (lyr.layerObject._parentLayer.name === responseLayer.layerDefinition.name) {\r\n            list = typeof (lyr.listDisabled) !== 'undefined' ? lyr.listDisabled : false;\r\n            fields = lyr.li.symbolData.featureDisplayOptions.fields &&\r\n              lyr.li.symbolData.featureDisplayOptions.fields.length > 0;\r\n            if (!list && fields) {\r\n              lyr.isLoaded = false;\r\n            }\r\n            lyr.layerObject.refreshFeatures(responseLayer);\r\n            if (lyr.layerObject) {\r\n              this._loadList(lyr, true);\r\n            }\r\n          }\r\n        } else if (lyr.pl && lyr.pl.name) {\r\n          if (lyr.pl.name === responseLayer.layerDefinition.name) {\r\n            layerListLayer = lyr;\r\n            parentLayer = lyr.pl;\r\n            break;\r\n          }\r\n        }\r\n      }\r\n\r\n      if (responseLayer && layerListLayer && parentLayer && (parentLayer.featureSet || parentLayer.graphics)) {\r\n        var responseFeatureSetFeatures = responseLayer.featureSet.features;\r\n\r\n        var mapFeatureSetFeatures;\r\n        if (parentLayer.featureSet) {\r\n          mapFeatureSetFeatures = parentLayer.featureSet.features;\r\n        } else {\r\n          mapFeatureSetFeatures = [];\r\n          var responseSR = this._getSpatialReference(responseFeatureSetFeatures);\r\n          var mapSR = this._getSpatialReference(parentLayer.graphics);\r\n          array.forEach(parentLayer.graphics, function (gra) {\r\n            var g = gra.geometry;\r\n            var geom = g.rings ? { rings: g.rings } : g.paths ? { paths: g.paths } :\r\n              g.points ? { points: g.points } : (g.x && g.y) ? { x: g.x, y: g.y } : {};\r\n            if (geom !== {}) {\r\n              mapFeatureSetFeatures.push({\r\n                attributes: gra.attributes,\r\n                geometry: lang.mixin({\r\n                  spatialReference: (responseSR && mapSR && responseSR.wkid === mapSR.wkid) ? responseSR : mapSR\r\n                }, geom)\r\n              });\r\n            }\r\n          });\r\n        }\r\n\r\n        if (responseLayer.featureSet.transform) {\r\n          var fs = new FeatureSet(responseLayer.featureSet);\r\n          responseFeatureSetFeatures = fs.features;\r\n        }\r\n\r\n        var shouldUpdate = true;\r\n        //TODO Figure out a better test for larger responses\r\n        if (responseFeatureSetFeatures.length < 10000) {\r\n          shouldUpdate = JSON.stringify(mapFeatureSetFeatures) !== JSON.stringify(responseFeatureSetFeatures);\r\n        }\r\n\r\n        if (shouldUpdate) {\r\n          list = typeof (layerListLayer.listDisabled) !== 'undefined' ? layerListLayer.listDisabled : false;\r\n          fields = layerListLayer.li.symbolData.featureDisplayOptions.fields &&\r\n            layerListLayer.li.symbolData.featureDisplayOptions.fields.length > 0;\r\n          if (!list && fields) {\r\n            layerListLayer.isLoaded = false;\r\n            layerListLayer.requiresReload = true;\r\n          }\r\n          if (list) {\r\n            layerListLayer.li.layerListExtentChanged = true;\r\n          }\r\n          layerListLayer.layerObject.clear();\r\n          var sr = layerListLayer.layerObject.spatialReference;\r\n          for (var j = 0; j < responseFeatureSetFeatures.length; j++) {\r\n            var item = responseFeatureSetFeatures[j];\r\n            if (item.geometry) {\r\n              //check li for renderer also\r\n              var go = this.getGraphicOptions(item, sr);\r\n              var gra = new Graphic(go);\r\n              //removed for https://devtopia.esri.com/WebGIS/arcgis-webappbuilder/issues/11551\r\n              //gra.setSymbol(go.symbol);\r\n              gra.setAttributes(item.attributes);\r\n              if (this._infoTemplate) {\r\n                gra.setInfoTemplate(this._infoTemplate);\r\n              }\r\n              layerListLayer.layerObject.add(gra);\r\n            } else {\r\n              console.log(\"Null geometry skipped\");\r\n            }\r\n          }\r\n          layerListLayer.layerObject.refresh();\r\n          if (parentLayer.featureSet) {\r\n            parentLayer.featureSet.features = responseFeatureSetFeatures;\r\n          }\r\n          this.countFeatures(layerListLayer);\r\n          if (layerListLayer.layerObject && layerListLayer.layerObject.visible) {\r\n            this._loadList(layerListLayer, true);\r\n          }\r\n        }\r\n      }\r\n    },\r\n\r\n    _getSpatialReference: function (features) {\r\n      var sr;\r\n      if (features && features.hasOwnProperty('length') && features.length > 0) {\r\n        var firstFeature = features[0];\r\n        if (firstFeature.geometry && firstFeature.geometry.spatialReference) {\r\n          sr = firstFeature.geometry.spatialReference;\r\n        }\r\n      }\r\n      return sr;\r\n    },\r\n\r\n    getGraphicOptions: function (item, sr) {\r\n      var graphicOptions;\r\n      if (typeof (item.geometry.rings) !== 'undefined') {\r\n        graphicOptions = {\r\n          geometry: {\r\n            rings: item.geometry.rings,\r\n            \"spatialReference\": { \"wkid\": sr.wkid }\r\n          }\r\n        };\r\n      } else if (typeof (item.geometry.paths) !== 'undefined') {\r\n        graphicOptions = {\r\n          geometry: {\r\n            paths: item.geometry.paths,\r\n            \"spatialReference\": { \"wkid\": sr.wkid }\r\n          }\r\n        };\r\n      } else if (typeof (item.geometry.points) !== 'undefined') {\r\n        graphicOptions = {\r\n          geometry: {\r\n            points: item.geometry.points,\r\n            \"spatialReference\": { \"wkid\": sr.wkid }\r\n          }\r\n        };\r\n      } else {\r\n        graphicOptions = {\r\n          geometry: new Point(item.geometry.x, item.geometry.y, item.geometry.spatialReference)\r\n        };\r\n      }\r\n      return graphicOptions;\r\n    },\r\n\r\n    _initWidget: function () {\r\n      this.hidePanel = typeof (this.config.hidePanel) !== 'undefined' ? this.config.hidePanel : false;\r\n      this.showAllFeatures = typeof (this.config.showAllFeatures) !== 'undefined' ? this.config.showAllFeatures : false;\r\n      if (this.map.itemId) {\r\n        LayerInfos.getInstance(this.map, this.map.itemInfo)\r\n          .then(lang.hitch(this, function (operLayerInfos) {\r\n            this.wmLayerInfos = operLayerInfos.getLayerInfoArrayOfWebmap();\r\n            this.layerInfos = operLayerInfos.getLayerInfoArray();\r\n            this.operLayerInfos = operLayerInfos;\r\n            this._updateLayerIDs();\r\n            if (this.config.upgradeFields) {\r\n              this._upgradeFields();\r\n            }\r\n            this._createPanelUI(this.configLayerInfos, operLayerInfos);\r\n            this._addFilterChanged(operLayerInfos);\r\n            this._addVisibleChanged(operLayerInfos);\r\n            this._addZoomChanged(operLayerInfos);\r\n          }));\r\n      }\r\n    },\r\n\r\n    _updateLayerIDs: function () {\r\n      var removeIDs = [];\r\n\r\n      //added to make sure the url we have uses the proxy url\r\n      //issue: https://devtopia.esri.com/WebGIS/arcgis-webappbuilder/issues/11551\r\n      var getUrl = function (configLayer, jimuLayerInfo) {\r\n        return (jimuLayerInfo.layerObject && jimuLayerInfo.layerObject.url) ?\r\n          jimuLayerInfo.layerObject.url : configLayer.url;\r\n      };\r\n\r\n      config_layer_loop:\r\n      for (var i = 0; i < this.configLayerInfos.length; i++) {\r\n        var configLayer = this.configLayerInfos[i];\r\n        var jimuLayerInfo = this.operLayerInfos.getLayerInfoById(configLayer.id);\r\n\r\n        //If we cannot find the jimu layer info based on the stored ID we need to determine it\r\n        if (!jimuLayerInfo) {\r\n          var updated = false;\r\n          wm_layer_loop:\r\n          for (var ii = 0; ii < this.wmLayerInfos.length; ii++) {\r\n            var _opLayer = this.wmLayerInfos[ii];\r\n            var originOpLayer = _opLayer ? _opLayer.originOperLayer : undefined;\r\n\r\n            var urlId = this._compareURL(originOpLayer, configLayer);\r\n            var itemId = this._compareItemID(originOpLayer, configLayer);\r\n            var subId = this._compareSubId(_opLayer, configLayer);\r\n\r\n            var id = urlId ? urlId : itemId ? itemId : subId ? subId : undefined;\r\n            jimuLayerInfo = id ? this.operLayerInfos.getLayerInfoById(id) : jimuLayerInfo;\r\n\r\n            if (jimuLayerInfo) {\r\n              this.configLayerInfos[i].id = jimuLayerInfo.id;\r\n              this.configLayerInfos[i].layer = jimuLayerInfo.id;\r\n              this.configLayerInfos[i].url = getUrl(this.configLayerInfos[i], jimuLayerInfo);\r\n              updated = true;\r\n              break wm_layer_loop;\r\n            }\r\n          }\r\n\r\n          if (!updated && !jimuLayerInfo) {\r\n            removeIDs.push(i);\r\n          }\r\n        } else {\r\n          configLayer.url = getUrl(configLayer, jimuLayerInfo);\r\n        }\r\n      }\r\n\r\n      //This needs to occur largest to smallest\r\n      if (removeIDs.length > 0) {\r\n        //removeIDs.sort((a, b) => (b - a));\r\n        removeIDs.sort(function (a, b) { return b - a; });\r\n        array.forEach(removeIDs, lang.hitch(this, function (id) {\r\n          this.configLayerInfos.splice(id, 1);\r\n        }));\r\n      }\r\n    },\r\n\r\n    _compareSubId: function (opLayer, configLayer) {\r\n      if (opLayer && opLayer.subId && opLayer.subId.indexOf(configLayer.id) > -1) {\r\n        if (opLayer.layerObject) {\r\n          var geomMatch = this._compareGeom(opLayer.layerObject, configLayer);\r\n          var fieldMatch = this._compareFields(opLayer.layerObject, configLayer);\r\n          if (geomMatch && fieldMatch) {\r\n            return opLayer.subId;\r\n          }\r\n        }\r\n      }\r\n      return undefined;\r\n    },\r\n\r\n    _compareItemID: function (originOpLayer, configLayer) {\r\n      if (originOpLayer && originOpLayer.itemId && originOpLayer.itemId === configLayer.itemId) {\r\n        if (originOpLayer.featureCollection && originOpLayer.featureCollection.layers &&\r\n          originOpLayer.featureCollection.layers.hasOwnProperty('length')) {\r\n          var fcLayers = originOpLayer.featureCollection.layers;\r\n          for (var i = 0; i < fcLayers.length; i++) {\r\n            var fcLayer = fcLayers[i];\r\n            if (this._compareGeom(fcLayer, configLayer)){\r\n              if (this._compareFields(fcLayer, configLayer)) {\r\n                return fcLayer.id;\r\n              }\r\n            }\r\n          }\r\n          return undefined;\r\n        } else {\r\n          console.log('error in checking item by itemID');\r\n        }\r\n      }\r\n    },\r\n\r\n    _compareURL: function (originOpLayer, configLayer) {\r\n      return (originOpLayer && originOpLayer.url && configLayer.url && originOpLayer.url === configLayer.url) ?\r\n        originOpLayer.id : undefined;\r\n    },\r\n\r\n    _compareGeom: function (layerObject, configLayer) {\r\n      return (layerObject && layerObject.geometryType && configLayer.geometryType) ?\r\n        layerObject.geometryType === configLayer.geometryType : undefined;\r\n    },\r\n\r\n    _compareFields: function (layerObject, configLayer) {\r\n      var fieldMatch;\r\n      if (layerObject && layerObject.fields && configLayer.fields &&\r\n        layerObject.fields.length === configLayer.fields.length) {\r\n        //test if Names match\r\n        var matchingFields = layerObject.fields.filter(function (f) {\r\n          for (var fn = 0; fn < configLayer.fields.length; fn++) {\r\n            var configField = configLayer.fields[fn];\r\n            if (f.name === configField.name) {\r\n              return f;\r\n            }\r\n          }\r\n        });\r\n        fieldMatch = matchingFields.length === layerObject.fields.length;\r\n      }\r\n      return fieldMatch;\r\n    },\r\n\r\n    //added for backwards compatability\r\n    //could not handle directly in VersionManager as some stored layerInfos\r\n    // do not have a valid infoTemplate saved\r\n    _upgradeFields: function () {\r\n      if (this.configLayerInfos) {\r\n        for (var i = 0; i < this.configLayerInfos.length; i++) {\r\n          var li = this.configLayerInfos[i];\r\n          if (li && li.symbolData && li.symbolData.featureDisplayOptions) {\r\n            var lyrInfo = this.operLayerInfos.getLayerInfoById(li.id);\r\n            if (lyrInfo) {\r\n              var fields = li.symbolData.featureDisplayOptions.fields;\r\n              //At previous releases we would use the first field from the infoTemplate or\r\n              //the first non-OID field from the layer if no fields were selected by the user\r\n              if (typeof (fields) === 'undefined' || (fields.hasOwnProperty('length') && fields.length === 0)) {\r\n                //check layer fields\r\n                var layerObject = (lyrInfo && lyrInfo.layerObject) ? lyrInfo.layerObject : undefined;\r\n                var oidFieldName = (layerObject && layerObject.objectIdField) ? layerObject.objectIdField : undefined;\r\n                var firstLayerFieldName = \"\";\r\n                var firstLayerFieldAlias = \"\";\r\n                var layerFields = li.fields ? li.fields : layerObject ? layerObject.fields : undefined;\r\n                if (layerFields && layerFields.length > 0) {\r\n                  layer_field_loop:\r\n                  for (var _i = 0; _i < layerFields.length; _i++) {\r\n                    var f = layerFields[_i];\r\n                    if (firstLayerFieldName === \"\" && f.type !== \"esriFieldTypeOID\" &&\r\n                      f.type !== \"esriFieldTypeGeometry\" && f.name !== oidFieldName) {\r\n                      firstLayerFieldName = f.name;\r\n                      firstLayerFieldAlias = f.alias || f.name;\r\n                    }\r\n                    if (!oidFieldName) {\r\n                      oidFieldName = f.type === \"esriFieldTypeOID\" ? f.name : oidFieldName;\r\n                    }\r\n                    if (oidFieldName && firstLayerFieldName !== \"\") {\r\n                      break layer_field_loop;\r\n                    }\r\n                  }\r\n                }\r\n\r\n                //check popup fields\r\n                var keyFieldName = \"\";\r\n                var keyFieldAlias = \"\";\r\n                var infoTemplate = li.infoTemplate && li.infoTemplate.info && li.infoTemplate.info.fieldInfos ?\r\n                  li.infoTemplate : lyrInfo ? lyrInfo.getInfoTemplate() : undefined;\r\n                if (!infoTemplate) {\r\n                  var subLayers = lyrInfo.getSubLayers();\r\n                  sub_layers_loop:\r\n                  for (var sli = 0; sli < subLayers.length; sli++) {\r\n                    var sl = subLayers[sli];\r\n                    if (sl.title && sl.layerObject && sl.layerObject.name && sl.title === sl.layerObject.name) {\r\n                      infoTemplate = sl.getInfoTemplate ? sl.getInfoTemplate() : infoTemplate;\r\n                      break sub_layers_loop;\r\n                    }\r\n                  }\r\n                }\r\n                var popupFields = infoTemplate ? infoTemplate.info.fieldInfos : [];\r\n                popup_field_loop:\r\n                for (var j = 0; j < popupFields.length; j++) {\r\n                  var popupField = popupFields[j];\r\n                  if (popupField && popupField.visible) {\r\n                    if (!oidFieldName || oidFieldName !== popupField.fieldName) {\r\n                      keyFieldName = popupField.fieldName;\r\n                      keyFieldAlias = popupField.label || popupField.fieldName;\r\n                      break popup_field_loop;\r\n                    }\r\n                  }\r\n                }\r\n\r\n                //update the config\r\n                this.configLayerInfos[i].symbolData.featureDisplayOptions.fields = [{\r\n                  name: keyFieldName ? keyFieldName : firstLayerFieldName,\r\n                  label: keyFieldName ? keyFieldAlias : firstLayerFieldAlias\r\n                }];\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    },\r\n\r\n    _addFilterChanged: function (layerInfos) {\r\n      if (parseFloat(this.appConfig.wabVersion) >= 2.1) {\r\n        this.own(layerInfos.on('layerInfosFilterChanged', lang.hitch(this, function (changedLayerInfoArray) {\r\n          array.forEach(changedLayerInfoArray, lang.hitch(this, function (layerInfo) {\r\n            var id = layerInfo.id;\r\n            var clId = layerInfo.id + this.UNIQUE_APPEND_VAL_CL;\r\n            if (this.layerList.hasOwnProperty(id)) {\r\n              this.layerList[id].filter = layerInfo.getFilter();\r\n            } else if (this.layerList.hasOwnProperty(clId)) {\r\n              this.layerList[clId].layerObject.filter = layerInfo.getFilter();\r\n              this.layerList[clId].layerObject._initFeatures();\r\n            }\r\n          }));\r\n        })));\r\n      }\r\n    },\r\n\r\n    _updateVisibility: function (layerInfo) {\r\n      if (layerInfo) {\r\n        var id = layerInfo.id;\r\n        var vis = layerInfo.isShowInMap();\r\n        if (this.layerList.hasOwnProperty(id)) {\r\n          var lyr = this.layerList[id];\r\n          if (id === lyr.li.id && lyr.visible !== vis) {\r\n            this._toggleLayerUI(lyr.li, vis);\r\n          } else if (id === lyr.id && lyr.visible !== vis) {\r\n            this._toggleLayerUI(layerInfo, vis);\r\n          }\r\n        }\r\n      }\r\n    },\r\n\r\n    _addVisibleChanged: function (layerInfos) {\r\n      this.own(layerInfos.on('layerInfosIsVisibleChanged', lang.hitch(this, function (changedLayerInfos) {\r\n        array.forEach(changedLayerInfos, function (layerInfo) {\r\n          this._updateVisibility(layerInfo);\r\n        }, this);\r\n      })));\r\n    },\r\n\r\n    _addZoomChanged: function (layerInfos) {\r\n      this.own(on(this.map, 'zoom-end', lang.hitch(this, function () {\r\n        layerInfos.traversal(lang.hitch(this, function (layerInfo) {\r\n          this._updateVisibility(layerInfo);\r\n        }));\r\n      })));\r\n    },\r\n\r\n    _updatePanelHeader: function () {\r\n      var panelTitle;\r\n      var w = this.map.width;\r\n      if (this.config.displayPanelIcon && w > 750) {\r\n        if (this.pageHeader) {\r\n          html.removeClass(this.pageHeader, \"pageHeaderNoIcon\");\r\n          html.removeClass(this.pageHeader, \"pageHeaderNoIconRefresh\");\r\n\r\n          if (this.config.refreshEnabled) {\r\n            if (this.config.mainPanelText !== \"\") {\r\n              html.addClass(this.pageHeader, \"pageHeaderRefresh\");\r\n            } else {\r\n              html.addClass(this.pageHeader, \"pageHeaderRefreshNoText\");\r\n            }\r\n          } else {\r\n            html.addClass(this.pageHeader, \"pageHeader\");\r\n          }\r\n        }\r\n\r\n        if (this.pageBody) {\r\n          html.removeClass(this.pageBody, \"pageBodyNoIcon\");\r\n          html.removeClass(this.pageBody, \"pageBodyNoIconRefresh\");\r\n          if (this.config.refreshEnabled) {\r\n            if (this.config.mainPanelText !== \"\") {\r\n              html.addClass(this.pageBody, \"pageBodyRefresh\");\r\n            } else {\r\n              html.addClass(this.pageBody, \"pageBodyRefreshNoText\");\r\n            }\r\n          } else {\r\n            html.addClass(this.pageBody, \"pageBody\");\r\n          }\r\n        }\r\n\r\n        if (this.pageTitle) {\r\n          html.addClass(this.pageTitle, \"pageTitleWidth\");\r\n          if (this.config.refreshEnabled) {\r\n            html.removeClass(this.pageTitle, \"pageTitle\");\r\n            html.removeClass(this.pageTitle, \"pageTitleRefresh-tab\");\r\n            html.removeClass(this.pageTitle, \"pageTitleRefresh\");\r\n            html.addClass(this.pageTitle, this.useDarkText ? \"pageTitleRefresh-tab\" : \"pageTitleRefresh\");\r\n          } else {\r\n            html.removeClass(this.pageTitle, \"pageTitleRefresh\");\r\n            html.removeClass(this.pageTitle, \"pageTitleRefresh-tab\");\r\n            html.addClass(this.pageTitle, \"pageTitle\");\r\n          }\r\n        }\r\n\r\n        panelTitle = this.config.mainPanelText;\r\n        if (typeof (panelTitle) === 'undefined') {\r\n          panelTitle = \"\";\r\n        }\r\n        this.pageTitle.innerHTML = panelTitle;\r\n        this.panelMainIcon.innerHTML = this.config.mainPanelIcon;\r\n      } else if (!this.config.displayPanelIcon && !this.config.refreshEnabled) {\r\n        if (this.pageHeader) {\r\n          html.removeClass(this.pageHeader, \"pageHeader\");\r\n          html.removeClass(this.pageHeader, \"pageHeaderNoIconRefresh\");\r\n          html.addClass(this.pageHeader, \"pageHeaderNoIcon\");\r\n        }\r\n\r\n        if (this.pageBody) {\r\n          html.removeClass(this.pageBody, \"pageBody\");\r\n          html.removeClass(this.pageBody, \"pageBodyNoIconRefresh\");\r\n          html.addClass(this.pageBody, \"pageBodyNoIcon\");\r\n        }\r\n        this.pageTitle.innerHTML = \"<div></div>\";\r\n        this.panelMainIcon.innerHTML = \"<div></div>\";\r\n      } else if (!this.config.displayPanelIcon && this.config.refreshEnabled) {\r\n        if (this.pageHeader) {\r\n          html.removeClass(this.pageHeader, \"pageHeader\");\r\n          html.removeClass(this.pageHeader, \"pageHeaderNoIcon\");\r\n          html.addClass(this.pageHeader, \"pageHeaderNoIconRefresh\");\r\n        }\r\n\r\n        if (this.pageBody) {\r\n          html.removeClass(this.pageBody, \"pageBody\");\r\n          html.removeClass(this.pageBody, \"pageBodyNoIcon\");\r\n          html.addClass(this.pageBody, \"pageBodyNoIconRefresh\");\r\n        }\r\n\r\n        if (this.pageTitle) {\r\n          html.removeClass(this.pageTitle, \"pageTitleWidth\");\r\n        }\r\n        this.pageTitle.innerHTML = \"<div></div>\";\r\n        this.panelMainIcon.innerHTML = \"<div></div>\";\r\n      } else if (this.config.displayPanelIcon && w <= 750 && this.config.refreshEnabled) {\r\n        if (this.pageHeader) {\r\n          html.removeClass(this.pageHeader, \"pageHeaderNoIcon\");\r\n          html.removeClass(this.pageHeader, \"pageHeaderNoIconRefresh\");\r\n          html.removeClass(this.pageHeader, \"pageHeader\");\r\n          if (this.config.mainPanelText !== \"\") {\r\n            html.addClass(this.pageHeader, \"pageHeaderRefresh\");\r\n          } else {\r\n            html.addClass(this.pageHeader, \"pageHeaderRefreshNoText\");\r\n          }\r\n        }\r\n\r\n        if (this.pageBody) {\r\n          html.removeClass(this.pageBody, \"pageBodyNoIcon\");\r\n          html.removeClass(this.pageBody, \"pageBodyNoIconRefresh\");\r\n          html.removeClass(this.pageBody, \"pageBody\");\r\n          if (this.config.mainPanelText !== \"\") {\r\n            html.addClass(this.pageBody, \"pageBodyRefresh\");\r\n          } else {\r\n            html.addClass(this.pageBody, \"pageBodyRefreshNoText\");\r\n          }\r\n        }\r\n\r\n        if (this.pageTitle) {\r\n          html.addClass(this.pageTitle, \"pageTitleWidth\");\r\n        }\r\n\r\n        panelTitle = this.config.mainPanelText;\r\n        if (typeof (panelTitle) === 'undefined') {\r\n          panelTitle = \"\";\r\n        }\r\n        this.pageTitle.innerHTML = panelTitle;\r\n      }\r\n    },\r\n\r\n    _createPanelUI: function (configLayerInfos, jimuLayerInfos) {\r\n      this.numClusterLayers = 0;\r\n\r\n      if (!this.hidePanel) {\r\n        this._updatePanelHeader();\r\n        this._updateUI(null);\r\n        this._clearChildNodes(this.pageMain);\r\n        this.updateEnd = [];\r\n      }\r\n\r\n      for (var i = 0; i < configLayerInfos.length; i++) {\r\n        var lyrInfo = configLayerInfos[i];\r\n        if (lyrInfo.symbolData.clusterType === 'ThemeCluster') {\r\n          this.updateThemeClusterSymbol(lyrInfo, i);\r\n        }\r\n\r\n        var jimuLayerInfo = jimuLayerInfos.getLayerInfoById(lyrInfo.id);\r\n        if (jimuLayerInfo) {\r\n          jimuLayerInfo.getLayerType().then(lang.hitch(this, function (layerType) {\r\n            jimuLayerInfo.getLayerObject().then(lang.hitch(this, function (layerObject) {\r\n              this.updateLayerList(layerObject, lyrInfo, layerType, jimuLayerInfo);\r\n            }));\r\n          }));\r\n        }\r\n      }\r\n\r\n      if (!this.hidePanel) {\r\n        for (var k in this.layerList) {\r\n          var lyr = this.layerList[k];\r\n          if (lyr.type !== \"ClusterLayer\") {\r\n            if (lyr && lyr.layerObject) {\r\n              if (lyr.layerObject.hasOwnProperty('refreshInterval') && lyr.layerObject.refreshInterval > 0) {\r\n                this.updateEnd.push(this.own(on(lyr.layerObject, \"update-end\", lang.hitch(this, this._updateEnd))));\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n      this.addMapLayers();\r\n    },\r\n\r\n    _updateEnd: function (results) {\r\n      var lid = this.layerList.hasOwnProperty(results.target.id) ? results.target.id :\r\n        this.layerList.hasOwnProperty(results.target.id + \"_CL\") ? results.target.id + \"_CL\" : \"\";\r\n\r\n      //For map service with sub layers...the results ID is for the parent layer\r\n      if (lid === \"\") {\r\n        for (var i in this.layerList) {\r\n          var l = this.layerList[i];\r\n          if (l && l.layerObject && l.layerObject.id === results.target.id) {\r\n            lid = l.li.id;\r\n            break;\r\n          }\r\n        }\r\n      }\r\n      if (this.layerList.hasOwnProperty(lid)) {\r\n        var lyr = this.layerList[lid];\r\n        lyr.isLoaded = false;\r\n        lyr.updating = false;\r\n        lyr.requiresReload = true;\r\n        if (lyr) {\r\n          if (lyr.legendOpen) {\r\n            this._loadList(lyr, this.config.countEnabled);\r\n          } else if (this.config.countEnabled) {\r\n            this.countFeatures(lyr);\r\n          }\r\n        }\r\n      }\r\n    },\r\n\r\n    updateThemeClusterSymbol: function(lyrInfo, i){\r\n      var sd = lyrInfo.symbolData;\r\n      if (this.appConfig.theme.styles && this.appConfig.theme.styles[0]) {\r\n        if (typeof (this._styleColor) === 'undefined') {\r\n          this._updateStyleColor(this.appConfig.theme.styles[0]);\r\n        }\r\n      }\r\n      if (this._styleColor) {\r\n        var _rgb = dojoColor.fromHex(this._styleColor);\r\n        var x = i + 1;\r\n        var xx = x > 0 ? x * 30 : 30;\r\n        var evenOdd = x % 2 === 0;\r\n        var r = _rgb.r;\r\n        var g = _rgb.g;\r\n        var b = _rgb.b;\r\n\r\n        var rr = r - xx;\r\n        if (evenOdd) {\r\n          if (rr > 255) {\r\n            rr = rr - 255;\r\n          }\r\n          else if (rr < 0) {\r\n            rr = rr + 255;\r\n          }\r\n        }\r\n\r\n        var bb = b - xx;\r\n        if (x % 3 === 0) {\r\n          if (evenOdd) {\r\n            if (bb > 255) {\r\n              bb = bb - 255;\r\n            }\r\n            else if (bb < 0) {\r\n              bb = bb + 255;\r\n            }\r\n          }\r\n        }\r\n\r\n        var gg = g - xx;\r\n        if (x % 5 === 0) {\r\n          if (evenOdd) {\r\n            if (gg > 255) {\r\n              gg = gg - 255;\r\n            }\r\n            else if (gg < 0) {\r\n              gg = gg + 255;\r\n            }\r\n          }\r\n        }\r\n        sd.clusterType = 'CustomCluster';\r\n        sd.clusterSymbol = {\r\n          color: [rr, gg, bb, 1],\r\n          outline: {\r\n            color: [0, 0, 0, 0],\r\n            width: 0,\r\n            type: \"esriSLS\",\r\n            style: \"esriSLSNull\"\r\n          },\r\n          type: \"esriSFS\",\r\n          style: \"esriSFSSolid\"\r\n        };\r\n      }\r\n    },\r\n\r\n    removeOldClusterLayers: function (lInfos) {\r\n      //check if the widget was previously configured\r\n      // with a layer that it no longer consumes...if so remove it\r\n      var deleteLayers = [];\r\n      for (var id in this.layerList) {\r\n        var l = this.layerList[id];\r\n        if (l.type === \"ClusterLayer\") {\r\n          layer_info_loop:\r\n          for (var i = 0; i < lInfos.length; i++) {\r\n            var lo = lInfos[i];\r\n            var potentialNewClusterID = lo.id + this.UNIQUE_APPEND_VAL_CL;\r\n            if (potentialNewClusterID === id) {\r\n              if (lo.symbolData && !lo.symbolData.clusteringEnabled) {\r\n                deleteLayers.push(id);\r\n              }\r\n              break layer_info_loop;\r\n            }\r\n          }\r\n        }\r\n      }\r\n      if (deleteLayers.length > 0) {\r\n        for (var dl in deleteLayers) {\r\n          if (this.layerList.hasOwnProperty(deleteLayers[dl])) {\r\n            if (this.map.graphicsLayerIds.indexOf(deleteLayers[dl]) > -1) {\r\n              var _dl = this.layerList[deleteLayers[dl]];\r\n              if (_dl && _dl.li) {\r\n                var jimuLayerInfo;\r\n                if (_dl.li.parentLayerID) {\r\n                  jimuLayerInfo = this.operLayerInfos.getLayerInfoById(_dl.li.parentLayerID);\r\n                }\r\n                if (!jimuLayerInfo && _dl.li.layer) {\r\n                  jimuLayerInfo = this.operLayerInfos.getLayerInfoById(_dl.li.layer);\r\n                }\r\n                if (jimuLayerInfo && _dl.hasOwnProperty('parentLayerVisible')) {\r\n                  jimuLayerInfo.setTopLayerVisible(_dl.parentLayerVisible);\r\n                }\r\n              }\r\n              this.map.removeLayer(this.layerList[deleteLayers[dl]].layerObject);\r\n            }\r\n            this.layerList[deleteLayers[dl]].layerObject.destroy();\r\n            delete this.layerList[deleteLayers[dl]];\r\n          }\r\n        }\r\n      }\r\n    },\r\n\r\n    addMapLayers: function () {\r\n      var ids = Object.keys(this.layerList).reverse();\r\n      for (var i = 0; i < ids.length; i++) {\r\n        var id = ids[i];\r\n        var l = this.layerList[id];\r\n        if (l.type && l.type === \"ClusterLayer\") {\r\n          if (this.map.graphicsLayerIds.indexOf(id) === -1) {\r\n            this.map.addLayer(l.layerObject);\r\n          }\r\n        }\r\n      }\r\n    },\r\n\r\n    updateLayerList: function (lyr, lyrInfo, lyrType, jimuLayerInfo) {\r\n      var l, ll  = null;\r\n      var type, id, layerObject, pl;\r\n\r\n      jimuLayerInfo = jimuLayerInfo || this.operLayerInfos.getLayerInfoById(lyr.id);\r\n\r\n      var selfType = this._checkSelfType(jimuLayerInfo, lyrInfo, lyrType, lyr);\r\n      var listDisabled = this._checkListDisabled(lyrInfo);\r\n\r\n      //Handle cluster layers\r\n      if (lyrInfo.symbolData.clusteringEnabled) {\r\n        l = this._getClusterLayer(lyrInfo, lyr, jimuLayerInfo, lyrType);\r\n        type = \"ClusterLayer\";\r\n        layerObject = l;\r\n        id = l.id;\r\n        if (!this.hidePanel) {\r\n          this.own(on(l, \"update-end\", lang.hitch(this, function () {\r\n            this._loadList(this.layerList[l.id], true);\r\n          })));\r\n        }\r\n        this.numClusterLayers += 1;\r\n      } else {\r\n        if (lyr.layerType === \"ArcGISStreamLayer\") {\r\n          type = \"StreamLayer\";\r\n          id = lyr.layerObject.id;\r\n          layerObject = lyr.layerObject;\r\n          pl = lyr;\r\n        } else {\r\n          id = lyrType === \"FeatureLayer\" ? lyrInfo.id : lyr.id;\r\n          var parentLayerInfo = this.operLayerInfos.getLayerInfoById(lyrInfo.parentLayerID) || lyr.parentLayerInfo;\r\n          if (parentLayerInfo) {\r\n            if (parentLayerInfo.layerObject) {\r\n              ll = parentLayerInfo.layerObject;\r\n              type = ll.type;\r\n              if (parentLayerInfo.originOperLayer && parentLayerInfo.originOperLayer.featureCollection) {\r\n                var layers = parentLayerInfo.originOperLayer.featureCollection.layers;\r\n                if (layers) {\r\n                  for (var j = 0; j < layers.length; j++) {\r\n                    var _lyr = layers[j];\r\n                    if (_lyr.id === id) {\r\n                      pl = _lyr;\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            }\r\n          }\r\n          l = lyr.layerObject ? lyr.layerObject : lyr;\r\n          type = lyrType;\r\n          layerObject = (ll && !ll.empty) ? ll : l ? l : lyr;\r\n          if (selfType === 'geo_rss' && layerObject && layerObject.getFeatureLayers) {\r\n            var featureLayers = layerObject.getFeatureLayers();\r\n            for (var i = 0; i < featureLayers.length; i++) {\r\n              var fl = featureLayers[i];\r\n              if (fl.id === lyrInfo.id) {\r\n                layerObject = fl;\r\n              }\r\n            }\r\n          }\r\n          pl = pl ? pl : lyr;\r\n        }\r\n      }\r\n\r\n      this.layerList[id] = {\r\n        type: type,\r\n        layerObject: layerObject,\r\n        pl: pl,\r\n        id: id,\r\n        visible: jimuLayerInfo && jimuLayerInfo.isShowInMap ? jimuLayerInfo.isShowInMap() : true,\r\n        li: lyrInfo,\r\n        filter: jimuLayerInfo ? jimuLayerInfo.getFilter() : \"1=1\",\r\n        infoTemplate: jimuLayerInfo.getInfoTemplate() || lyrInfo.infoTemplate,\r\n        selfType: selfType,\r\n        listDisabled: listDisabled,\r\n        showAllFeatures: this.showAllFeatures\r\n      };\r\n\r\n      if (lyr.layerType !== \"ArcGISStreamLayer\") {\r\n        this.updateRenderer(id);\r\n      }\r\n\r\n      if (!this.hidePanel) {\r\n        this._addPanelItem(ll ? ll : l ? l : lyr, lyrInfo, listDisabled, jimuLayerInfo);\r\n      }\r\n    },\r\n\r\n    _checkListDisabled: function (lyrInfo) {\r\n      return lyrInfo.symbolData.featureDisplayOptions.listDisabled ?\r\n        lyrInfo.symbolData.featureDisplayOptions.listDisabled : lyrInfo.symbolData.featureDisplayOptions.fields ?\r\n          lyrInfo.symbolData.featureDisplayOptions.fields.length === 0 : true;\r\n    },\r\n\r\n    _checkSelfType: function (jimuLayerInfo, lyrInfo, lyrType, lyr) {\r\n      var _lo = (lyrInfo.layerObject && !lyrInfo.layerObject.empty) ? lyrInfo.layerObject : lyr;\r\n      var originOpLayer = _lo && _lo.originOperLayer ? _lo.originOperLayer : lyr;\r\n\r\n      var selfType = (jimuLayerInfo.originOperLayer && jimuLayerInfo.originOperLayer.selfType) ?\r\n        jimuLayerInfo.originOperLayer.selfType : (originOpLayer && originOpLayer.selfType) ?\r\n          originOpLayer.selfType : '';\r\n\r\n      selfType = (selfType && selfType !== '') ? selfType : (originOpLayer && originOpLayer.layerType &&\r\n        originOpLayer.layerType === \"CSV\") ? \"collection\" : lyrType === \"Feature Collection\" ? \"collection\" : '';\r\n      if (!selfType && lyrType && lyrType === \"KML\") {\r\n        selfType = \"kml\";\r\n      }\r\n      return selfType;\r\n    },\r\n\r\n    updateRenderer: function (id) {\r\n      var l = this.layerList[id];\r\n      if (l.li.symbolData.symbolType !== 'LayerSymbol') {\r\n        if (typeof (l.li.orgRenderer) === 'undefined') {\r\n          if (l.layerObject.renderer) {\r\n            l.li.orgRenderer = l.layerObject.renderer;\r\n          } else {\r\n            l.li.orgRenderer = l.li.renderer;\r\n          }\r\n        }\r\n        var renderer = new SimpleRenderer(jsonUtils.fromJson(l.li.symbolData.symbol));\r\n        l.li.newRenderer = renderer;\r\n        if (l.layerObject.setRenderer) {\r\n          l.layerObject.setRenderer(renderer);\r\n        } else if (l.layerObject.setLayerDrawingOptions) {\r\n          var optionsArray = [];\r\n          var drawingOptions = new LayerDrawingOptions();\r\n          drawingOptions.renderer = renderer;\r\n          optionsArray[l.li.subLayerId] = drawingOptions;\r\n          l.layerObject.setLayerDrawingOptions(optionsArray);\r\n        } else {\r\n          console.log(\"Error setting the new renderer...will use the default rendering of the layer\");\r\n        }\r\n\r\n        if (typeof (l.layerObject.refresh) === 'function') {\r\n          l.layerObject.refresh();\r\n        }\r\n      }\r\n    },\r\n\r\n    _onRecNodeMouseover: function (rec) {\r\n      domClass.add(rec, this.isDartTheme ? \"layer-row-mouseover-dart\" :\r\n        (this.isDashboardTheme && !this.isLightTheme) ? \"layer-row-mouseover-dashboard\" : \"layer-row-mouseover\");\r\n    },\r\n\r\n    _onRecNodeMouseout: function (rec) {\r\n      domClass.remove(rec, this.isDartTheme ? \"layer-row-mouseover-dart\" :\r\n        (this.isDashboardTheme && !this.isLightTheme) ? \"layer-row-mouseover-dashboard\" : \"layer-row-mouseover\");\r\n    },\r\n\r\n    _addPanelItem: function (layer, lyrInfo, listDisabled, jimuLayerInfo) {\r\n      var potentialNewID = lyrInfo.id + this.UNIQUE_APPEND_VAL_CL;\r\n      var id = lyrInfo.id in this.layerList ? lyrInfo.id : potentialNewID in this.layerList ? potentialNewID : '';\r\n      var lyr = this.layerList[id];\r\n      if (lyr) {\r\n        var lyrType = lyr.type;\r\n        var cssAry;\r\n        if (this.isDashboardTheme) {\r\n          cssAry = ['rec', 'expand', 'expandDown-dashboard', 'solidBorder'];\r\n        } else if (this.isDartTheme) {\r\n          cssAry = ['rec-dart', 'expand-dart', 'expandDown-dart', 'solidBorder-dart'];\r\n        } else {\r\n          cssAry = ['rec', 'expand', 'expandDown', 'solidBorder'];\r\n        }\r\n        var rec = domConstruct.create(\"div\", {\r\n          'class': cssAry[0] + \" \" + cssAry[3],\r\n          id: 'rec_' + id\r\n        }, this.pageMain);\r\n\r\n        var expandClass;\r\n        if (!listDisabled) {\r\n          this.own(on(rec, 'mouseover', lang.hitch(this, this._onRecNodeMouseover, rec)));\r\n          this.own(on(rec,  'mouseout', lang.hitch(this, this._onRecNodeMouseout, rec)));\r\n          expandClass = cssAry[1] + \" \" + cssAry[2];\r\n          if (jimuLayerInfo && jimuLayerInfo.isInScale) {\r\n            expandClass += jimuLayerInfo.isInScale() ? \"\" : \" expandInActive\";\r\n          }\r\n        } else {\r\n          html.setStyle(rec, \"cursor\", \"default\");\r\n          expandClass = 'expand-empty';\r\n        }\r\n        domConstruct.create(\"div\", {\r\n          'class': expandClass,\r\n          id: \"exp_\" + id\r\n        }, rec);\r\n\r\n        var recIcon = domConstruct.create(\"div\", {\r\n          'class': \"recIcon active\",\r\n          id: \"recIcon_\" + id\r\n        }, rec);\r\n\r\n        if (lyrInfo.panelImageData && lyrInfo.panelImageData.toString().indexOf('<img') > -1) {\r\n          var img = document.createElement('div');\r\n          img.innerHTML = lyrInfo.panelImageData;\r\n          var icon = new PictureMarkerSymbol(img.children[0].src, 26, 26);\r\n          lyrInfo.panelImageData = this._createImageDataDiv(icon, 44, 44, undefined, true).innerHTML;\r\n        }\r\n        recIcon.innerHTML = lyrInfo.panelImageData;\r\n        domStyle.set(recIcon.firstChild, \"border-radius\", \"41px\");\r\n\r\n        var recLabel;\r\n        var recNum;\r\n        if (this.config.countEnabled) {\r\n          recLabel = domConstruct.create(\"div\", {\r\n            'class': \"recLabel\",\r\n            id: \"recLabel_\" + id,\r\n            innerHTML: \"<p>\" + lyrInfo.label + \"</p>\"\r\n          }, rec);\r\n          html.setStyle(recLabel, \"top\", \"20px\");\r\n          recNum = domConstruct.create(\"div\", {\r\n            'class': \"recNum\",\r\n            id: \"recNum_\" + id,\r\n            innerHTML: \"\"\r\n          }, rec);\r\n        } else {\r\n          recLabel = domConstruct.create(\"div\", {\r\n            'class': \"recLabelNoCount\",\r\n            id: \"recLabel_\" + id,\r\n            innerHTML: \"<p>\" + lyrInfo.label + \"</p>\"\r\n          }, rec);\r\n        }\r\n\r\n        if (lyrType === \"ClusterLayer\") {\r\n          layer.node = recNum;\r\n          if (!listDisabled) {\r\n            this._addLegend(id, lyr);\r\n          }\r\n          layer._updateNode(layer.nodeCount);\r\n        } else if (lyrType === \"StreamLayer\") {\r\n          lyr.node = recNum;\r\n          this.countFeatures(lyr);\r\n          if (!listDisabled) {\r\n            this._addLegend(id, lyr);\r\n          }\r\n        } else {\r\n          lyr.node = recNum;\r\n          this._addLegend(id, lyr);\r\n        }\r\n\r\n        on(recIcon, \"click\", lang.hitch(this, this._toggleLayerVisibility, lyr));\r\n\r\n        if (!listDisabled) {\r\n          lyr.toggleLegend = on(rec, \"click\", lang.hitch(this, this._toggleLegend, lyr));\r\n        }\r\n      }\r\n    },\r\n\r\n    _addLegend: function (id, layerListLayer) {\r\n      layerListLayer.legendOpen = this.row === null && this.config.expandList;\r\n      var _class = layerListLayer.legendOpen ? \"legendOn\" : \"legendOff\";\r\n      layerListLayer.legendNode = domConstruct.create(\"div\", {\r\n        \"class\": \"legendLayer \" + _class,\r\n        \"id\": \"legend_\" + id\r\n      }, this.pageMain);\r\n      if (layerListLayer.type === 'ClusterLayer') {\r\n        layerListLayer.layerObject.legendNode = layerListLayer.legendNode;\r\n      }\r\n      this.row = 'firstRowExpanded';\r\n    },\r\n\r\n    _getListFields: function (lyr) {\r\n      var popupFields = [];\r\n      var infoTemp = this._getInfoTemplate(lyr);\r\n\r\n      var fieldInfos = (infoTemp && infoTemp.info && infoTemp.info.fieldInfos) ? infoTemp.info.fieldInfos : [];\r\n      array.forEach(fieldInfos, function (fieldInfo) {\r\n        if (fieldInfo.visible) {\r\n          popupFields.push(fieldInfo.fieldName);\r\n        }\r\n      });\r\n\r\n      var displayOptions = (lyr.li.symbolData && lyr.li.symbolData.featureDisplayOptions) ?\r\n        lyr.li.symbolData.featureDisplayOptions : {};\r\n      var fields = displayOptions.fields || [];\r\n      array.forEach(fields, function (field) {\r\n        if (popupFields.indexOf(field.name) === -1) {\r\n          popupFields.push(field.name);\r\n        }\r\n      });\r\n      if (displayOptions.groupField) {\r\n        if (popupFields.indexOf(displayOptions.groupField.name) === -1) {\r\n          popupFields.push(displayOptions.groupField.name);\r\n        }\r\n      }\r\n\r\n      if (popupFields.length === 0 || typeof (infoTemp) === 'undefined') {\r\n        popupFields = ['*'];\r\n      }\r\n\r\n      if (popupFields[0] !== '*') {\r\n        if (lyr.layerObject && lyr.layerObject.objectIdField) {\r\n          if (popupFields.indexOf(lyr.layerObject.objectIdField) === -1) {\r\n            popupFields.push(lyr.layerObject.objectIdField);\r\n          }\r\n        }\r\n      }\r\n      return popupFields;\r\n    },\r\n\r\n    _loadList: function (lyr, updateCount) {\r\n      if (!this.hidePanel) {\r\n        var id = lyr.layerObject.id in this.layerList ? lyr.layerObject.id : lyr.li.id;\r\n        if (updateCount) {\r\n          this._addSearching(id);\r\n        }\r\n\r\n        var popupFields = this._getListFields(lyr);\r\n        if (lyr.type === \"ClusterLayer\") {\r\n          if (lyr.li.layerListExtentChanged) {\r\n            lyr.layerObject.clusterFeatures();\r\n            lyr.li.layerListExtentChanged = false;\r\n          }\r\n          var features = [];\r\n          if (lyr.layerObject.clusterGraphics || lyr.layerObject._features) {\r\n            if (this.showAllFeatures) {\r\n              features = lyr.layerObject._features;\r\n            } else {\r\n              var clusterGraphics = lyr.layerObject.clusterGraphics;\r\n              for (var z = 0; z < clusterGraphics.length; z++) {\r\n                var clusterGraphic = clusterGraphics[z];\r\n                if (clusterGraphic.graphics && clusterGraphic.graphics.length > 0) {\r\n                  for (var f = 0; f < clusterGraphic.graphics.length; f++) {\r\n                    var g = clusterGraphic.graphics[f];\r\n                    features.push(g);\r\n                  }\r\n                }\r\n              }\r\n            }\r\n            setTimeout(lang.hitch(this, function () {\r\n              this._updateList(features, lyr.legendNode, lyr.layerObject.node, popupFields, updateCount, lyr);\r\n            }), 100);\r\n          } else {\r\n            this._removeSearching(id, lyr.legendNode ? !domClass.contains(lyr.legendNode, 'legendOff') : true);\r\n          }\r\n        } else {\r\n          this.getFeatures(lyr, popupFields, updateCount);\r\n          return;\r\n        }\r\n      }\r\n    },\r\n\r\n    _addSearching: function (id) {\r\n      var disabled = this.layerList[id].listDisabled;\r\n      var eD = disabled ? 'expand-empty' : this.isDartTheme ? 'expandDown-dart' :\r\n        (this.isDashboardTheme && !this.isLightTheme) ? 'expandDown-dashboard' : 'expandDown';\r\n      var eU = disabled ? 'expand-empty' : this.isDartTheme ? 'expandUp-dart' :\r\n        (this.isDashboardTheme && !this.isLightTheme) ? 'expandUp-dashboard' : 'expandUp';\r\n      var eS = disabled ? \"expandSearching-empty\" : \"expandSearching\";\r\n      if (domClass.contains(\"exp_\" + id, eD)) {\r\n        domClass.remove(\"exp_\" + id, eD);\r\n        domClass.add(\"exp_\" + id, eS);\r\n      }\r\n      if (domClass.contains(\"exp_\" + id, eU)) {\r\n        domClass.remove(\"exp_\" + id, eU);\r\n        domClass.add(\"exp_\" + id, eS);\r\n      }\r\n    },\r\n\r\n    _removeSearching: function (id, legendOpen) {\r\n      var disabled = this.layerList[id].listDisabled;\r\n      var eD = disabled ? 'expand-empty' : this.isDartTheme ? 'expandDown-dart' :\r\n        (this.isDashboardTheme && !this.isLightTheme) ? 'expandDown-dashboard' : 'expandDown';\r\n      var eU = disabled ? 'expand-empty' : this.isDartTheme ? 'expandUp-dart' :\r\n        (this.isDashboardTheme && !this.isLightTheme) ? 'expandUp-dashboard' : 'expandUp';\r\n      var eS = disabled ? \"expandSearching-empty\" : \"expandSearching\";\r\n      if (domClass.contains(\"exp_\" + id, eS)) {\r\n        domClass.remove(\"exp_\" + id, eS);\r\n        domClass.add(\"exp_\" + id, legendOpen ? eU : eD);\r\n      }\r\n    },\r\n\r\n    _getClusterLayer: function (lyrInfo, layer, jimuLayerInfo, lyrType) {\r\n      var lyr = layer.layerObject ? layer.layerObject : layer;\r\n      var infoTemplate = lyrInfo.infoTemplate;\r\n      var originOperLayer = lyr && lyr.originOperLayer ? lyr.originOperLayer : layer.parentLayerInfo ?\r\n        layer.parentLayerInfo : jimuLayerInfo ? jimuLayerInfo.originOperLayer : undefined;\r\n      var clusterLayer = null;\r\n      var n;\r\n      var potentialNewID = lyrInfo.id + this.UNIQUE_APPEND_VAL_CL;\r\n      var configChange = true;\r\n      if (this.map.graphicsLayerIds.indexOf(potentialNewID) > -1 || this.map._layers.indexOf(potentialNewID) > -1) {\r\n        clusterLayer = this.map.getLayer(potentialNewID);\r\n\r\n        var reloadData = false;\r\n        var refreshData = false;\r\n\r\n        //update the symbol if it has changed\r\n        if (JSON.stringify(clusterLayer.symbolData) !== JSON.stringify(lyrInfo.symbolData)) {\r\n          clusterLayer.symbolData = lyrInfo.symbolData;\r\n          clusterLayer.countColor = lyrInfo.symbolData._highLightColor;\r\n          refreshData = true;\r\n        }\r\n\r\n        //update the icon if it has changed\r\n        n = domConstruct.toDom(lyrInfo.panelImageData);\r\n        if (JSON.stringify(clusterLayer.icon) !== JSON.stringify(n.src)) {\r\n          clusterLayer.icon = n.src;\r\n          refreshData = true;\r\n        }\r\n        domConstruct.destroy(n.id);\r\n\r\n        clusterLayer.displayFeatureCount = lyrInfo.symbolData.displayFeatureCount;\r\n\r\n        if (clusterLayer.refresh !== lyrInfo.refresh) {\r\n          clusterLayer.refresh = lyrInfo.refresh;\r\n          reloadData = true;\r\n        }\r\n\r\n        if (refreshData) {\r\n          clusterLayer._setupSymbols();\r\n        }\r\n\r\n        clusterLayer.countEnabled = this.config.countEnabled;\r\n        clusterLayer.hidePanel = this.hidePanel;\r\n\r\n        if (clusterLayer.showAllFeatures !== this.showAllFeatures) {\r\n          reloadData = true;\r\n          clusterLayer.showAllFeatures = this.showAllFeatures;\r\n        }\r\n        if (clusterLayer.listDisabled !== this.listDisabled) {\r\n          reloadData = true;\r\n          clusterLayer.listDisabled = this.listDisabled;\r\n        }\r\n\r\n        if (reloadData) {\r\n          if (clusterLayer.url) {\r\n            clusterLayer.refreshFeatures(clusterLayer.url);\r\n          }\r\n        } else if (refreshData) {\r\n          clusterLayer.clusterFeatures();\r\n        }\r\n      } else {\r\n        configChange = false;\r\n        clusterLayer = new ClusterLayer({\r\n          name: lyrInfo.label + this.UNIQUE_APPEND_VAL_CL,\r\n          id: potentialNewID,\r\n          map: this.map,\r\n          node: dom.byId(\"recNum_\" + potentialNewID),\r\n          legendNode: dom.byId(\"legend_\" + potentialNewID),\r\n          infoTemplate: typeof (lyr.infoTemplate) !== 'undefined' ? lyr.infoTemplate : infoTemplate,\r\n          refreshInterval: this.config.refreshInterval,\r\n          refreshEnabled: this.config.refreshEnabled,\r\n          parentLayer: lyr,\r\n          lyrInfo: lyrInfo,\r\n          lyrType: lyrType,\r\n          _styleColor: this._styleColor,\r\n          originOperLayer: originOperLayer,\r\n          countEnabled: this.config.countEnabled,\r\n          hidePanel: this.hidePanel,\r\n          filter: jimuLayerInfo ? jimuLayerInfo.getFilter() : \"1=1\",\r\n          showAllFeatures: this.showAllFeatures,\r\n          listDisabled: this.listDisabled\r\n        });\r\n      }\r\n      clusterLayer.setVisibility(configChange ? clusterLayer.visible :\r\n        jimuLayerInfo.isShowInMap ? jimuLayerInfo.isShowInMap() : true);\r\n      return clusterLayer;\r\n    },\r\n\r\n    _createImageDataDiv: function (sym, w, h, parent, isCustom) {\r\n      var a;\r\n      var symbol = sym;\r\n      if (symbol) {\r\n        //TODO are these switched??\r\n        var height = w;\r\n        var width = h;\r\n        if (symbol.height && symbol.width) {\r\n          var ar;\r\n          if (symbol.height > symbol.width) {\r\n            ar = symbol.width / symbol.height;\r\n            width = w * ar;\r\n          } else if (symbol.width === symbol.height || symbol.width > symbol.height) {\r\n            width = w;\r\n            ar = symbol.width / symbol.height;\r\n            height = (ar > 0) ? h * ar : h;\r\n          }\r\n        }\r\n        if (typeof (symbol.setWidth) !== 'undefined') {\r\n          if (typeof (symbol.setHeight) !== 'undefined') {\r\n            symbol.setWidth(isCustom ? width - (width * 0.25) : width);\r\n            symbol.setHeight(isCustom ? height - (height * 0.25) : height);\r\n          } else {\r\n            symbol.setWidth(2);\r\n          }\r\n        } else if (typeof (symbol.size) !== 'undefined') {\r\n          if (symbol.size > 20) {\r\n            symbol.setSize(20);\r\n          }\r\n        }\r\n        a = domConstruct.create(\"div\", { 'class': \"imageDataGFX\" }, parent);\r\n        var mySurface = gfx.createSurface(a, w, h);\r\n        var descriptors = jsonUtils.getShapeDescriptors(symbol);\r\n        var shape = mySurface.createShape(descriptors.defaultShape)\r\n          .setFill(descriptors.fill)\r\n          .setStroke(descriptors.stroke);\r\n        shape.applyTransform({ dx: w / 2, dy: h / 2 });\r\n      }\r\n      return a;\r\n    },\r\n\r\n    _updateUI: function (styleName) {\r\n      this.styleName = styleName;\r\n\r\n      if (this.isDashboardTheme) {\r\n        this.isLightTheme = styleName ? styleName === 'light' : this.isLightTheme;\r\n\r\n        var removeDownClass = this.isLightTheme ? 'expandDown-dashboard' : 'expandDown';\r\n        var addDownClass = this.isLightTheme ? 'expandDown' : 'expandDown-dashboard';\r\n        this._updateNodes(removeDownClass, addDownClass);\r\n\r\n        var removeUpClass = this.isLightTheme ? 'expandUp-dashboard' : 'expandUp';\r\n        var addUpClass = this.isLightTheme ? 'expandUp' : 'expandUp-dashboard';\r\n        this._updateNodes(removeUpClass, addUpClass);\r\n\r\n        var removeExpandClass = this.isLightTheme ? 'expand-dashboard' : 'expand';\r\n        var addExpandClass = this.isLightTheme ? 'expand' : 'expand-dashboard';\r\n        this._updateNodes(removeExpandClass, addExpandClass);\r\n\r\n        var removeGroupItemUpClass = this.isLightTheme ? 'groupItemImageUp-dashboard' : 'groupItemImageUp';\r\n        var addGroupItemUpClass = this.isLightTheme ? 'groupItemImageUp' : 'groupItemImageUp-dashboard';\r\n        this._updateNodes(removeGroupItemUpClass, addGroupItemUpClass);\r\n\r\n        var removeGroupItemDownClass = this.isLightTheme ? 'groupItemImageDown-dashboard' : 'groupItemImageDown';\r\n        var addGroupItemDownClass = this.isLightTheme ? 'groupItemImageDown' : 'groupItemImageDown-dashboard';\r\n        this._updateNodes(removeGroupItemDownClass, addGroupItemDownClass);\r\n\r\n        var removeGroupItemClass = this.isLightTheme ? 'groupItemImage-dashboard' : 'groupItemImage';\r\n        var addGroupItemClass = this.isLightTheme ? 'groupItemImage' : 'groupItemImage-dashboard';\r\n        this._updateNodes(removeGroupItemClass, addGroupItemClass);\r\n      }\r\n    },\r\n\r\n    _updateNodes: function (remove, add) {\r\n      var nodes = query('.' + remove);\r\n      array.forEach(nodes, function (node) {\r\n        domClass.remove(node, remove);\r\n        domClass.add(node, add);\r\n      });\r\n    },\r\n\r\n    _toggleLayerVisibility: function (obj, e) {\r\n      e.stopPropagation();\r\n      this.map.infoWindow.hide();\r\n      var id = obj.id ? obj.id : obj.layerObject.id;\r\n      var lyr = this.layerList[id];\r\n      if (!lyr) {\r\n        if (obj.pl) {\r\n          id = obj.pl.id;\r\n        }\r\n        lyr = this.layerList[id];\r\n      }\r\n\r\n      if (lyr) {\r\n        var hasSubLayerId = lyr.li && lyr.li.hasOwnProperty(\"subLayerId\") ?\r\n          (typeof (lyr.li.subLayerId) !== 'undefined' && lyr.li.subLayerId.toString() !== \"-1\") : false;\r\n\r\n        var lyrInfo = this.operLayerInfos.getLayerInfoById(id);\r\n        var _vis = !domClass.contains(\"recIcon_\" + id, \"active\");\r\n\r\n        if (hasSubLayerId && lyr.type !== 'ClusterLayer') {\r\n          if (_vis) {\r\n            var currentLayerInfo = lyrInfo.parentLayerInfo;\r\n            while (currentLayerInfo) {\r\n              currentLayerInfo.setTopLayerVisible(true);\r\n              currentLayerInfo = currentLayerInfo.parentLayerInfo;\r\n            }\r\n          }\r\n          lyrInfo.setTopLayerVisible(_vis);\r\n        } else if (lyr) {\r\n          lyr.layerObject.setVisibility(_vis);\r\n          if (lyr.type === 'ClusterLayer' && _vis) {\r\n            lyr.layerObject.handleMapExtentChange({ levelChange: true });\r\n            lyr.layerObject.flashFeatures();\r\n          }\r\n          if (typeof (lyr.pl) !== 'undefined') {\r\n            lyr.pl.visibility = _vis;\r\n            if (this.map.graphicsLayerIds.indexOf(id) > -1) {\r\n              var l = this.map.getLayer(id);\r\n              l.setVisibility(_vis);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    },\r\n\r\n    _toggleLayerUI: function (obj, vis) {\r\n      var id = obj.id ? obj.id : obj.layerObject.id;\r\n      var lyr = this.layerList[id];\r\n      if (!lyr) {\r\n        if (obj.pl) {\r\n          id = obj.pl.id;\r\n        }\r\n        lyr = this.layerList[id];\r\n      }\r\n      if (lyr) {\r\n        var lyrInfo = this.operLayerInfos.getLayerInfoById(id);\r\n        var visScalRange = lyrInfo.isCurrentScaleInTheScaleRange ? lyrInfo.isCurrentScaleInTheScaleRange() : true;\r\n\r\n        var c = dom.byId(\"recLabel_\" + id);\r\n\r\n        this.layerList[id].visible = vis;\r\n        this.layerList[id].parentLayerVisible = vis;\r\n        if (this.layerList[id].type === 'ClusterLayer') {\r\n          this.layerList[id].layerObject.parentLayerVisible = vis;\r\n        }\r\n        if (this.config.countEnabled) {\r\n          if (domClass.contains(\"recNum_\" + id, !vis ? \"recNum\" : \"recNumInActive\")) {\r\n            var _append = this.isDartTheme ? ' darkThemeColor' : ' lightThemeColor';\r\n            domClass.remove(\"recNum_\" + id, !vis ? \"recNum\" : \"recNumInActive\");\r\n            domClass.add(\"recNum_\" + id, (!vis ? \"recNumInActive\" : \"recNum\") + _append);\r\n          }\r\n        }\r\n\r\n        var eD = this.isDartTheme ? 'expandDown-dart' :\r\n          (this.isDashboardTheme && !this.isLightTheme) ? 'expandDown-dashboard' : 'expandDown';\r\n        var eU = this.isDartTheme ? 'expandUp-dart' :\r\n          (this.isDashboardTheme && !this.isLightTheme) ? 'expandUp-dashboard' : 'expandUp';\r\n\r\n        if (!vis) {\r\n          domClass.remove(\"recIcon_\" + id, \"active\");\r\n          //this._clearList(this.layerList[id]);\r\n          if (c && c.firstChild) {\r\n            domClass.add(c.firstChild, \"inActive\");\r\n          }\r\n          if (!domClass.contains(\"exp_\" + id, \"expandInActive\")) {\r\n            domClass.add(\"exp_\" + id, \"expandInActive\");\r\n          }\r\n          if (lyr.legendOpen) {\r\n            if (domClass.contains(\"legend_\" + id, \"legendOn\")) {\r\n              //this.layerList[id].legendOpen = false;\r\n              domClass.remove(\"legend_\" + id, \"legendOn\");\r\n              domClass.add(\"legend_\" + id, \"legendOff\");\r\n              if (domClass.contains(\"exp_\" + id, eU)) {\r\n                domClass.remove(\"exp_\" + id, eU);\r\n                domClass.add(\"exp_\" + id, eD);\r\n              }\r\n            }\r\n          }\r\n          if (lyr.toggleLegend) {\r\n            lyr.toggleLegend.remove();\r\n          }\r\n          if (domClass.contains(\"rec_\" + id, \"rec\")) {\r\n            domClass.add(\"rec_\" + id, \"recDefault\");\r\n          }\r\n        } else {\r\n          domClass.add(\"recIcon_\" + id, \"active\");\r\n          if (c && c.firstChild) {\r\n            domClass.remove(c.firstChild, \"inActive\");\r\n          }\r\n          if (domClass.contains(\"exp_\" + id, \"expandInActive\") && visScalRange) {\r\n            domClass.remove(\"exp_\" + id, \"expandInActive\");\r\n          }\r\n          if (lyr.toggleLegend) {\r\n            lyr.toggleLegend.remove();\r\n          }\r\n          var rec = dom.byId('rec_' + id);\r\n          if (rec) {\r\n            lyr.toggleLegend = on(rec, \"click\", lang.hitch(this, this._toggleLegend, lyr));\r\n          }\r\n\r\n          if (domClass.contains(\"rec_\" + id, \"recDefault\")) {\r\n            domClass.remove(\"rec_\" + id, \"recDefault\");\r\n          }\r\n\r\n          if (!lyr.listDisabled) {\r\n            this._loadList(lyr, true);\r\n            if (lyr.legendOpen) {\r\n              domClass.add(\"legend_\" + id, \"legendOn\");\r\n              domClass.remove(\"legend_\" + id, \"legendOff\");\r\n              if (domClass.contains(\"exp_\" + id, eD)) {\r\n                domClass.remove(\"exp_\" + id, eD);\r\n                domClass.add(\"exp_\" + id, eU);\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n      return false;\r\n    },\r\n\r\n    _toggleLegend: function (obj, evt) {\r\n      if (evt.currentTarget.className !== 'thumb2' && evt.currentTarget.className !== 'recIcon') {\r\n        var id = obj.layerObject.id in this.layerList ? obj.layerObject.id : obj.li.id;\r\n        if (domClass.contains(\"legend_\" + id, \"legendOff\")) {\r\n          this._addSearching(id);\r\n          this.layerList[id].legendOpen = true;\r\n          if (typeof (this.layerList[id].li.layerListExtentChanged) === 'undefined' ||\r\n            this.layerList[id].requiresReload) {\r\n            this.layerList[id].li.layerListExtentChanged = true;\r\n            this.layerList[id].requiresReload = false;\r\n          }\r\n          if (this.layerList[id].li.layerListExtentChanged) {\r\n            setTimeout(lang.hitch(this, function () {\r\n              this._loadList(obj, false);\r\n            }), 500);\r\n          } else {\r\n            this._removeSearching(id, true);\r\n          }\r\n          domClass.remove(\"legend_\" + id, \"legendOff\");\r\n          domClass.add(\"legend_\" + id, \"legendOn\");\r\n        } else {\r\n          if (domClass.contains(\"legend_\" + id, \"legendOn\")) {\r\n            this.layerList[id].legendOpen = false;\r\n            var eD = this.isDartTheme ? 'expandDown-dart' :\r\n              (this.isDashboardTheme && !this.isLightTheme) ? 'expandDown-dashboard' : 'expandDown';\r\n            var eU = this.isDartTheme ? 'expandUp-dart' :\r\n              (this.isDashboardTheme && !this.isLightTheme) ? 'expandUp-dashboard' : 'expandUp';\r\n            if (domClass.contains(\"exp_\" + id, eU)) {\r\n              domClass.remove(\"exp_\" + id, eU);\r\n              domClass.add(\"exp_\" + id, eD);\r\n            }\r\n            domClass.remove(\"legend_\" + id, \"legendOn\");\r\n            domClass.add(\"legend_\" + id, \"legendOff\");\r\n          }\r\n        }\r\n      }\r\n      evt.stopPropagation();\r\n    },\r\n\r\n    _toggleGroup: function (obj, e) {\r\n      var id = e.currentTarget.id.slice(0, -2);\r\n      var fI = this.isDartTheme ? 'featureItem-dart' : 'featureItem';\r\n\r\n      var toggle = true;\r\n      if (e.target.parentNode) {\r\n        if (e.target.parentNode.id !== \"\") {\r\n          if (domClass.contains(e.target.parentNode.id, fI)) {\r\n            toggle = false;\r\n          }\r\n        }\r\n        if (e.target.id !== \"\") {\r\n          if (domClass.contains(e.target.id, fI)) {\r\n            toggle = false;\r\n          }\r\n        }\r\n      }\r\n\r\n      var gII = this.isDartTheme ? \"groupItemImage-dart\" :\r\n        (this.isDashboardTheme && !this.isLightTheme) ? \"groupItemImage-dashboard\" : \"groupItemImage\";\r\n      var gIIUp = this.isDartTheme ? \"groupItemImageUp-dart\" :\r\n        (this.isDashboardTheme && !this.isLightTheme) ? \"groupItemImageUp-dashboard\" : \"groupItemImageUp\";\r\n      var gIIDown = this.isDartTheme ? \"groupItemImageDown-dart\" :\r\n        (this.isDashboardTheme && !this.isLightTheme) ? \"groupItemImageDown-dashboard\" : \"groupItemImageDown\";\r\n      if (toggle) {\r\n        var lId = obj.layerObject.id in this.layerList ? obj.layerObject.id : obj.li.id;\r\n        var node = document.getElementById(e.currentTarget.id);\r\n        var _idx = node.childNodes[0].childNodes.length - 1;\r\n        if (domClass.contains(id, \"groupOff\")) {\r\n          if (this.layerList[lId].openGroups && this.layerList[lId].openGroups.length > 0) {\r\n            if (this.layerList[lId].openGroups.indexOf(id) === -1) {\r\n              this.layerList[lId].openGroups.push(id);\r\n            }\r\n          } else {\r\n            this.layerList[lId].openGroups = [id];\r\n          }\r\n          domClass.remove(id, \"groupOff\");\r\n          domClass.add(id, \"groupOn\");\r\n          this.layerList[lId].groupOpen = true;\r\n          if (node.childNodes[0].childNodes[_idx].childNodes[0].className.indexOf(gII) > -1) {\r\n            html.removeClass(node.childNodes[0].childNodes[_idx].childNodes[0], gIIDown);\r\n            html.addClass(node.childNodes[0].childNodes[_idx].childNodes[0], gIIUp);\r\n          }\r\n        } else {\r\n          if (domClass.contains(id, \"groupOn\")) {\r\n            domClass.remove(id, \"groupOn\");\r\n            domClass.add(id, \"groupOff\");\r\n\r\n            if (this.layerList[lId].openGroups && this.layerList[lId].openGroups.length > 0) {\r\n              var idx = this.layerList[lId].openGroups.indexOf(id);\r\n              if (idx > -1) {\r\n                this.layerList[lId].openGroups.splice(idx, 1);\r\n              }\r\n              if(this.layerList[lId].openGroups.length === 0){\r\n                this.layerList[lId].groupOpen = false;\r\n              }\r\n            } else {\r\n              this.layerList[lId].groupOpen = false;\r\n            }\r\n            if (node.childNodes[0].childNodes[_idx].childNodes[0].className.indexOf(gII) > -1) {\r\n              html.removeClass(node.childNodes[0].childNodes[_idx].childNodes[0], gIIUp);\r\n              html.addClass(e.currentTarget.childNodes[0].childNodes[_idx].childNodes[0], gIIDown);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    },\r\n\r\n    /*jshint unused:false*/\r\n    onAppConfigChanged: function (appConfig, reason, changedData) {\r\n      switch (reason) {\r\n        case 'themeChange':\r\n          this.inPanelOverrides(changedData);\r\n          this.destroy();\r\n          break;\r\n        case 'layoutChange':\r\n          this.inPanelOverrides(changedData);\r\n          break;\r\n        case 'styleChange':\r\n          if (!this.hidePanel) {\r\n            this._updateUI(changedData);\r\n            this._updateStyleColor(changedData);\r\n          }\r\n          break;\r\n        case 'widgetChange':\r\n          this.widgetChange = true;\r\n          if (changedData && changedData.config && changedData.config.layerInfos) {\r\n            this.removeOldClusterLayers(changedData.config.layerInfos);\r\n          }\r\n          this.row = null;\r\n          break;\r\n        case 'mapChange':\r\n          this._clearMap();\r\n      }\r\n    },\r\n\r\n    _updateStyleColor: function (changedData) {\r\n      setTimeout(lang.hitch(this, function () {\r\n        var p = this.getPanel();\r\n        var node;\r\n        switch (this.appConfig.theme.name) {\r\n          case 'BoxTheme':\r\n            node = p.containerNode.parentNode.parentNode.children[0];\r\n            break;\r\n          case 'DartTheme':\r\n            node = p.containerNode.parentNode;\r\n            break;\r\n          case 'TabTheme':\r\n            node = p.containerNode;\r\n            break;\r\n          case 'BillboardTheme':\r\n            node = p.containerNode.parentNode;\r\n            break;\r\n          case 'FoldableTheme':\r\n            node = p.containerNode.parentNode.firstChild;\r\n            break;\r\n          default:\r\n            node = this.pageHeader;\r\n            break;\r\n        }\r\n        var bc = window.getComputedStyle(node, null).getPropertyValue('background-color');\r\n        this._styleColor = Color.fromRgb(bc).toHex();\r\n        for (var k in this.layerList) {\r\n          var l = this.layerList[k];\r\n          if (l.type === \"ClusterLayer\") {\r\n            l.layerObject.setStyleColor(this._styleColor);\r\n          }\r\n        }\r\n        this._updateUI(changedData);\r\n      }), 50);\r\n    },\r\n\r\n    _clearMap: function () {\r\n      if (this.layerList) {\r\n        for (var k in this.layerList) {\r\n          var l = this.layerList[k];\r\n          if (l.type === \"ClusterLayer\") {\r\n            var _clear = true;\r\n            if (typeof (this.continuousRefreshEnabled) !== 'undefined') {\r\n              _clear = !this.continuousRefreshEnabled;\r\n            }\r\n            if (_clear) {\r\n              l.layerObject._clear();\r\n              this.map.removeLayer(l.layerObject);\r\n            }\r\n          }\r\n        }\r\n        this.layerList = {};\r\n      }\r\n    },\r\n\r\n    _close: function () {\r\n      this.widgetManager.closeWidget(this.id);\r\n    },\r\n\r\n    onClose: function () {\r\n      this.inherited(arguments);\r\n\r\n      for (var key in this.layerList) {\r\n        var layerListLayer = this.layerList[key];\r\n        if (layerListLayer.li && layerListLayer.li.orgRenderer) {\r\n          if (layerListLayer.layerObject.setRenderer) {\r\n            layerListLayer.layerObject.setRenderer(layerListLayer.li.orgRenderer);\r\n          } else if (layerListLayer.layerObject.setLayerDrawingOptions) {\r\n            layerListLayer.layerObject.setLayerDrawingOptions([]);\r\n          } else {\r\n            console.log(\"Error re-setting the renderer\");\r\n          }\r\n          layerListLayer.layerObject.refresh();\r\n        }\r\n      }\r\n\r\n      var disableRefresh = true;\r\n      if (typeof (this.config.continuousRefreshEnabled) !== 'undefined') {\r\n        disableRefresh = !this.config.continuousRefreshEnabled;\r\n      }\r\n      if (disableRefresh) {\r\n        if (this.refreshInterval !== 0) {\r\n          this.refreshIntervalValue = 0;\r\n          clearInterval(this.refreshInterval);\r\n          this.refreshInterval = 0;\r\n        }\r\n      }\r\n\r\n      if (!this.hidePanel) {\r\n        if (typeof (this.mapExtentChangedHandler) !== 'undefined') {\r\n          this.mapExtentChangedHandler.remove();\r\n          this.mapExtentChangedHandler = undefined;\r\n        } else {\r\n          if (typeof (this.iconClickHandler) !== 'undefined') {\r\n            this.iconClickHandler.remove();\r\n            this.iconClickHandler = undefined;\r\n          }\r\n        }\r\n      }\r\n    },\r\n\r\n    _clearChildNodes: function (parentNode) {\r\n      while (parentNode.hasChildNodes()) {\r\n        parentNode.removeChild(parentNode.lastChild);\r\n      }\r\n    },\r\n\r\n    _inVisibleRange: function (lyr, id) {\r\n      var visScaleRange = true;\r\n      if (lyr.layerObject && lyr.layerObject.hasOwnProperty('visibleAtMapScale')) {\r\n        visScaleRange = lyr.layerObject.visibleAtMapScale;\r\n      }\r\n      var lyrInfo = this.operLayerInfos.getLayerInfoById(id);\r\n      if (lyrInfo && lyrInfo.isCurrentScaleInTheScaleRange) {\r\n        visScaleRange = lyrInfo.isCurrentScaleInTheScaleRange();\r\n      }\r\n      return visScaleRange;\r\n    },\r\n\r\n    _mapExtentChange: function () {\r\n      var countEnabled = this.config.countEnabled;\r\n      var queries = [];\r\n      for (var key in this.layerList) {\r\n        var lyr = this.layerList[key];\r\n        lyr.visScaleRange = this._inVisibleRange(lyr, key);\r\n        if (!this.showAllFeatures) {\r\n          this._clearList(lyr);\r\n        }\r\n        if (!lyr.legendOpen || (lyr.groupEnabled && !lyr.groupOpen)) {\r\n          if (lyr.li) {\r\n            lyr.li.layerListExtentChanged = true;\r\n          }\r\n          if (lyr.visible && lyr.visScaleRange) {\r\n            if (lyr.type === \"ClusterLayer\" && lyr.layerObject.initalLoad && this.config.countEnabled) {\r\n              lyr.layerObject._updateNode(lyr.layerObject.node.innerHTML);\r\n            }\r\n\r\n            if (lyr.type !== 'ClusterLayer') {\r\n              var uNode = this.config.countEnabled ? lyr.node : lyr.legendNode;\r\n              if (typeof (lyr.layerObject) === 'undefined') {\r\n                console.log(\"layer object not known\");\r\n              } else {\r\n                this.countFeatures(lyr);\r\n              }\r\n            }\r\n          } else if (!lyr.visScaleRange) {\r\n            this._updateList([], lyr.legendNode, lyr.node, [], true, lyr);\r\n          }\r\n        } else {\r\n          if (lyr.visible && lyr.visScaleRange) {\r\n            lyr.updateList = true;\r\n            this._loadList(lyr, lyr.updateList);\r\n          } else {\r\n            this._updateList([], lyr.legendNode, lyr.node, [], true, lyr);\r\n          }\r\n        }\r\n      }\r\n    },\r\n\r\n    getFeatures: function (lyrInfo, fields, updateCount) {\r\n      var lyr = lyrInfo.layerObject;\r\n      var legendNode = lyrInfo.legendNode;\r\n      var node = lyrInfo.node;\r\n      var _needsGeom = !lyrInfo.listDisabled && lyrInfo.legendOpen ? true : false;\r\n      var visScaleRange = lyrInfo.visScaleRange;\r\n      var maxRecordCount = (lyr && lyr.maxRecordCount) ? lyr.maxRecordCount : undefined;\r\n      var url;\r\n      var queries = [];\r\n      var q = this._getQuery(lyrInfo, fields, _needsGeom);\r\n      if (lyrInfo.visible && visScaleRange) {\r\n        if (lyr.queryFeatures) {\r\n          //get the first set of features\r\n          if (!lyrInfo.listDisabled) {\r\n            queries.push(lyr.queryFeatures(q));\r\n          }\r\n          //query the ids incase we need more than maxRecordCount\r\n          queries.push(lyr.queryIds(q));\r\n        } else {\r\n          url = lyrInfo.li.url;\r\n          if (url.indexOf(\"MapServer\") > -1 || url.indexOf(\"FeatureServer\") > -1) {\r\n            var qt = new QueryTask(url);\r\n            //get the first set of features\r\n            if (!lyrInfo.listDisabled) {\r\n              queries.push(qt.execute(q));\r\n            }\r\n            //query the ids incase we need more than maxRecordCount\r\n            queries.push(qt.executeForIds(q));\r\n          }\r\n        }\r\n      } else {\r\n        //if it's not visible and not within the visible scale range\r\n        this._updateList([], lyrInfo.legendNode, lyrInfo.node, [], true, lyrInfo);\r\n      }\r\n      if (queries.length > 0) {\r\n        var featurePromises = all(queries);\r\n        featurePromises.then(lang.hitch(this, function (results) {\r\n          var s_id = lyrInfo.layerObject.id in this.layerList ? lyrInfo.layerObject.id : lyrInfo.li.id;\r\n          var updateNode;\r\n          if (node) {\r\n            updateNode = this.config.countEnabled ? node.parentNode : node.previousSibling;\r\n          }\r\n          if (results && results.length > 1) {\r\n            var _queries = [];\r\n            var queryIDs = results[1];\r\n            var count = 0;\r\n            //if IDs exceed max count we need to chunk\r\n            if (queryIDs && maxRecordCount && queryIDs.length > maxRecordCount) {\r\n              this._chunkRequest(lyr, url, queryIDs, maxRecordCount, fields, _needsGeom).then(lang.hitch(this,\r\n                function (fullFeatures) {\r\n                this._updateList(fullFeatures, legendNode, node, fields, updateCount, lyrInfo);\r\n              }));\r\n            } else {\r\n              this._updateList(results[0].features, legendNode, node, fields, updateCount, lyrInfo);\r\n            }\r\n          } else if (results && results.length === 1) {\r\n            if (this.config.countEnabled) {\r\n              node.innerHTML = utils.localizeNumber(results[0].length);\r\n            }\r\n            this._removeSearching(s_id, false);\r\n          } else {\r\n            if (this.config.countEnabled) {\r\n              node.innerHTML = utils.localizeNumber(0);\r\n            }\r\n            this.updateExpand(updateNode, true);\r\n            this._removeSearching(s_id, lyrInfo.legendOpen);\r\n          }\r\n        }));\r\n      }\r\n    },\r\n\r\n    _chunkRequest: function (lyr, url, IDs, max, fields, needsGeom) {\r\n      var def = new Deferred();\r\n      var queries = [];\r\n      var i, j;\r\n      for (i = 0, j = IDs.length; i < j; i += max) {\r\n        var ids = IDs.slice(i, i + max);\r\n\r\n        var q = new Query();\r\n        q.outFields = fields;\r\n        q.objectIds = ids;\r\n        q.returnGeometry = needsGeom;\r\n\r\n        if (lyr.queryFeatures) {\r\n          queries.push(lyr.queryFeatures(q));\r\n        } else if (url) {\r\n          var qt = new QueryTask(url);\r\n          queries.push(qt.execute(q));\r\n        }\r\n      }\r\n      var queryList = new DeferredList(queries);\r\n      queryList.then(lang.hitch(this, function (queryResults) {\r\n        if (queryResults) {\r\n          var allFeatures = [];\r\n          for (var i = 0; i < queryResults.length; i++) {\r\n            if (queryResults[i][1].features) {\r\n              allFeatures.push.apply(allFeatures, queryResults[i][1].features);\r\n            }\r\n          }\r\n          def.resolve(allFeatures);\r\n        }\r\n      }));\r\n      return def;\r\n    },\r\n\r\n    _clearList: function (lyrInfo) {\r\n      if (!lyrInfo.isLoaded && lyrInfo.legendNode) {\r\n        lyrInfo.isLoaded = false;\r\n        lyrInfo.legendNode.innerHTML = '';\r\n      }\r\n    },\r\n\r\n    _updateList: function (features, legendNode, node, fields, updateCount, lyrInfo, countOnly) {\r\n      var li = lyrInfo.li ? lyrInfo.li : lyrInfo;\r\n\r\n      if (lyrInfo.type === 'ClusterLayer') {\r\n        if (lyrInfo.layerObject.node) {\r\n          if (domClass.contains(lyrInfo.layerObject.node.id, 'searching')) {\r\n            domClass.remove(lyrInfo.layerObject.node.id, 'searching');\r\n          }\r\n        }\r\n      }\r\n\r\n      var visScaleRange = lyrInfo.visScaleRange;\r\n      var infoTemplate = lyrInfo.infoTemplate;\r\n      var displayOptions = lyrInfo.symbolData ? lyrInfo.symbolData.featureDisplayOptions : (li && li.symbolData) ?\r\n        li.symbolData.featureDisplayOptions : {};\r\n\r\n      if (node || legendNode) {\r\n        if (legendNode && (lyrInfo.hasOwnProperty('isLoaded') ? !lyrInfo.isLoaded : true)) {\r\n          legendNode.innerHTML = '';\r\n        }\r\n        if (updateCount && node && this.config.countEnabled) {\r\n          if (visScaleRange) {\r\n            node.innerHTML = utils.localizeNumber(features.length);\r\n          } else {\r\n            this.countFeatures(lyrInfo, lyrInfo.id || li.id);\r\n          }\r\n        }\r\n        var updateNode = this.config.countEnabled ? node.parentNode : legendNode.previousSibling;\r\n        if ((lyrInfo.type === 'ClusterLayer' && lyrInfo.visible) || lyrInfo.type !== 'ClusterLayer') {\r\n          this.updateExpand(updateNode, visScaleRange ? features.length === 0 : true);\r\n        }\r\n      }\r\n      if (countOnly) {\r\n        return;\r\n      }\r\n\r\n      if (!lyrInfo.listDisabled && !lyrInfo.isLoaded) {\r\n        if (features.length > 0) {\r\n          var jimuLayerInfo = this.operLayerInfos.getLayerInfoById(lyrInfo.id);\r\n\r\n          var renderer = (lyrInfo.type === \"ClusterLayer\") ? lyrInfo.layerObject.renderer :\r\n            (jimuLayerInfo && jimuLayerInfo.layerObject && jimuLayerInfo.layerObject.renderer) ?\r\n              jimuLayerInfo.layerObject.renderer :\r\n              features[0]._graphicsLayer ? features[0]._graphicsLayer.renderer :\r\n                (lyrInfo.layerObject && lyrInfo.layerObject.renderer) ? lyrInfo.layerObject.renderer :\r\n                  (li && li.renderer) ? jsonUtil.fromJson(li.renderer) || li.renderer :\r\n                    lyrInfo.renderer ? jsonUtil.fromJson(lyrInfo.renderer) || lyrInfo.renderer : undefined;\r\n          var _fields = (lyrInfo.li && lyrInfo.li.fields) ? lyrInfo.li.fields : lyrInfo.fields;\r\n\r\n          var groupNodes = [];\r\n          var finalGroupNodes = [];\r\n          var finalDomNodes = [];\r\n          for (var i = 0; i < features.length; i++) {\r\n            var groupAdded = false;\r\n            var feature = features[i];\r\n            if (typeof (feature.infoTemplate) === 'undefined' && infoTemplate) {\r\n              feature.infoTemplate = infoTemplate;\r\n            }\r\n\r\n            var symbol = (renderer && renderer.getSymbol) ? renderer.getSymbol(feature) :\r\n              (feature.symbol) ? jsonUtils.fromJson(feature.symbol) : undefined;\r\n\r\n            var oidName = (feature._layer && feature._layer.objectIdField) ? feature._layer.objectIdField :\r\n              (li && li.oidFieldName && li.oidFieldName.name) ? li.oidFieldName.name :\r\n                (lyrInfo.layerObject && lyrInfo.layerObject.objectIdField) ? lyrInfo.layerObject.objectIdField :\r\n                  (lyrInfo && lyrInfo.oidFieldName) ? lyrInfo.oidFieldName : undefined;\r\n\r\n            var id = oidName ? feature.attributes[oidName] : legendNode.id + i;\r\n\r\n            var flds = (fields[0] === '*') ? feature.attributes : fields;\r\n            var isNames = (fields[0] === '*') ? false : true;\r\n\r\n            var displayStringObj = this.getDisplayString(feature, lyrInfo, flds, displayOptions, oidName, isNames);\r\n            var displayString = displayStringObj.displayString;\r\n            var aliasNames = displayStringObj.aliasNames;\r\n            var firstValue = displayStringObj.firstValue;\r\n            var groupField, groupNode, groupContainer, displayValue, groupType;\r\n            if (displayOptions.groupEnabled) {\r\n              var featureValue;\r\n              var _value;\r\n              var appendVal = undefined; // jshint ignore:line\r\n              if (typeof (displayOptions.groupByField) === 'undefined' || displayOptions.groupByField) {\r\n                groupField = displayOptions.groupField;\r\n                featureValue = feature.attributes[groupField.name];\r\n                groupType = 'byField';\r\n                appendVal = featureValue;\r\n              } else {\r\n                groupField = displayOptions.groupByRendererOptions.fields[0];\r\n                featureValue = feature.attributes[groupField.name];\r\n                var groubByFields = displayOptions.groupByRendererOptions.fields;\r\n                var groupByValues = displayOptions.groupByRendererOptions.values;\r\n                groupType = 'byRenderer';\r\n\r\n                if (featureValue !== null && featureValue !== \"\") {\r\n                  expression_loop:\r\n                  for (var ii = 0; ii < groupByValues.length; ii++) {\r\n                    var _val = groupByValues[ii];\r\n                    var exp = _val.value;\r\n                    var expParts = exp.split(\"&&\");\r\n                    if (expParts && expParts.length > 1) {\r\n                      exp = featureValue + expParts[0] + \"&& \" + featureValue + expParts[1];\r\n                    } else {\r\n                      exp = isNaN(featureValue) ? \"'\" + featureValue + \"'\" + _val.value : featureValue + _val.value;\r\n                    }\r\n                    if (eval(exp)) { // jshint ignore:line\r\n                      _value = _val;\r\n                      break expression_loop;\r\n                    }\r\n                  }\r\n                  if (typeof (_value) !== 'undefined' && _value !== null) {\r\n                    appendVal = _value.label.replace(/ /g, '');\r\n                  }\r\n                }\r\n              }\r\n              var gId = 'group_' + li.id + \"_\" + groupField.name + \"_\" + appendVal;\r\n              var addGroup = true;\r\n              var n;\r\n              if (groupNodes.length > 0) {\r\n                node_loop:\r\n                for (var iii = 0; iii < groupNodes.length; iii++) {\r\n                  var gNode = groupNodes[iii];\r\n                  if (gId === gNode.id) {\r\n                    if (groupType === 'byField' && featureValue === gNode.value || groupType === 'byRenderer') {\r\n                      addGroup = false;\r\n                      n = gNode.node;\r\n                      groupContainer = gNode.parent;\r\n                      break node_loop;\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n              if (addGroup) {\r\n                groupAdded = true;\r\n                groupContainer = domConstruct.create('div', {\r\n                  'class': this.isDartTheme ? 'groupItem-dart' : 'groupItem',\r\n                  id: gId + \"_c\"\r\n                });\r\n                var groupTitle = domConstruct.create('div', {\r\n                  'class': this.isDartTheme ? 'groupItemTitle-dart' : 'groupItemTitle',\r\n                  id: gId + \"_t\"\r\n                }, groupContainer);\r\n                var label = \"\";\r\n                var title = groupType === 'byRenderer' ? \"\" : groupField.name + \": \";\r\n                if (typeof (aliasNames) !== 'undefined') {\r\n                  if (aliasNames.hasOwnProperty(groupField.name) && aliasNames[groupField.name] !== '') {\r\n                    if (groupType === 'byField') {\r\n                      title = aliasNames[groupField.name] + \": \";\r\n                    } else {\r\n                      title = \"\";\r\n                    }\r\n                  }\r\n                }\r\n                if (groupType === 'byField') {\r\n                  if (typeof (groupField.label) !== 'undefined' && groupField.label !== \"\") {\r\n                    label = groupField.label + \": \";\r\n                    title = label;\r\n                  }\r\n                  if (label === \": \") {\r\n                    label = \"\";\r\n                    title = \"\";\r\n                  }\r\n                } else {\r\n                  if (typeof (_value) !== 'undefined') {\r\n                    if (typeof (_value.label) !== 'undefined' && _value.label !== \"\") {\r\n                      label = title + _value.label;\r\n                      title = label;\r\n                    }\r\n                  } else {\r\n                    label = title + featureValue;\r\n                    title = label;\r\n                  }\r\n                  if (label === \": \") {\r\n                    label = \"\";\r\n                    title = \"\";\r\n                  }\r\n                }\r\n\r\n                displayValue = this._getFormattedValue(feature, groupField.name, lyrInfo, _fields);\r\n\r\n                if (groupType === 'byRenderer' && symbol) {\r\n                  this._createImageDataDiv(lang.clone(symbol), 30, 30, groupTitle, isCustom);\r\n                }\r\n\r\n                domConstruct.create('div', {\r\n                  'class': groupType === 'byField' ? 'groupField' : 'groupFieldImage',\r\n                  innerHTML: groupType === 'byField' ? label + displayValue : label,\r\n                  title: groupType === 'byField' ? title + displayValue : title\r\n                }, groupTitle);\r\n\r\n                var inGrpList = false;\r\n                if (lyrInfo.openGroups && lyrInfo.openGroups.length > 0) {\r\n                  inGrpList = lyrInfo.openGroups.indexOf(gId) > -1;\r\n                }\r\n                var _append = this.isDartTheme ? ' darkThemeColor' : ' lightThemeColor';\r\n                var groupCountNode = domConstruct.create('div', {\r\n                  'class': this.isDartTheme ? 'groupCountLabel' : 'groupCountLabel' + _append\r\n                }, groupTitle);\r\n\r\n                var imageContainer = domConstruct.create('div', {\r\n                  'class': (this.isDartTheme || (this.isDashboardTheme && !this.isLightTheme)) ?\r\n                    'expandImageContainer-dart' : 'expandImageContainer'\r\n                }, groupTitle);\r\n\r\n                var gIIUp = this.isDartTheme ? \"groupItemImageUp-dart\" :\r\n                  (this.isDashboardTheme && !this.isLightTheme) ?\r\n                    \"groupItemImageUp-dashboard\" : \"groupItemImageUp\";\r\n                var gIIDown = this.isDartTheme ? \"groupItemImageDown-dart\" :\r\n                  (this.isDashboardTheme && !this.isLightTheme) ?\r\n                    \"groupItemImageDown-dashboard\" : \"groupItemImageDown\";\r\n                var cNames = this.isDartTheme ? 'groupItemImage-dart' :\r\n                  (this.isDashboardTheme && !this.isLightTheme) ?\r\n                    \"groupItemImage-dashboard\" : 'groupItemImage';\r\n                cNames += inGrpList ? ' ' + gIIUp : ' ' + gIIDown;\r\n                domConstruct.create('div', {\r\n                  'class': cNames\r\n                }, imageContainer);\r\n\r\n                cNames = this.isDartTheme ? 'groupItem-dart' : 'groupItem';\r\n                cNames += (lyrInfo.groupOpen && inGrpList) ? ' groupOn' : ' groupOff';\r\n                groupNode = domConstruct.create('div', {\r\n                  'class': cNames,\r\n                  id: gId\r\n                }, groupContainer);\r\n\r\n                groupNodes.push({\r\n                  id: 'group_' + li.id + \"_\" + groupField.name + \"_\" + appendVal,\r\n                  node: groupNode,\r\n                  parent: groupContainer,\r\n                  value: featureValue\r\n                });\r\n\r\n                finalGroupNodes.push({\r\n                  value: featureValue,\r\n                  node: groupContainer,\r\n                  countNode: groupCountNode,\r\n                  count: 1\r\n                });\r\n\r\n                on(groupContainer, \"click\", lang.hitch(this, this._toggleGroup, lyrInfo));\r\n              } else {\r\n                var result = finalGroupNodes.filter(function (o) {\r\n                  if (o.node.id === (n.id + \"_c\")) {\r\n                    return o;\r\n                  }\r\n                });\r\n\r\n                result[0].count += 1;\r\n                groupNode = n;\r\n              }\r\n            }\r\n            var featureItem = domConstruct.create('div', {\r\n              'class': this.isDartTheme ? 'featureItem-dart' : 'featureItem',\r\n              id: 'feature_' + li.id + \"_\" + id\r\n            });\r\n\r\n            var isCustom = false;\r\n            if (li && li.symbolData) {\r\n              isCustom = li.symbolData.symbolType === \"CustomSymbol\";\r\n            }\r\n            if (symbol) {\r\n              if (displayOptions.groupEnabled && groupType === 'byRenderer') {\r\n                //this._createImageDataDiv(lang.clone(symbol), 30, 30, groupTitle, isCustom);\r\n              } else {\r\n                this._createImageDataDiv(lang.clone(symbol), 30, 30, featureItem, isCustom);\r\n              }\r\n            }\r\n\r\n            on(featureItem, \"click\", lang.hitch(this, this._panToFeature, feature));\r\n\r\n            if (displayString.indexOf(\" - \") > -1) {\r\n              displayString = displayString.slice(0, -3);\r\n            }\r\n            var _margin = displayOptions.groupEnabled && groupType === 'byRenderer' ? \"15px\" : \"50px\";\r\n            var _txtAlign = window.isRTL ? \"right\" : \"left\";\r\n            domConstruct.create('div', {\r\n              style: \"padding: 7px 5px 5px \" + _margin + \"; text-align: \" + _txtAlign + \";\",\r\n              innerHTML: displayString,\r\n              title: displayString\r\n            }, featureItem);\r\n\r\n            finalDomNodes.push({\r\n              node: featureItem,\r\n              updateNode: groupNode ? groupNode : legendNode,\r\n              firstValue: firstValue\r\n            });\r\n          }\r\n\r\n          if (finalGroupNodes.length > 0) {\r\n            //sort and place at legendNode\r\n            var nodes = finalGroupNodes.sort(function (a, b) {\r\n              if (typeof (a.value) === 'undefined') {\r\n                return b.value;\r\n              } else if (typeof (b.value) === 'undefined') {\r\n                return a.value;\r\n              }\r\n              if (isNaN(a.value)) {\r\n                return a.value.localeCompare(b.value);\r\n              } else {\r\n                return parseFloat(a.value) - parseFloat(b.value);\r\n              }\r\n            });\r\n            var cE = this.config.countEnabled;\r\n            array.forEach(nodes, function (n) {\r\n              if (cE) {\r\n                n.countNode.innerHTML = utils.localizeNumber(n.count);\r\n              }\r\n              legendNode.appendChild(n.node);\r\n            });\r\n          }\r\n\r\n          if (finalDomNodes.length > 0) {\r\n            var sortedNodes = finalDomNodes.sort(function (a, b) {\r\n              var _a = a.firstValue;\r\n              var _b = b.firstValue;\r\n              if (typeof (_a) === 'undefined' || _a === null || _a === \"\") {\r\n                return 1;\r\n              } else if (typeof (_b) === 'undefined' || _b === null || _b === \"\") {\r\n                return -1;\r\n              } else if (_a === _b) {\r\n                return 0;\r\n              }\r\n              return _a.toString().localeCompare(_b.toString());\r\n            });\r\n            array.forEach(sortedNodes, function (fdn) {\r\n              domConstruct.place(fdn.node, fdn.updateNode);\r\n            });\r\n          }\r\n        }\r\n      }\r\n      li.layerListExtentChanged = false;\r\n\r\n      var s_id = (lyrInfo.layerObject && lyrInfo.layerObject.id && lyrInfo.layerObject.id in this.layerList) ?\r\n        lyrInfo.layerObject.id : li.id;\r\n      if (this.showAllFeatures && lyrInfo.visible) {\r\n        var loaded = true;\r\n        if (lyrInfo.layerObject && lyrInfo.type === 'ClusterLayer') {\r\n          loaded = !lyrInfo.layerObject.queryPending;\r\n          if (lyrInfo.layerObject.hasOwnProperty('requiresReload')) {\r\n            loaded = loaded && !lyrInfo.layerObject.requiresReload;\r\n            lyrInfo.layerObject.requiresReload = false;\r\n          }\r\n        }\r\n        lyrInfo.isLoaded = loaded;\r\n      }\r\n\r\n      this._removeSearching(s_id, lyrInfo.legendOpen);\r\n    },\r\n\r\n    updateExpand: function (node, hide) {\r\n      if (typeof (node) !== 'undefined') {\r\n        var id;\r\n        var en;\r\n        if (node.id.indexOf('rec_') > -1) {\r\n          id = node.id.replace('rec_', '');\r\n          en = dom.byId(\"exp_\" + id);\r\n        }\r\n\r\n        if (hide) {\r\n          if (node) {\r\n            html.addClass(node, \"recDefault\");\r\n            html.addClass(node, \"inActive\");\r\n          }\r\n          if (en) {\r\n            if (!domClass.contains(en, 'expand-empty')) {\r\n              html.addClass(en, \"expandInActive\");\r\n            }\r\n          }\r\n        } else {\r\n          if (node) {\r\n            html.removeClass(node, \"recDefault\");\r\n            html.removeClass(node, \"inActive\");\r\n          }\r\n          if (en) {\r\n            if (!domClass.contains(en, 'expand-empty')) {\r\n              html.removeClass(en, \"expandInActive\");\r\n            }\r\n          }\r\n        }\r\n      }\r\n    },\r\n\r\n    getDisplayString: function (feature, lyrInfo, fields, displayOptions, oidName, isNames) {\r\n      var displayString = \"\";\r\n      var aliasNames = {};\r\n      var firstValue = \"\";\r\n      if (displayOptions.fields.length > 0) {\r\n        //get the layer fields\r\n        var _fields = (lyrInfo.li && lyrInfo.li.fields) ? lyrInfo.li.fields : lyrInfo.fields;\r\n        array.forEach(displayOptions.fields, lang.hitch(this, function (displayField) {\r\n          for (var a in fields) {\r\n            var fieldName = isNames ? fields[a] : a;\r\n            if (fieldName === displayField.name) {\r\n\r\n              //get the value with proper formatting\r\n              var featureValue = this._getFormattedValue(feature, fieldName, lyrInfo, _fields);\r\n              //set the alias name\r\n              aliasNames[fieldName] = this._checkAliasName(_fields, fieldName);\r\n\r\n              firstValue = firstValue === \"\" ? featureValue : firstValue;\r\n              var hasLabel = typeof(displayField.label) !== 'undefined';\r\n              var append = hasLabel ? displayField.label.trim() === \"\" ? \"\" : \": \" : \"\";\r\n              var label = hasLabel ? displayField.label : \"\";\r\n\r\n              displayString += label + append + featureValue + \" - \";\r\n              break;\r\n            }\r\n          }\r\n        }));\r\n      }\r\n      return {\r\n        displayString: displayString,\r\n        aliasNames: aliasNames,\r\n        firstValue: firstValue\r\n      };\r\n    },\r\n\r\n    _getFormattedValue: function(feature, fieldName, lyrInfo, fields){\r\n      //get raw feature value\r\n      var featureValue = feature.attributes[fieldName] || \"\";\r\n\r\n      //get the fieldInfos\r\n      var fieldInfos;\r\n      var infoTemplate = this._getInfoTemplate(lyrInfo);\r\n      if(infoTemplate) {\r\n        if (infoTemplate.info && infoTemplate.info.fieldInfos) {\r\n          fieldInfos = infoTemplate.info.fieldInfos;\r\n        } else if(infoTemplate._fieldsMap){\r\n          fieldInfos = infoTemplate._fieldsMap;\r\n        }\r\n      }\r\n      //get fieldInfo and field\r\n      var fieldInfo;\r\n      if (fieldInfos && Array.isArray(fieldInfos) && fieldInfos.hasOwnProperty('length')) {\r\n        fieldInfo = this._getFieldByName(fieldInfos, fieldName);\r\n      }\r\n      var field = this._getFieldByName(fields, fieldName);\r\n      if (field) {\r\n        var intField = this._checkIntField(field);\r\n        var domainField = this._checkDomainField(field);\r\n        var dateField = this._checkDateField(field);\r\n\r\n        featureValue = dateField ? this.formatDateValue(featureValue, fieldInfo) :\r\n          domainField ? this.formatDomainValue(featureValue, domainField) :\r\n            intField ? this.formatNumberValue(featureValue, fieldInfo) : featureValue;\r\n      }\r\n      return featureValue;\r\n    },\r\n\r\n    _getFieldByName: function (fields, fieldName) {\r\n      if (fields) {\r\n        var _fields = fields.filter(function (f) {\r\n          return f.name === fieldName || f.fieldName === fieldName ||\r\n          (fields.hasOwnProperty(f) && fields[f].fieldName === fieldName);\r\n        });\r\n        if (_fields && _fields.length > 0) {\r\n          return _fields[0];\r\n        }\r\n      }\r\n      return undefined;\r\n    },\r\n\r\n    _getInfoTemplate: function (lyrInfo) {\r\n      var infoTemplate = lyrInfo.infoTemplate;\r\n      if (!infoTemplate) {\r\n        if (lyrInfo.layerObject && lyrInfo.layerObject.infoTemplate) {\r\n          infoTemplate = lyrInfo.layerObject.infoTemplate;\r\n        } else if (lyrInfo.li && lyrInfo.li.infoTemplate) {\r\n          infoTemplate = lyrInfo.li.infoTemplate;\r\n        }\r\n      }\r\n      if (!infoTemplate) {\r\n        if (typeof (lyrInfo.li.subLayerId) !== 'undefined') {\r\n          var infoTemplates = lyrInfo.layerObject.infoTemplates;\r\n          if (infoTemplates && infoTemplates.hasOwnProperty(lyrInfo.li.subLayerId)) {\r\n            infoTemplate = infoTemplates[lyrInfo.li.subLayerId].infoTemplate;\r\n          }\r\n        }\r\n      }\r\n      return infoTemplate;\r\n    },\r\n\r\n    formatNumberValue: function(v, fieldInfo){\r\n      var num = v;\r\n      if(!isNaN(v)){\r\n        var options = (fieldInfo && fieldInfo.format) ? fieldInfo : undefined;\r\n        num = utils.localizeNumberByFieldInfo(v, options);\r\n      }\r\n      return num || \"\";\r\n    },\r\n\r\n    formatDomainValue: function (v, domain) {\r\n      if (domain && domain.codedValues) {\r\n        var cvs = domain.codedValues;\r\n        for (var i = 0; i < cvs.length; i++) {\r\n          var cv = cvs[i];\r\n          if (cv.code === v) {\r\n            return cv.name;\r\n          }\r\n        }\r\n      }\r\n      return undefined;\r\n    },\r\n\r\n    formatDateValue: function (v, fieldInfo) {\r\n      if (v) {\r\n        var options = (fieldInfo && fieldInfo.format) ? fieldInfo : undefined;\r\n        var d = new Date(parseInt(v, 10));\r\n        return options ? utils.localizeDateByFieldInfo(d, options) : utils.localizeDate(d);\r\n      } else {\r\n        return \"\";\r\n      }\r\n    },\r\n\r\n    _checkAliasName: function (field) {\r\n      return typeof (field.alias) !== 'undefined' ? field.alias : false;\r\n    },\r\n\r\n    _checkDomainField: function (field) {\r\n      return typeof (field.domain) !== 'undefined' ? field.domain : false;\r\n    },\r\n\r\n    _checkDateField: function(field){\r\n      return field.type === 'esriFieldTypeDate';\r\n    },\r\n\r\n    _checkIntField: function(field){\r\n      var testTypes = ['esriFieldTypeSmallInteger', 'esriFieldTypeInteger',\r\n      'esriFieldTypeSingle', 'esriFieldTypeDouble'];\r\n      return testTypes.indexOf(field.type) > -1;\r\n    },\r\n\r\n    _checkDisplayField: function(displayFields, featureField){\r\n      var includeField = true;\r\n      if (displayFields) {\r\n        for (var j = 0; j < displayFields.length; j++) {\r\n          if (displayFields[j].name === featureField) {\r\n            return displayFields[j];\r\n          } else {\r\n            includeField = false;\r\n          }\r\n        }\r\n      }\r\n      return includeField;\r\n    },\r\n\r\n    flashGraphics: function (graphics) {\r\n      for (var i = 0; i < graphics.length; i++) {\r\n        var g = graphics[i];\r\n        this._flashFeature(g);\r\n      }\r\n    },\r\n\r\n    _flashFeature: function (feature) {\r\n      var symbol;\r\n      if (feature.geometry) {\r\n        var color = Color.fromHex(this._styleColor);\r\n        var color2 = lang.clone(color);\r\n        color2.a = 0.4;\r\n        switch (feature.geometry.type) {\r\n          case 'point':\r\n            symbol = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE, 15,\r\n              new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,\r\n              color, 1),\r\n              color2);\r\n            break;\r\n          case 'polyline':\r\n            symbol = new SimpleLineSymbol(\r\n              SimpleLineSymbol.STYLE_SOLID,\r\n              color,\r\n              3\r\n            );\r\n            break;\r\n          case 'polygon':\r\n            symbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_DIAGONAL_CROSS,\r\n              new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,\r\n              color, 2), color2\r\n            );\r\n            break;\r\n        }\r\n      }\r\n\r\n      var g = new Graphic(feature.geometry, symbol);\r\n      this.map.graphics.add(g);\r\n      var dShape = g.getDojoShape();\r\n      if (dShape) {\r\n        fx.animateStroke({\r\n          shape: dShape,\r\n          duration: 900,\r\n          color: {\r\n            start: dShape.strokeStyle.color,\r\n            end: dShape.strokeStyle.color\r\n          },\r\n          width: {\r\n            start: 25,\r\n            end: 0\r\n          }\r\n        }).play();\r\n        setTimeout(this._clearFeature, 1075, g);\r\n      }\r\n    },\r\n\r\n    _clearFeature: function (f) {\r\n      var gl = f.getLayer();\r\n      gl.remove(f);\r\n    },\r\n\r\n    _panToFeature: function (feature) {\r\n      if (feature.geometry) {\r\n        var geom = feature.geometry;\r\n        if (geom.type === 'polyline') {\r\n          var path = geom.paths[Math.ceil(geom.paths.length / 2) - 1];\r\n          var g = path[Math.ceil((path.length - 1) / 2)];\r\n          geom = new Point(g[0], g[1], geom.spatialReference);\r\n        }\r\n        if (geom.type !== 'point') {\r\n          geom = geom.getExtent().getCenter();\r\n        }\r\n        this._pan(feature, geom).then(lang.hitch(this, function () {\r\n          this._flashFeature(feature);\r\n          if ((feature._layer && feature._layer.infoTemplate) || feature.infoTemplate) {\r\n            this.map.infoWindow.setFeatures([feature]);\r\n            this.map.infoWindow.select(0);\r\n            this.map.infoWindow.show(geom);\r\n          }\r\n        }));\r\n      }\r\n    },\r\n\r\n    _pan: function (feature, centerPoint) {\r\n      var def = new Deferred();\r\n      if (this.showAllFeatures && !this.map.extent.contains(feature.geometry)) {\r\n        this.map.centerAt(centerPoint).then(function (ext) {\r\n          def.resolve(ext);\r\n        });\r\n      } else {\r\n        def.resolve(undefined);\r\n      }\r\n      return def;\r\n    },\r\n\r\n    _getQuery: function (layerListLayer, fields, needsGeom) {\r\n      var layerObject = layerListLayer.layerObject;\r\n      var q = new Query();\r\n      q.geometry = !this.showAllFeatures ? this.map.extent : null;\r\n      q.outFields = fields;\r\n      q.returnGeometry = needsGeom;\r\n      var collectionTypes = ['collection', 'kml', 'geo_rss'];\r\n      var isCollection = layerListLayer.selfType ? collectionTypes.indexOf(layerListLayer.selfType) > -1 :  false;\r\n      //layer types from feature collection don't support where\r\n      if (!isCollection && layerObject.url) {\r\n        q.where = layerListLayer.filter ? layerListLayer.filter : \"1=1\";\r\n      } else if (this.showAllFeatures && layerObject && layerObject.fullExtent) {\r\n        //still need a way to support showing of all features\r\n        q.geometry = layerObject.fullExtent;\r\n      }\r\n      return q;\r\n    },\r\n\r\n    countFeatures: function (layerListLayer) {\r\n      if (!this.hidePanel) {\r\n        var lyr = layerListLayer.layerObject;\r\n        var visible = typeof(layerListLayer.visible) !== 'undefined' ? layerListLayer.visible : lyr.visible;\r\n        var visScaleRange = layerListLayer.visScaleRange;\r\n        var node = this.config.countEnabled ? layerListLayer.node : layerListLayer.legendNode;\r\n        var q = this._getQuery(layerListLayer);\r\n        if (lyr.queryCount && lyr.visible) {\r\n          lyr.queryCount(q, lang.hitch(this, function (r) {\r\n            if (node) {\r\n              var updateNode;\r\n              if (this.config.countEnabled) {\r\n                node.innerHTML = utils.localizeNumber(r);\r\n                updateNode = node.parentNode;\r\n              } else {\r\n                updateNode = node.previousSibling;\r\n              }\r\n              this.updateExpand(updateNode, visScaleRange ? r === 0 : true);\r\n            }\r\n          }));\r\n        } else if (layerListLayer && layerListLayer.li && layerListLayer.li.url && visible) {\r\n          var url = layerListLayer.li.url;\r\n          if (url.indexOf(\"MapServer\") > -1 || url.indexOf(\"FeatureServer\") > -1) {\r\n            var qt = new QueryTask(url);\r\n            qt.executeForIds(q).then(lang.hitch(this, function (ids) {\r\n              if (node) {\r\n                var updateNode;\r\n                var length = ids ? ids.length : 0;\r\n                if (this.config.countEnabled) {\r\n                  node.innerHTML = utils.localizeNumber(length);\r\n                  updateNode = node.parentNode;\r\n                } else {\r\n                  updateNode = node.previousSibling;\r\n                }\r\n                this.updateExpand(updateNode, visScaleRange ? length === 0 : true);\r\n              }\r\n            }));\r\n          }\r\n        }\r\n      }\r\n    }\r\n  });\r\n});"]}