{"version":3,"sources":["../../../../widgets/InfoSummary/js/ClusterLayer.js"],"names":["define","declare","array","dojoEvent","lang","Color","html","DeferredList","domClass","dom","fx","on","Evented","utils","GraphicsLayer","Graphic","Extent","Point","PictureMarkerSymbol","SimpleMarkerSymbol","SimpleLineSymbol","TextSymbol","Font","SimpleRenderer","Query","QueryTask","FeatureSet","jsonUtils","renderUtils","FeatureLayer","clusterLayer","constructor","options","clusterGraphics","cancelRequest","clusterSize","_singles","_showSingles","updateFeatures","undefined","hidePanel","_parent","_parentLayer","parentLayer","objectIdField","fields","name","_map","map","color","fromString","_styleColor","symbolData","lyrInfo","countColor","_highLightColor","itemId","refresh","displayFeatureCount","node","countEnabled","legendNode","id","infoTemplate","url","_testRenderer","renderer","originOperLayer","_getInfoTemplate","lyrType","filter","showAllFeatures","listDisabled","selfType","_setupSymbols","_setFieldNames","countFeatures","refreshInterval","setInterval","hitch","_updateEnd","lyr","q","geometry","extent","fullExtent","queryCount","r","nodeCount","_initFeatures","fl","_features","loading","staticLayers","indexOf","graphics","_getSourceFeatures","clusterFeatures","loadData","where","outFields","returnGeometry","queryFeatures","then","results","features","extentChangeSignal","handleMapExtentChange","clickSignal","handleClick","i","length","g","push","originOpLayer","l","parentLayerInfo","controlPopupInfo","infoTemplates","subLayerId","split","pop","hasOwnProperty","setInfoTemplate","_fieldNames","info","fieldInfos","visible","fieldName","featureDisplayOptions","ii","f","setLayerInfo","clearSingles","singles","s","forEach","remove","_getSingleGraphic","p","x","y","spatialReference","attributes","setSymbol","_singleSym","_addSingles","add","infoWindow","setFeatures","initalCount","qt","executeForIds","updateNode","contains","innerHTML","localizeNumber","parentNode","previousSibling","updateExpand","hide","en","replace","byId","addClass","removeClass","queryPending","max","maxRecordCount","queryIDs","queries","j","ids","slice","_q","objectIds","outSpatialReference","_qt","execute","queryList","queryResults","sr","fs","item","geom","gra","setAttributes","shouldUpdate","JSON","stringify","requiresReload","emit","bubbles","cancelable","console","log","event","graphic","attr","Data","stopPropagation","symbol","show","mapPoint","stop","levelChange","delta","dx","Math","abs","dy","refreshFeatures","responseLayer","responseFeatureSetFeatures","featureSet","transform","clear","getGraphicOptions","graphicOptions","rings","wkid","paths","points","flashFeatures","flashGraphics","flashSingle","cls2","STYLE_NULL","symColor","toRgb","STYLE_CIRCLE","_flashFeature","setTimeout","_clearFeatures","feature","fromHex","color2","clone","a","size","STYLE_SOLID","dShape","getDojoShape","animateStroke","shape","duration","start","strokeStyle","end","width","play","_clearFeature","gl","getLayer","setColor","setStyleColor","cancelPendingRequests","removeEventListeners","isShowing","total","mapExt","o","xmin","ymax","rows","ceil","height","cols","distX","getWidth","distY","getHeight","c","x1","y2","x2","y1","ext","cGraphics","cPt","getClusterCenter","center","clusterGraphic","count","data","label","size2","fnt","family","symText","setOffset","testSize","w","h","icon","_setSymbols","Count","symbolType","csym","csym3","psym","pt","_g","fromJson","_updateNode","fsp","style","lineWidth","backgroundClusterSymbol","outline","cls","path","pathName","window","location","pathname","origin","imageData","iconType","_h","_w","type","sls","csym2","xoffset","yoffset","cls1","psym2","clusterSymbol","toJson","xSum","ySum","destroy","_clear"],"mappings":"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","file":"ClusterLayer.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright Â© 2014 - 2018 Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\n\r\ndefine([\r\n   'dojo/_base/declare',\r\n   'dojo/_base/array',\r\n   'dojo/_base/event',\r\n   'dojo/_base/lang',\r\n   'dojo/_base/Color',\r\n   'dojo/_base/html',\r\n   'dojo/DeferredList',\r\n   'dojo/dom-class',\r\n   'dojo/dom',\r\n   'dojox/gfx/fx',\r\n   'dojo/on',\r\n   'dojo/Evented',\r\n   'jimu/utils',\r\n   'esri/layers/GraphicsLayer',\r\n   'esri/graphic',\r\n   'esri/geometry/Extent',\r\n   'esri/geometry/Point',\r\n   'esri/symbols/PictureMarkerSymbol',\r\n   'esri/symbols/SimpleMarkerSymbol',\r\n   'esri/symbols/SimpleLineSymbol',\r\n   'esri/symbols/TextSymbol',\r\n   'esri/symbols/Font',\r\n   'esri/renderers/SimpleRenderer',\r\n   'esri/tasks/query',\r\n   'esri/tasks/QueryTask',\r\n   'esri/tasks/FeatureSet',\r\n   'esri/symbols/jsonUtils',\r\n   'esri/renderers/jsonUtils',\r\n   'esri/layers/FeatureLayer'\r\n], function (declare,\r\n  array,\r\n  dojoEvent,\r\n  lang,\r\n  Color,\r\n  html,\r\n  DeferredList,\r\n  domClass,\r\n  dom,\r\n  fx,\r\n  on,\r\n  Evented,\r\n  utils,\r\n  GraphicsLayer,\r\n  Graphic,\r\n  Extent,\r\n  Point,\r\n  PictureMarkerSymbol,\r\n  SimpleMarkerSymbol,\r\n  SimpleLineSymbol,\r\n  TextSymbol,\r\n  Font,\r\n  SimpleRenderer,\r\n  Query,\r\n  QueryTask,\r\n  FeatureSet,\r\n  jsonUtils,\r\n  renderUtils,\r\n  FeatureLayer) {\r\n  var clusterLayer = declare('ClusterLayer', [GraphicsLayer, Evented], {\r\n    //TODO change size breaks to equal interval eg. breaks = (max - min) / numRanges;\r\n    constructor: function (options) {\r\n      //Defaults\r\n      this.clusterGraphics = [];\r\n      this.cancelRequest = false;\r\n      this.clusterSize = 120;\r\n      this._singles = [];\r\n      this._showSingles = true;\r\n      this.updateFeatures = undefined;\r\n\r\n      //Options\r\n      this.hidePanel = options.hidePanel;\r\n      this._parent = options._parent;\r\n      this._parentLayer = options.parentLayer;\r\n      if (this._parentLayer) {\r\n        this.objectIdField = this._parentLayer.objectIdField;\r\n        this.fields = this._parentLayer.fields;\r\n      }\r\n      this.name = options.name;\r\n      this._map = options.map;\r\n      this.color = Color.fromString(options.color || '#ff0000');\r\n      this._styleColor = options._styleColor;\r\n      this.symbolData = options.lyrInfo.symbolData;\r\n      this.countColor = this.symbolData._highLightColor;\r\n      this.itemId = options.lyrInfo.itemId;\r\n      this.refresh = options.lyrInfo.refresh;\r\n      this.displayFeatureCount = this.symbolData.displayFeatureCount;\r\n      this.node = options.node;\r\n      this.countEnabled = options.countEnabled;\r\n      this.legendNode = options.legendNode;\r\n      this.id = options.id;\r\n      this.infoTemplate = options.infoTemplate;\r\n      this.url = options.lyrInfo.url;\r\n      this._testRenderer = options.lyrInfo.renderer;\r\n      this.originOperLayer = options.originOperLayer;\r\n      if (this.originOperLayer) {\r\n        this._getInfoTemplate(this.originOperLayer);\r\n      }\r\n      this.lyrInfo = options.lyrInfo;\r\n      this.lyrType = options.lyrType;\r\n      this.filter = options.filter;\r\n      this.showAllFeatures = options.showAllFeatures;\r\n      this.listDisabled = options.listDisabled;\r\n      this.selfType = options.selfType;\r\n\r\n      this._setupSymbols();\r\n      this._setFieldNames();\r\n      this.countFeatures(this._parentLayer);\r\n\r\n      if(this._parentLayer.refreshInterval > 0) {\r\n        setInterval(lang.hitch(this, this._updateEnd), this._parentLayer.refreshInterval * 60000);\r\n      }\r\n    },\r\n\r\n    countFeatures: function (lyr) {\r\n      //Query the features based on map extent for supported layer types\r\n      var q = new Query();\r\n      q.geometry = !this.showAllFeatures ? this._map.extent : lyr.fullExtent;\r\n      if (lyr.queryCount) {\r\n        lyr.queryCount(q, lang.hitch(this, function (r) {\r\n          if (r > 0) {\r\n            //Feature collection layers with no features\r\n            // throw an error that I can't seem to catch when you\r\n            //apply a where clause such as \"1=1\"\r\n            if (!this.hidePanel) {\r\n              this.nodeCount = r;\r\n            }\r\n            this._initFeatures(this._parentLayer);\r\n          } else {\r\n            if (!this.hidePanel) {\r\n              this.nodeCount = 0;\r\n              if (lyr.url) {\r\n                var fl = new FeatureLayer(lyr.url);\r\n                on(fl, \"load\", lang.hitch(this, function () {\r\n                  this.countFeatures(fl);\r\n                }));\r\n              } else {\r\n                this._initFeatures(this._parentLayer);\r\n              }\r\n            }\r\n          }\r\n        }));\r\n      } else {\r\n        this._initFeatures(this._parentLayer);\r\n      }\r\n    },\r\n\r\n    _initFeatures: function (lyr) {\r\n      this._features = [];\r\n      var loading = true;\r\n      var q = new Query();\r\n      var staticLayers = [\"CSV\", \"Feature Collection\", \"GeoRSS\", \"KML\"];\r\n      if ((staticLayers.indexOf(this.lyrType) > -1 || !this.url) && lyr.graphics) {\r\n        this._getSourceFeatures(lyr.graphics);\r\n        this.clusterFeatures();\r\n      } else if (typeof (this.url) !== 'undefined') {\r\n        this.loadData(this.url);\r\n      } else {\r\n        q.where = (!this.showAllFeatures && this.filter) ? this.filter : \"1=1\";\r\n        q.outFields = ['*'];\r\n        q.returnGeometry = true;\r\n        if (lyr.queryFeatures) {\r\n          lyr.queryFeatures(q).then(lang.hitch(this, function (results) {\r\n            if (results.features) {\r\n              this._getSourceFeatures(results.features);\r\n              this.clusterFeatures();\r\n            }\r\n          }));\r\n        } else {\r\n          loading = \"error\";\r\n        }\r\n      }\r\n      if (loading !== \"error\") {\r\n        if (!this.extentChangeSignal) {\r\n          this.extentChangeSignal = this._map.on('extent-change', lang.hitch(this, this.handleMapExtentChange));\r\n        }\r\n        if (!this.clickSignal) {\r\n          this.clickSignal = this.on('click', lang.hitch(this, this.handleClick));\r\n        }\r\n      }\r\n    },\r\n\r\n    _getSourceFeatures: function (features) {\r\n      this._features = [];\r\n      for (var i = 0; i < features.length; i++) {\r\n        var g = features[i];\r\n        if (g.geometry) {\r\n          this._features.push(g);\r\n        }\r\n      }\r\n    },\r\n\r\n    //this is a duplicate of what's in settings...as the infoTemplate passed from settings was not being honored\r\n    // for MapServer sublayers...works fine without this for hosted layers\r\n    _getInfoTemplate: function (originOpLayer) {\r\n      var l;\r\n      if (originOpLayer.parentLayerInfo) {\r\n        l = originOpLayer.parentLayerInfo;\r\n      } else {\r\n        l = originOpLayer;\r\n      }\r\n      if (l.controlPopupInfo) {\r\n        var infoTemplates = l.controlPopupInfo.infoTemplates;\r\n        if (infoTemplates) {\r\n          if (this.url) {\r\n            var subLayerId = this.url.split(\"/\").pop();\r\n            if (subLayerId) {\r\n              if (infoTemplates.indexOf) {\r\n                if (infoTemplates.indexOf(subLayerId) > -1) {\r\n                  this.infoTemplate = infoTemplates[subLayerId].infoTemplate;\r\n                }\r\n              } else if (infoTemplates.hasOwnProperty(subLayerId)) {\r\n                this.infoTemplate = infoTemplates[subLayerId].infoTemplate;\r\n              }\r\n            }\r\n          }\r\n          this.setInfoTemplate(this.infoTemplate);\r\n        }\r\n      }\r\n    },\r\n\r\n    _setFieldNames: function () {\r\n      this._fieldNames = [];\r\n      //this will limit the fields to those fequired for the popup\r\n      if (this.infoTemplate) {\r\n        if (typeof (this.infoTemplate.info) !== 'undefined') {\r\n          var fieldInfos = this.infoTemplate.info.fieldInfos;\r\n          if (fieldInfos) {\r\n            for (var i = 0; i < fieldInfos.length; i++) {\r\n              if (fieldInfos[i].visible) {\r\n                this._fieldNames.push(fieldInfos[i].fieldName);\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n      if (this.symbolData.featureDisplayOptions) {\r\n        if (this.symbolData.featureDisplayOptions.fields.length > 0) {\r\n          for (var ii = 0; ii < this.symbolData.featureDisplayOptions.fields.length; ii++) {\r\n            var f = this.symbolData.featureDisplayOptions.fields[ii];\r\n            if (this._fieldNames.indexOf(f.name) === -1) {\r\n              this._fieldNames.push(f.name);\r\n            }\r\n          }\r\n        }\r\n      }\r\n      if (this._fieldNames.length < 1) {\r\n        //get all fields\r\n        this._fieldNames = [\"*\"];\r\n      }\r\n    },\r\n\r\n    setLayerInfo: function(lyrInfo){\r\n      this.lyrInfo = lyrInfo;\r\n    },\r\n\r\n    clearSingles: function (singles) {\r\n      // Summary:  Remove graphics that represent individual data points.\r\n      var s = singles || this._singles;\r\n      array.forEach(s, function (g) {\r\n        this.remove(g);\r\n      }, this);\r\n      this._singles.length = 0;\r\n    },\r\n\r\n    _getSingleGraphic: function (p) {\r\n      var g = new Graphic(\r\n        new Point(p.geometry.x, p.geometry.y, this._map.spatialReference),\r\n        null,\r\n        p.attributes\r\n      );\r\n      g.setSymbol(this._singleSym);\r\n      return g;\r\n    },\r\n\r\n    _addSingles: function (singles) {\r\n      array.forEach(singles, function (p) {\r\n        var g = this._getSingleGraphic(p);\r\n        this._singles.push(g);\r\n        if (this._showSingles) {\r\n          this.add(g);\r\n        }\r\n      }, this);\r\n      this._map.infoWindow.setFeatures(this._singles);\r\n    },\r\n\r\n    initalCount: function (url) {\r\n      if (!this.hidePanel) {\r\n        var q = new Query();\r\n        q.returnGeometry = false;\r\n        q.geometry = !this.showAllFeatures ? this._map.extent : null;\r\n        q.where = (!this.showAllFeatures && this.filter) ? this.filter : \"1=1\";\r\n        var qt = new QueryTask(url);\r\n        qt.executeForIds(q).then(lang.hitch(this, function (results) {\r\n          var updateNode;\r\n          if (this.node) {\r\n            if (domClass.contains(this.node, 'searching')) {\r\n              domClass.remove(this.node, 'searching');\r\n            }\r\n            this.node.innerHTML = results ? utils.localizeNumber(results.length) : 0;\r\n            updateNode = this.node.parentNode;\r\n          } else {\r\n            if (this.legendNode) {\r\n              updateNode = this.legendNode.previousSibling;\r\n            }\r\n          }\r\n          this.updateExpand(updateNode, results ? false : true);\r\n        }));\r\n      }\r\n    },\r\n\r\n    updateExpand: function (node, hide) {\r\n      if (!this.hidePanel) {\r\n        if (typeof (node) !== 'undefined') {\r\n          var id;\r\n          var en;\r\n          if (node.id.indexOf('rec_') > -1) {\r\n            id = node.id.replace('rec_', '');\r\n            en = dom.byId(\"exp_\" + id);\r\n          }\r\n          if (hide) {\r\n            if (node) {\r\n              html.addClass(node, \"recDefault\");\r\n              html.addClass(node, \"inActive\");\r\n            }\r\n            if (en) {\r\n              html.addClass(en, \"expandInActive\");\r\n            }\r\n          } else {\r\n            if (this.visible) {\r\n              if (node) {\r\n                html.removeClass(node, \"recDefault\");\r\n                html.removeClass(node, \"inActive\");\r\n              }\r\n              if (en) {\r\n                html.removeClass(en, \"expandInActive\");\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    },\r\n\r\n    loadData: function (url) {\r\n      if (url.length > 0) {\r\n        this.initalCount(url);\r\n        var q = new Query();\r\n        q.where = \"1=1\";\r\n        if (!this.showAllFeatures && this.filter) {\r\n          q.where = this.filter;\r\n        }\r\n        q.returnGeometry = false;\r\n        this.queryPending = true;\r\n        var qt = new QueryTask(url);\r\n        qt.executeForIds(q).then(lang.hitch(this, function (results) {\r\n          var max = this._parentLayer && this._parentLayer.maxRecordCount ? this._parentLayer.maxRecordCount : 1000;\r\n          if (results) {\r\n            this.queryIDs = results;\r\n            var queries = [];\r\n            var i, j;\r\n            for (i = 0, j = this.queryIDs.length; i < j; i += max) {\r\n              var ids = this.queryIDs.slice(i, i + max);\r\n\r\n              var _q = new Query();\r\n              _q.outFields = ['*'];\r\n              _q.objectIds = ids;\r\n              _q.returnGeometry = true;\r\n              _q.outSpatialReference = this._map.spatialReference;\r\n              var _qt = new QueryTask(url);\r\n              queries.push(_qt.execute(_q));\r\n            }\r\n\r\n            this._features = [];\r\n            if (!this.cancelRequest) {\r\n              var queryList = new DeferredList(queries);\r\n              queryList.then(lang.hitch(this, function (queryResults) {\r\n                this.queryPending = false;\r\n                if (!this.cancelRequest) {\r\n                  if (queryResults) {\r\n                    var sr = this._map.spatialReference;\r\n                    var fs = [];\r\n                    for (var i = 0; i < queryResults.length; i++) {\r\n                      if (queryResults[i][1].features) {\r\n                        for (var ii = 0; ii < queryResults[i][1].features.length; ii++) {\r\n                          var item = queryResults[i][1].features[ii];\r\n                          if (typeof (item.geometry) !== 'undefined' && item.geometry !== null && item.geometry) {\r\n                            var geom = new Point(item.geometry.x, item.geometry.y, sr);\r\n                            var gra = new Graphic(geom);\r\n                            gra.setAttributes(item.attributes);\r\n                            if (this.infoTemplate) {\r\n                              gra.setInfoTemplate(this.infoTemplate);\r\n                            }\r\n                            fs.push(gra);\r\n                          }\r\n                        }\r\n                      }\r\n                    }\r\n\r\n                    //TODO...figure out a better test here JSON.stringify does not like itwhen you have too many features\r\n                    //it fell over with 150,000 for sure have not really tested it out too far\r\n                    var shouldUpdate = true;\r\n                    if (fs < 10000) {\r\n                      shouldUpdate = JSON.stringify(this._features) !== JSON.stringify(fs);\r\n                    }\r\n                    if (shouldUpdate) {\r\n                      this.requiresReload = true;\r\n                      this._features = fs;\r\n                      this.clusterFeatures();\r\n\r\n                      this.emit(\"update-end\",{\r\n                        bubbles: true,\r\n                        cancelable: true\r\n                      });\r\n\r\n                    }\r\n                  }\r\n                } else {\r\n                  console.log(\"Cancelled ClusterLayer 2\");\r\n                }\r\n              }));\r\n            } else {\r\n              console.log(\"Cancelled ClusterLayer 1\");\r\n            }\r\n          }\r\n        }));\r\n      }\r\n    },\r\n\r\n    //click\r\n    handleClick: function (event) {\r\n      var singles = [];\r\n      if (event.graphic) {\r\n        var g = event.graphic;\r\n        if (g.attributes) {\r\n          var attr = g.attributes;\r\n          if (attr.Data && attr.Data.length > 1) {\r\n            this.clearSingles(this._singles);\r\n            singles = attr.Data;\r\n            event.stopPropagation();\r\n            this._addSingles(singles);\r\n          } else if (attr.Data && attr.Data.length === 1) {\r\n            attr.Data[0].symbol = g.symbol;\r\n            this._map.infoWindow.setFeatures([attr.Data[0]]);\r\n          } else {\r\n            this._map.infoWindow.setFeatures([g]);\r\n          }\r\n        }\r\n      }\r\n      if (this.infoTemplate) {\r\n        this._map.infoWindow.show(event.mapPoint);\r\n      }\r\n      dojoEvent.stop(event);\r\n    },\r\n\r\n    //re-cluster on extent change\r\n    handleMapExtentChange: function (event) {\r\n      if (event.levelChange) {\r\n        this.clusterFeatures();\r\n      } else if (event.delta) {\r\n        var delta = event.delta;\r\n        var dx = Math.abs(delta.x);\r\n        var dy = Math.abs(delta.y);\r\n        if (dx > 50 || dy > 50) {\r\n          this.clusterFeatures();\r\n        }\r\n      }\r\n    },\r\n\r\n    refreshFeatures: function (responseLayer) {\r\n      if (this.itemId) {\r\n        var responseFeatureSetFeatures = responseLayer.featureSet.features;\r\n        if (responseLayer.featureSet.transform) {\r\n          var fs = new FeatureSet(responseLayer.featureSet);\r\n          responseFeatureSetFeatures = fs.features;\r\n        }\r\n        if (typeof (this.updateFeatures) === 'undefined') {\r\n          this.updateFeatures = responseFeatureSetFeatures;\r\n        }\r\n        var shouldUpdate = true;\r\n        if (responseFeatureSetFeatures.length < 10000) {\r\n          shouldUpdate = JSON.stringify(this.updateFeatures) !== JSON.stringify(responseFeatureSetFeatures);\r\n        }\r\n\r\n        if (shouldUpdate) {\r\n          this.requiresReload = true;\r\n\r\n          //if valid response then clear and load\r\n          this._features = [];\r\n          this._parentLayer.clear();\r\n          var sr = this._parentLayer.spatialReference;\r\n          for (var ii = 0; ii < responseFeatureSetFeatures.length; ii++) {\r\n            var item = responseFeatureSetFeatures[ii];\r\n            if (item.geometry) {\r\n              var gra = new Graphic(this.getGraphicOptions(item, sr));\r\n              gra.setAttributes(item.attributes);\r\n              if (this.infoTemplate) {\r\n                gra.setInfoTemplate(this.infoTemplate);\r\n              }\r\n              //removed for https://devtopia.esri.com/WebGIS/arcgis-webappbuilder/issues/11551\r\n              //gra.setSymbol(r.getSymbol(gra));\r\n              this._parentLayer.add(gra);\r\n              this._features.push(gra);\r\n\r\n            } else {\r\n              console.log(\"Null geometry skipped\");\r\n            }\r\n          }\r\n          this.clusterFeatures();\r\n        }\r\n        this.updateFeatures = responseFeatureSetFeatures;\r\n      } else if (this.url) {\r\n        this.loadData(this.url);\r\n      }\r\n    },\r\n\r\n    getGraphicOptions: function (item, sr) {\r\n      var graphicOptions;\r\n      if (typeof (item.geometry.rings) !== 'undefined') {\r\n        graphicOptions = {\r\n          geometry: {\r\n            rings: item.geometry.rings,\r\n            \"spatialReference\": { \"wkid\": sr.wkid }\r\n          }\r\n        };\r\n      } else if (typeof (item.geometry.paths) !== 'undefined') {\r\n        graphicOptions = {\r\n          geometry: {\r\n            paths: item.geometry.paths,\r\n            \"spatialReference\": { \"wkid\": sr.wkid }\r\n          }\r\n        };\r\n      } else if (typeof (item.geometry.points) !== 'undefined') {\r\n        graphicOptions = {\r\n          geometry: {\r\n            points: item.geometry.points,\r\n            \"spatialReference\": { \"wkid\": sr.wkid }\r\n          }\r\n        };\r\n      } else {\r\n        graphicOptions = {\r\n          geometry: new Point(item.geometry.x, item.geometry.y, item.geometry.spatialReference)\r\n        };\r\n      }\r\n      return graphicOptions;\r\n    },\r\n\r\n    flashFeatures: function () {\r\n      this._map.graphics.clear();\r\n      this.flashGraphics(this.graphics);\r\n    },\r\n\r\n    flashSingle: function (graphic) {\r\n      if (typeof (graphic.symbol) === 'undefined') {\r\n        var cls2 = new SimpleLineSymbol(SimpleLineSymbol.STYLE_NULL, new Color(0, 0, 0, 0), 0);\r\n        var symColor = this.color.toRgb();\r\n        graphic.setSymbol(new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE, 9,\r\n          cls2, new Color([symColor[0], symColor[1], symColor[2], 0.5])));\r\n      }\r\n      this.flashGraphics([graphic]);\r\n    },\r\n\r\n    flashGraphics: function (graphics) {\r\n      for (var i = 0; i < graphics.length; i++) {\r\n        var g = graphics[i];\r\n        this._flashFeature(g);\r\n      }\r\n      setTimeout(lang.hitch(this, this._clearFeatures), 1100);\r\n    },\r\n\r\n    _flashFeature: function (feature) {\r\n      var symbol;\r\n      if (feature.geometry) {\r\n        var color = Color.fromHex(this._styleColor);\r\n        var color2 = lang.clone(color);\r\n        color2.a = 0.4;\r\n        if (typeof (feature.symbol) !== 'undefined') {\r\n          symbol = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE, feature.symbol.size,\r\n            new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,\r\n            color, 1),\r\n            color2);\r\n        }\r\n      }\r\n      if (typeof (symbol) !== 'undefined') {\r\n        var g = new Graphic(feature.geometry, symbol);\r\n        this._map.graphics.add(g);\r\n        var dShape = g.getDojoShape();\r\n        if (dShape) {\r\n          fx.animateStroke({\r\n            shape: dShape,\r\n            duration: 700,\r\n            color: {\r\n              start: dShape.strokeStyle.color,\r\n              end: dShape.strokeStyle.color\r\n            },\r\n            width: {\r\n              start: 18,\r\n              end: 0\r\n            }\r\n          }).play();\r\n          setTimeout(this._clearFeature, 850, g);\r\n        }\r\n      }\r\n    },\r\n\r\n    _clearFeatures: function () {\r\n      this._map.graphics.clear();\r\n    },\r\n\r\n    _clearFeature: function (f) {\r\n      var gl = f.getLayer();\r\n      gl.remove(f);\r\n    },\r\n\r\n    setColor: function (color) {\r\n      this.color = color;\r\n    },\r\n\r\n    setStyleColor: function(color){\r\n      this._styleColor = color;\r\n    },\r\n\r\n    cancelPendingRequests: function () {\r\n      console.log(\"Cancel Query...\");\r\n      if (this.queryPending) {\r\n        this.cancelRequest = true;\r\n      }\r\n      this.removeEventListeners();\r\n    },\r\n\r\n    removeEventListeners: function () {\r\n      if (this.extentChangeSignal) {\r\n        this.extentChangeSignal.remove();\r\n        this.extentChangeSignal = null;\r\n      }\r\n      if (this.clickSignal) {\r\n        this.clickSignal.remove();\r\n        this.clickSignal = null;\r\n      }\r\n    },\r\n\r\n    // cluster features\r\n    clusterFeatures: function () {\r\n      this.clear();\r\n      if (this._map === null) {\r\n        this._map = this._parent.map;\r\n      }\r\n      if (this._map.infoWindow.isShowing) {\r\n        this._map.infoWindow.hide();\r\n      }\r\n      var features = this._features;\r\n      var total = 0;\r\n      if (typeof (features) !== 'undefined') {\r\n        if (features.length > 0 && (this.visible || this.requiresReload)) {\r\n          var clusterSize = this.clusterSize;\r\n          this.clusterGraphics = [];\r\n          var sr = this._map.spatialReference;\r\n          var mapExt = this._map.extent;\r\n          var o = new Point(mapExt.xmin, mapExt.ymax, sr);\r\n\r\n          var rows = Math.ceil(this._map.height / clusterSize);\r\n          var cols = Math.ceil(this._map.width / clusterSize);\r\n          var distX = mapExt.getWidth() / this._map.width * clusterSize;\r\n          var distY = mapExt.getHeight() / this._map.height * clusterSize;\r\n\r\n          for (var r = 0; r < rows; r++) {\r\n            for (var c = 0; c < cols; c++) {\r\n              var x1 = o.x + (distX * c);\r\n              var y2 = o.y - (distY * r);\r\n              var x2 = x1 + distX;\r\n              var y1 = y2 - distY;\r\n\r\n              var ext = new Extent(x1, y1, x2, y2, sr);\r\n\r\n              var cGraphics = [];\r\n              for (var i in features) {\r\n                var feature = features[i];\r\n                if (ext.contains(feature.geometry)) {\r\n                  total += 1;\r\n                  cGraphics.push(feature);\r\n                }\r\n              }\r\n              if (cGraphics.length > 0) {\r\n                var cPt = this.getClusterCenter(cGraphics);\r\n                this.clusterGraphics.push({\r\n                  center: cPt,\r\n                  graphics: cGraphics\r\n                });\r\n              }\r\n            }\r\n          }\r\n\r\n          //add cluster to map\r\n          for (var g in this.clusterGraphics) {\r\n            var clusterGraphic = this.clusterGraphics[g];\r\n            var count = clusterGraphic.graphics.length;\r\n            var data = clusterGraphic.graphics;\r\n            var label = utils.localizeNumber(count);\r\n            var size = label.length * 19;\r\n            var size2 = size;\r\n            size += 5;\r\n\r\n            var fnt = new Font();\r\n            fnt.family = \"Arial\";\r\n            fnt.size = \"16px\";\r\n            var symText = new TextSymbol(label, fnt, this.countColor);\r\n            symText.setOffset(0, -4);\r\n\r\n            var testSize;\r\n            if (this.symbolData && this.symbolData.symbol) {\r\n              if (this.symbolData.symbol.size) {\r\n                testSize = this.symbolData.symbol.size;\r\n              } else if (this.symbolData.symbol.width) {\r\n                var w = this.symbolData.symbol.width;\r\n                var h = this.symbolData.symbol.height;\r\n                testSize = w >= h ? w : h;\r\n              }\r\n            } else if (this.icon.width) {\r\n              size = this.icon.width >= size ? this.icon.width + 5: size;\r\n              size = this.icon.height >= size ? this.icon.height + 5: size;\r\n              size2 = this.icon.width >= size2 ? this.icon.width + 1: size2;\r\n              size2 = this.icon.height >= size2 ? this.icon.height + 1: size2;\r\n            } else if (this.icon.size) {\r\n              testSize = this.icon.size;\r\n            }\r\n\r\n            if (testSize) {\r\n              size = testSize >= size ? testSize + 5 : size;\r\n              size2 = testSize >= size2 ? testSize + 1 : size2;\r\n            }\r\n\r\n            if (size2 >= size) {\r\n              size += size2 - size === 0 ? 4 : (size2 - size) + 5;\r\n            }\r\n\r\n            this._setSymbols(size + 15, size);\r\n\r\n            var attr = {\r\n              Count: count,\r\n              Data: data\r\n            };\r\n            if (count > 1) {\r\n              if (typeof (this.symbolData) !== 'undefined') {\r\n                if (this.symbolData.symbolType !== 'CustomSymbol') {\r\n                  this.add(new Graphic(clusterGraphic.center, this.csym, attr));\r\n                  if (this.displayFeatureCount) {\r\n                    this.add(new Graphic(clusterGraphic.center, symText, attr));\r\n                  } else {\r\n                    this.add(new Graphic(clusterGraphic.center, this.csym3, attr));\r\n                  }\r\n                } else {\r\n                  this.add(new Graphic(clusterGraphic.center, this.csym, attr));\r\n                  if (this.displayFeatureCount) {\r\n                    this.add(new Graphic(clusterGraphic.center, symText, attr));\r\n                  } else {\r\n                    this.add(new Graphic(clusterGraphic.center, this.psym, attr));\r\n                  }\r\n                }\r\n              } else {\r\n                this.add(new Graphic(clusterGraphic.center, this.csym, attr));\r\n                if (this.displayFeatureCount) {\r\n                  this.add(new Graphic(clusterGraphic.center, symText, attr));\r\n                } else {\r\n                  this.add(new Graphic(clusterGraphic.center, this.psym, attr));\r\n                }\r\n              }\r\n            } else {\r\n              var pt = clusterGraphic.graphics[0].geometry;\r\n              var _g;\r\n              if (this.renderer) {\r\n                if ((this.renderer.hasOwnProperty(\"getSymbol\") || this.renderer.hasOwnProperty(\"symbol\")) &&\r\n                this.symbolData.symbolType === \"LayerSymbol\") {\r\n                  _g = new Graphic(pt, null, attr.Data[0].attributes, this.infoTemplate);\r\n                } else if (this.symbolData.symbolType === \"EsriSymbol\") {\r\n                  _g = new Graphic(pt, jsonUtils.fromJson(this.symbolData.symbol), attr, this.infoTemplate);\r\n                } else if (this.symbolData.symbolType !== \"LayerSymbol\") {\r\n                  _g = new Graphic(pt, this.psym, attr, this.infoTemplate);\r\n                } else {\r\n                  if (this.renderer.symbol) {\r\n                    _g = new Graphic(pt, null, attr, this.infoTemplate);\r\n                  } else {\r\n                    _g = new Graphic(pt, this.psym, attr, this.infoTemplate);\r\n                  }\r\n                }\r\n                if (typeof (_g) !== 'undefined') {\r\n                  this.add(_g);\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n        this._updateNode(this.showAllFeatures ? features.length : total);\r\n      }\r\n    },\r\n\r\n    _updateNode: function (total) {\r\n      if (!this.hidePanel) {\r\n        var updateNode;\r\n        if (this.node) {\r\n          this.node.innerHTML = utils.localizeNumber(total ? total : 0);\r\n          updateNode = this.node.parentNode;\r\n        } else {\r\n          if (this.legendNode) {\r\n            updateNode = this.legendNode.previousSibling;\r\n          }\r\n        }\r\n        this.updateExpand(updateNode, (total && total > 0) && this.visible ? false : true);\r\n      }\r\n    },\r\n\r\n    _setSymbols: function (size, size2) {\r\n      var symColor = this.color.toRgb();\r\n      var fsp;\r\n      var style;\r\n      var lineWidth;\r\n      if (typeof (this.symbolData) !== 'undefined') {\r\n        var c;\r\n        //need to make a marker from the fill properties\r\n        if (this.backgroundClusterSymbol === \"custom\") {\r\n          c = symColor;\r\n        } else {\r\n          fsp = jsonUtils.fromJson(this.backgroundClusterSymbol);\r\n\r\n          if (fsp.outline.color.a === 0 || fsp.outline.width === 0) {\r\n            style = SimpleLineSymbol.STYLE_NULL;\r\n            lineWidth = 0;\r\n          } else {\r\n            style = SimpleLineSymbol.STYLE_SOLID;\r\n            lineWidth = fsp.outline.width;\r\n          }\r\n        }\r\n\r\n        if (fsp) {\r\n          var cls = SimpleLineSymbol(style, fsp.outline.color, lineWidth);\r\n          c = fsp.color.toRgb();\r\n          this.csym = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE,\r\n            size, cls, new Color([c[0], c[1], c[2], 0.75]));\r\n        } else {\r\n          this.csym = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE,\r\n            size, null, new Color([c[0], c[1], c[2], 0.75]));\r\n        }\r\n\r\n        var path = this.symbolData.s;\r\n        if (path && path.indexOf(\"${appPath}\") > -1) {\r\n          var pathName = window.location.pathname.replace('index.html', '');\r\n          path = this.symbolData.s.replace(\"${appPath}\", window.location.origin + pathName);\r\n        } else if (this.symbolData.s) {\r\n          path = this.symbolData.s;\r\n        } else {\r\n          path = this.icon.imageData;\r\n        }\r\n        if (path && this.symbolData.iconType === \"CustomIcon\") {\r\n          var _h, _w;\r\n          if (this.symbolData.symbol && this.symbolData.symbol.height) {\r\n            _h = this.symbolData.symbol.height;\r\n          }\r\n          if (this.symbolData.symbol && this.symbolData.symbol.width) {\r\n            _w = this.symbolData.symbol.width;\r\n          }\r\n          if (_h && _w) {\r\n            _h = _w > _h ? _w : _h;\r\n            _w = _h;\r\n          } else {\r\n            _h = this.symbolData.icon.height ? this.symbolData.icon.height : size2;\r\n            _w = this.symbolData.icon.width ? this.symbolData.icon.width : size2;\r\n          }\r\n          this.psym = new PictureMarkerSymbol(path, _h, _w);\r\n        } else if (path && this.symbolData.iconType === \"LayerIcon\") {\r\n          this.psym = jsonUtils.fromJson(this.symbolData.symbol);\r\n        } else {\r\n          if (this.icon.type === 'esriPMS') {\r\n            this.psym = this.icon;\r\n          } else {\r\n            var sls = SimpleLineSymbol(this.icon.outline.style,\r\n              this.icon.outline.color, this.icon.outline.width);\r\n            this.psym = new SimpleMarkerSymbol(this.icon.style, this.icon.size,\r\n              sls, this.icon.color);\r\n          }\r\n        }\r\n\r\n        //options for cluster with 1\r\n        this.csym2 = lang.clone(this.psym);\r\n        this.csym3 = lang.clone(this.csym2);\r\n        if (typeof (this.csym2.xoffset) !== 'undefined') {\r\n          this.csym3.xoffset = 0;\r\n        }\r\n        if (typeof (this.csym2.yoffset) !== 'undefined') {\r\n          this.csym3.yoffset = 0;\r\n        }\r\n      } else {\r\n        //options for cluster with more than 1\r\n        var cls1 = new SimpleLineSymbol(SimpleLineSymbol.STYLE_NULL,\r\n          new Color(0, 0, 0, 0), 0);\r\n        this.csym = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE, size,\r\n          cls1, new Color([symColor[0], symColor[1], symColor[2], 0.5]));\r\n        this.psym = new PictureMarkerSymbol(this.icon.url, size - 10, size - 10);\r\n\r\n        //options for cluster with 1\r\n        this.psym2 = new PictureMarkerSymbol(this.icon.url, size2 - 7, size2 - 7);\r\n        var cls2 = new SimpleLineSymbol(SimpleLineSymbol.STYLE_NULL, new Color(0, 0, 0, 0), 0);\r\n        this.csym2 = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE, size2,\r\n          cls2, new Color([symColor[0], symColor[1], symColor[2], 0.5]));\r\n      }\r\n    },\r\n\r\n    _setupSymbols: function () {\r\n      if (typeof (this.symbolData) !== 'undefined') {\r\n        this.countColor = this.symbolData._highLightColor;\r\n        this.backgroundClusterSymbol = this.symbolData.clusterSymbol;\r\n        this.icon = this.symbolData.icon;\r\n        if (this.symbolData.symbolType === \"LayerSymbol\") {\r\n          if (this._parentLayer.renderer) {\r\n            if (this._parentLayer.renderer.toJson) {\r\n              this.renderer = this._parentLayer.renderer;\r\n            } else {\r\n              this.renderer = renderUtils.fromJson(this._parentLayer.renderer);\r\n            }\r\n          } else if (this._testRenderer) {\r\n            this.renderer = renderUtils.fromJson(this._testRenderer);\r\n          } else if (this.symbolData.renderer) {\r\n            if (this.symbolData.renderer.toJson) {\r\n              this.renderer = this.symbolData.renderer;\r\n            } else {\r\n              this.renderer = renderUtils.fromJson(this.symbolData.renderer);\r\n            }\r\n          }\r\n        } else {\r\n          this.renderer = new SimpleRenderer(jsonUtils.fromJson(this.symbolData.symbol));\r\n        }\r\n        var symColor = this.color.toRgb();\r\n        var cls = new SimpleLineSymbol(SimpleLineSymbol.STYLE_NULL, new Color(0, 0, 0, 0), 0);\r\n        this._singleSym = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE, 9, cls,\r\n          new Color([symColor[0], symColor[1], symColor[2], 0.5]));\r\n      }\r\n    },\r\n\r\n    getLayer: function(){\r\n      return this;\r\n    },\r\n\r\n    getClusterCenter: function (graphics) {\r\n      var xSum = 0;\r\n      var ySum = 0;\r\n      var count = graphics.length;\r\n      array.forEach(graphics, function (graphic) {\r\n        xSum += graphic.geometry.x;\r\n        ySum += graphic.geometry.y;\r\n      }, this);\r\n      var cPt = new Point(xSum / count, ySum / count, graphics[0].geometry.spatialReference);\r\n      return cPt;\r\n    },\r\n\r\n    destroy: function () {\r\n      this._clear();\r\n      this.removeEventListeners();\r\n    },\r\n\r\n    _clear: function () {\r\n      this.clear();\r\n      this._features = [];\r\n    },\r\n\r\n    _updateEnd: function () {\r\n      if (this.url) {\r\n        this.loadData(this.url);\r\n      }\r\n    }\r\n\r\n  });\r\n\r\n  return clusterLayer;\r\n});\r\n"]}