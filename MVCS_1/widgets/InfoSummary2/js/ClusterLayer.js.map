{"version":3,"sources":["../../../../widgets/InfoSummary2/js/ClusterLayer.js"],"names":["define","declare","array","dojoEvent","lang","Color","html","DeferredList","domClass","dom","fx","on","Evented","utils","GraphicsLayer","Graphic","Extent","Point","PictureMarkerSymbol","SimpleMarkerSymbol","SimpleLineSymbol","TextSymbol","Font","SimpleRenderer","Query","QueryTask","FeatureSet","jsonUtils","renderUtils","FeatureLayer","clusterLayer","constructor","options","clusterGraphics","cancelRequest","clusterSize","_singles","_showSingles","updateFeatures","undefined","hidePanel","_parent","_parentLayer","parentLayer","objectIdField","fields","name","_map","map","color","fromString","_styleColor","symbolData","lyrInfo","countColor","_highLightColor","itemId","refresh","displayFeatureCount","node","countEnabled","legendNode","id","infoTemplate","url","_testRenderer","renderer","originOperLayer","_getInfoTemplate","lyrType","filter","showAllFeatures","listDisabled","selfType","_setupSymbols","_setFieldNames","countFeatures","refreshInterval","setInterval","hitch","_updateEnd","lyr","q","geometry","extent","fullExtent","queryCount","r","nodeCount","_initFeatures","fl","_features","loading","staticLayers","indexOf","graphics","_getSourceFeatures","clusterFeatures","loadData","where","outFields","returnGeometry","queryFeatures","then","results","features","extentChangeSignal","handleMapExtentChange","clickSignal","handleClick","i","length","g","push","originOpLayer","l","parentLayerInfo","controlPopupInfo","infoTemplates","subLayerId","split","pop","hasOwnProperty","setInfoTemplate","_fieldNames","info","fieldInfos","visible","fieldName","featureDisplayOptions","ii","f","setLayerInfo","clearSingles","singles","s","forEach","remove","_getSingleGraphic","p","x","y","spatialReference","attributes","setSymbol","_singleSym","_addSingles","add","infoWindow","setFeatures","initalCount","qt","executeForIds","updateNode","contains","innerHTML","localizeNumber","parentNode","previousSibling","updateExpand","hide","en","replace","byId","addClass","removeClass","queryPending","max","maxRecordCount","queryIDs","queries","j","ids","slice","_q","objectIds","outSpatialReference","_qt","execute","queryList","queryResults","sr","fs","item","geom","gra","setAttributes","shouldUpdate","JSON","stringify","requiresReload","emit","bubbles","cancelable","console","log","event","graphic","attr","Data","stopPropagation","symbol","show","mapPoint","stop","levelChange","delta","dx","Math","abs","dy","refreshFeatures","responseLayer","responseFeatureSetFeatures","featureSet","transform","clear","getGraphicOptions","graphicOptions","rings","wkid","paths","points","flashFeatures","flashGraphics","flashSingle","cls2","STYLE_NULL","symColor","toRgb","STYLE_CIRCLE","_flashFeature","setTimeout","_clearFeatures","feature","fromHex","color2","clone","a","size","STYLE_SOLID","dShape","getDojoShape","animateStroke","shape","duration","start","strokeStyle","end","width","play","_clearFeature","gl","getLayer","setColor","setStyleColor","cancelPendingRequests","removeEventListeners","isShowing","total","mapExt","o","xmin","ymax","rows","ceil","height","cols","distX","getWidth","distY","getHeight","c","x1","y2","x2","y1","ext","cGraphics","cPt","getClusterCenter","center","clusterGraphic","count","data","label","size2","fnt","family","symText","setOffset","testSize","w","h","icon","_setSymbols","Count","symbolType","csym","csym3","psym","pt","_g","fromJson","_updateNode","fsp","style","lineWidth","backgroundClusterSymbol","outline","cls","path","pathName","window","location","pathname","origin","imageData","iconType","_h","_w","type","sls","csym2","xoffset","yoffset","cls1","psym2","clusterSymbol","toJson","xSum","ySum","destroy","_clear"],"mappings":"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","file":"ClusterLayer.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\n// Copyright © 2014 - 2018 Esri. All Rights Reserved.\n//\n// Licensed under the Apache License Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//    http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n///////////////////////////////////////////////////////////////////////////\n\ndefine(['dojo/_base/declare', 'dojo/_base/array', 'dojo/_base/event', 'dojo/_base/lang', 'dojo/_base/Color', 'dojo/_base/html', 'dojo/DeferredList', 'dojo/dom-class', 'dojo/dom', 'dojox/gfx/fx', 'dojo/on', 'dojo/Evented', 'jimu/utils', 'esri/layers/GraphicsLayer', 'esri/graphic', 'esri/geometry/Extent', 'esri/geometry/Point', 'esri/symbols/PictureMarkerSymbol', 'esri/symbols/SimpleMarkerSymbol', 'esri/symbols/SimpleLineSymbol', 'esri/symbols/TextSymbol', 'esri/symbols/Font', 'esri/renderers/SimpleRenderer', 'esri/tasks/query', 'esri/tasks/QueryTask', 'esri/tasks/FeatureSet', 'esri/symbols/jsonUtils', 'esri/renderers/jsonUtils', 'esri/layers/FeatureLayer'], function (declare, array, dojoEvent, lang, Color, html, DeferredList, domClass, dom, fx, on, Evented, utils, GraphicsLayer, Graphic, Extent, Point, PictureMarkerSymbol, SimpleMarkerSymbol, SimpleLineSymbol, TextSymbol, Font, SimpleRenderer, Query, QueryTask, FeatureSet, jsonUtils, renderUtils, FeatureLayer) {\n  var clusterLayer = declare('ClusterLayer', [GraphicsLayer, Evented], {\n    //TODO change size breaks to equal interval eg. breaks = (max - min) / numRanges;\n    constructor: function constructor(options) {\n      //Defaults\n      this.clusterGraphics = [];\n      this.cancelRequest = false;\n      this.clusterSize = 120;\n      this._singles = [];\n      this._showSingles = true;\n      this.updateFeatures = undefined;\n\n      //Options\n      this.hidePanel = options.hidePanel;\n      this._parent = options._parent;\n      this._parentLayer = options.parentLayer;\n      if (this._parentLayer) {\n        this.objectIdField = this._parentLayer.objectIdField;\n        this.fields = this._parentLayer.fields;\n      }\n      this.name = options.name;\n      this._map = options.map;\n      this.color = Color.fromString(options.color || '#ff0000');\n      this._styleColor = options._styleColor;\n      this.symbolData = options.lyrInfo.symbolData;\n      this.countColor = this.symbolData._highLightColor;\n      this.itemId = options.lyrInfo.itemId;\n      this.refresh = options.lyrInfo.refresh;\n      this.displayFeatureCount = this.symbolData.displayFeatureCount;\n      this.node = options.node;\n      this.countEnabled = options.countEnabled;\n      this.legendNode = options.legendNode;\n      this.id = options.id;\n      this.infoTemplate = options.infoTemplate;\n      this.url = options.lyrInfo.url;\n      this._testRenderer = options.lyrInfo.renderer;\n      this.originOperLayer = options.originOperLayer;\n      if (this.originOperLayer) {\n        this._getInfoTemplate(this.originOperLayer);\n      }\n      this.lyrInfo = options.lyrInfo;\n      this.lyrType = options.lyrType;\n      this.filter = options.filter;\n      this.showAllFeatures = options.showAllFeatures;\n      this.listDisabled = options.listDisabled;\n      this.selfType = options.selfType;\n\n      this._setupSymbols();\n      this._setFieldNames();\n      this.countFeatures(this._parentLayer);\n\n      if (this._parentLayer.refreshInterval > 0) {\n        setInterval(lang.hitch(this, this._updateEnd), this._parentLayer.refreshInterval * 60000);\n      }\n    },\n\n    countFeatures: function countFeatures(lyr) {\n      //Query the features based on map extent for supported layer types\n      var q = new Query();\n      q.geometry = !this.showAllFeatures ? this._map.extent : lyr.fullExtent;\n      if (lyr.queryCount) {\n        lyr.queryCount(q, lang.hitch(this, function (r) {\n          if (r > 0) {\n            //Feature collection layers with no features\n            // throw an error that I can't seem to catch when you\n            //apply a where clause such as \"1=1\"\n            if (!this.hidePanel) {\n              this.nodeCount = r;\n            }\n            this._initFeatures(this._parentLayer);\n          } else {\n            if (!this.hidePanel) {\n              this.nodeCount = 0;\n              if (lyr.url) {\n                var fl = new FeatureLayer(lyr.url);\n                on(fl, \"load\", lang.hitch(this, function () {\n                  this.countFeatures(fl);\n                }));\n              } else {\n                this._initFeatures(this._parentLayer);\n              }\n            }\n          }\n        }));\n      } else {\n        this._initFeatures(this._parentLayer);\n      }\n    },\n\n    _initFeatures: function _initFeatures(lyr) {\n      this._features = [];\n      var loading = true;\n      var q = new Query();\n      var staticLayers = [\"CSV\", \"Feature Collection\", \"GeoRSS\", \"KML\"];\n      if ((staticLayers.indexOf(this.lyrType) > -1 || !this.url) && lyr.graphics) {\n        this._getSourceFeatures(lyr.graphics);\n        this.clusterFeatures();\n      } else if (typeof this.url !== 'undefined') {\n        this.loadData(this.url);\n      } else {\n        q.where = !this.showAllFeatures && this.filter ? this.filter : \"1=1\";\n        q.outFields = ['*'];\n        q.returnGeometry = true;\n        if (lyr.queryFeatures) {\n          lyr.queryFeatures(q).then(lang.hitch(this, function (results) {\n            if (results.features) {\n              this._getSourceFeatures(results.features);\n              this.clusterFeatures();\n            }\n          }));\n        } else {\n          loading = \"error\";\n        }\n      }\n      if (loading !== \"error\") {\n        if (!this.extentChangeSignal) {\n          this.extentChangeSignal = this._map.on('extent-change', lang.hitch(this, this.handleMapExtentChange));\n        }\n        if (!this.clickSignal) {\n          this.clickSignal = this.on('click', lang.hitch(this, this.handleClick));\n        }\n      }\n    },\n\n    _getSourceFeatures: function _getSourceFeatures(features) {\n      this._features = [];\n      for (var i = 0; i < features.length; i++) {\n        var g = features[i];\n        if (g.geometry) {\n          this._features.push(g);\n        }\n      }\n    },\n\n    //this is a duplicate of what's in settings...as the infoTemplate passed from settings was not being honored\n    // for MapServer sublayers...works fine without this for hosted layers\n    _getInfoTemplate: function _getInfoTemplate(originOpLayer) {\n      var l;\n      if (originOpLayer.parentLayerInfo) {\n        l = originOpLayer.parentLayerInfo;\n      } else {\n        l = originOpLayer;\n      }\n      if (l.controlPopupInfo) {\n        var infoTemplates = l.controlPopupInfo.infoTemplates;\n        if (infoTemplates) {\n          if (this.url) {\n            var subLayerId = this.url.split(\"/\").pop();\n            if (subLayerId) {\n              if (infoTemplates.indexOf) {\n                if (infoTemplates.indexOf(subLayerId) > -1) {\n                  this.infoTemplate = infoTemplates[subLayerId].infoTemplate;\n                }\n              } else if (infoTemplates.hasOwnProperty(subLayerId)) {\n                this.infoTemplate = infoTemplates[subLayerId].infoTemplate;\n              }\n            }\n          }\n          this.setInfoTemplate(this.infoTemplate);\n        }\n      }\n    },\n\n    _setFieldNames: function _setFieldNames() {\n      this._fieldNames = [];\n      //this will limit the fields to those fequired for the popup\n      if (this.infoTemplate) {\n        if (typeof this.infoTemplate.info !== 'undefined') {\n          var fieldInfos = this.infoTemplate.info.fieldInfos;\n          if (fieldInfos) {\n            for (var i = 0; i < fieldInfos.length; i++) {\n              if (fieldInfos[i].visible) {\n                this._fieldNames.push(fieldInfos[i].fieldName);\n              }\n            }\n          }\n        }\n      }\n      if (this.symbolData.featureDisplayOptions) {\n        if (this.symbolData.featureDisplayOptions.fields.length > 0) {\n          for (var ii = 0; ii < this.symbolData.featureDisplayOptions.fields.length; ii++) {\n            var f = this.symbolData.featureDisplayOptions.fields[ii];\n            if (this._fieldNames.indexOf(f.name) === -1) {\n              this._fieldNames.push(f.name);\n            }\n          }\n        }\n      }\n      if (this._fieldNames.length < 1) {\n        //get all fields\n        this._fieldNames = [\"*\"];\n      }\n    },\n\n    setLayerInfo: function setLayerInfo(lyrInfo) {\n      this.lyrInfo = lyrInfo;\n    },\n\n    clearSingles: function clearSingles(singles) {\n      // Summary:  Remove graphics that represent individual data points.\n      var s = singles || this._singles;\n      array.forEach(s, function (g) {\n        this.remove(g);\n      }, this);\n      this._singles.length = 0;\n    },\n\n    _getSingleGraphic: function _getSingleGraphic(p) {\n      var g = new Graphic(new Point(p.geometry.x, p.geometry.y, this._map.spatialReference), null, p.attributes);\n      g.setSymbol(this._singleSym);\n      return g;\n    },\n\n    _addSingles: function _addSingles(singles) {\n      array.forEach(singles, function (p) {\n        var g = this._getSingleGraphic(p);\n        this._singles.push(g);\n        if (this._showSingles) {\n          this.add(g);\n        }\n      }, this);\n      this._map.infoWindow.setFeatures(this._singles);\n    },\n\n    initalCount: function initalCount(url) {\n      if (!this.hidePanel) {\n        var q = new Query();\n        q.returnGeometry = false;\n        q.geometry = !this.showAllFeatures ? this._map.extent : null;\n        q.where = !this.showAllFeatures && this.filter ? this.filter : \"1=1\";\n        var qt = new QueryTask(url);\n        qt.executeForIds(q).then(lang.hitch(this, function (results) {\n          var updateNode;\n          if (this.node) {\n            if (domClass.contains(this.node, 'searching')) {\n              domClass.remove(this.node, 'searching');\n            }\n            this.node.innerHTML = results ? utils.localizeNumber(results.length) : 0;\n            updateNode = this.node.parentNode;\n          } else {\n            if (this.legendNode) {\n              updateNode = this.legendNode.previousSibling;\n            }\n          }\n          this.updateExpand(updateNode, results ? false : true);\n        }));\n      }\n    },\n\n    updateExpand: function updateExpand(node, hide) {\n      if (!this.hidePanel) {\n        if (typeof node !== 'undefined') {\n          var id;\n          var en;\n          if (node.id.indexOf('rec_') > -1) {\n            id = node.id.replace('rec_', '');\n            en = dom.byId(\"exp_\" + id);\n          }\n          if (hide) {\n            if (node) {\n              html.addClass(node, \"recDefault\");\n              html.addClass(node, \"inActive\");\n            }\n            if (en) {\n              html.addClass(en, \"expandInActive\");\n            }\n          } else {\n            if (this.visible) {\n              if (node) {\n                html.removeClass(node, \"recDefault\");\n                html.removeClass(node, \"inActive\");\n              }\n              if (en) {\n                html.removeClass(en, \"expandInActive\");\n              }\n            }\n          }\n        }\n      }\n    },\n\n    loadData: function loadData(url) {\n      if (url.length > 0) {\n        this.initalCount(url);\n        var q = new Query();\n        q.where = \"1=1\";\n        if (!this.showAllFeatures && this.filter) {\n          q.where = this.filter;\n        }\n        q.returnGeometry = false;\n        this.queryPending = true;\n        var qt = new QueryTask(url);\n        qt.executeForIds(q).then(lang.hitch(this, function (results) {\n          var max = this._parentLayer && this._parentLayer.maxRecordCount ? this._parentLayer.maxRecordCount : 1000;\n          if (results) {\n            this.queryIDs = results;\n            var queries = [];\n            var i, j;\n            for (i = 0, j = this.queryIDs.length; i < j; i += max) {\n              var ids = this.queryIDs.slice(i, i + max);\n\n              var _q = new Query();\n              _q.outFields = ['*'];\n              _q.objectIds = ids;\n              _q.returnGeometry = true;\n              _q.outSpatialReference = this._map.spatialReference;\n              var _qt = new QueryTask(url);\n              queries.push(_qt.execute(_q));\n            }\n\n            this._features = [];\n            if (!this.cancelRequest) {\n              var queryList = new DeferredList(queries);\n              queryList.then(lang.hitch(this, function (queryResults) {\n                this.queryPending = false;\n                if (!this.cancelRequest) {\n                  if (queryResults) {\n                    var sr = this._map.spatialReference;\n                    var fs = [];\n                    for (var i = 0; i < queryResults.length; i++) {\n                      if (queryResults[i][1].features) {\n                        for (var ii = 0; ii < queryResults[i][1].features.length; ii++) {\n                          var item = queryResults[i][1].features[ii];\n                          if (typeof item.geometry !== 'undefined' && item.geometry !== null && item.geometry) {\n                            var geom = new Point(item.geometry.x, item.geometry.y, sr);\n                            var gra = new Graphic(geom);\n                            gra.setAttributes(item.attributes);\n                            if (this.infoTemplate) {\n                              gra.setInfoTemplate(this.infoTemplate);\n                            }\n                            fs.push(gra);\n                          }\n                        }\n                      }\n                    }\n\n                    //TODO...figure out a better test here JSON.stringify does not like itwhen you have too many features\n                    //it fell over with 150,000 for sure have not really tested it out too far\n                    var shouldUpdate = true;\n                    if (fs < 10000) {\n                      shouldUpdate = JSON.stringify(this._features) !== JSON.stringify(fs);\n                    }\n                    if (shouldUpdate) {\n                      this.requiresReload = true;\n                      this._features = fs;\n                      this.clusterFeatures();\n\n                      this.emit(\"update-end\", {\n                        bubbles: true,\n                        cancelable: true\n                      });\n                    }\n                  }\n                } else {\n                  console.log(\"Cancelled ClusterLayer 2\");\n                }\n              }));\n            } else {\n              console.log(\"Cancelled ClusterLayer 1\");\n            }\n          }\n        }));\n      }\n    },\n\n    //click\n    handleClick: function handleClick(event) {\n      var singles = [];\n      if (event.graphic) {\n        var g = event.graphic;\n        if (g.attributes) {\n          var attr = g.attributes;\n          if (attr.Data && attr.Data.length > 1) {\n            this.clearSingles(this._singles);\n            singles = attr.Data;\n            event.stopPropagation();\n            this._addSingles(singles);\n          } else if (attr.Data && attr.Data.length === 1) {\n            attr.Data[0].symbol = g.symbol;\n            this._map.infoWindow.setFeatures([attr.Data[0]]);\n          } else {\n            this._map.infoWindow.setFeatures([g]);\n          }\n        }\n      }\n      if (this.infoTemplate) {\n        this._map.infoWindow.show(event.mapPoint);\n      }\n      dojoEvent.stop(event);\n    },\n\n    //re-cluster on extent change\n    handleMapExtentChange: function handleMapExtentChange(event) {\n      if (event.levelChange) {\n        this.clusterFeatures();\n      } else if (event.delta) {\n        var delta = event.delta;\n        var dx = Math.abs(delta.x);\n        var dy = Math.abs(delta.y);\n        if (dx > 50 || dy > 50) {\n          this.clusterFeatures();\n        }\n      }\n    },\n\n    refreshFeatures: function refreshFeatures(responseLayer) {\n      if (this.itemId) {\n        var responseFeatureSetFeatures = responseLayer.featureSet.features;\n        if (responseLayer.featureSet.transform) {\n          var fs = new FeatureSet(responseLayer.featureSet);\n          responseFeatureSetFeatures = fs.features;\n        }\n        if (typeof this.updateFeatures === 'undefined') {\n          this.updateFeatures = responseFeatureSetFeatures;\n        }\n        var shouldUpdate = true;\n        if (responseFeatureSetFeatures.length < 10000) {\n          shouldUpdate = JSON.stringify(this.updateFeatures) !== JSON.stringify(responseFeatureSetFeatures);\n        }\n\n        if (shouldUpdate) {\n          this.requiresReload = true;\n\n          //if valid response then clear and load\n          this._features = [];\n          this._parentLayer.clear();\n          var sr = this._parentLayer.spatialReference;\n          for (var ii = 0; ii < responseFeatureSetFeatures.length; ii++) {\n            var item = responseFeatureSetFeatures[ii];\n            if (item.geometry) {\n              var gra = new Graphic(this.getGraphicOptions(item, sr));\n              gra.setAttributes(item.attributes);\n              if (this.infoTemplate) {\n                gra.setInfoTemplate(this.infoTemplate);\n              }\n              //removed for https://devtopia.esri.com/WebGIS/arcgis-webappbuilder/issues/11551\n              //gra.setSymbol(r.getSymbol(gra));\n              this._parentLayer.add(gra);\n              this._features.push(gra);\n            } else {\n              console.log(\"Null geometry skipped\");\n            }\n          }\n          this.clusterFeatures();\n        }\n        this.updateFeatures = responseFeatureSetFeatures;\n      } else if (this.url) {\n        this.loadData(this.url);\n      }\n    },\n\n    getGraphicOptions: function getGraphicOptions(item, sr) {\n      var graphicOptions;\n      if (typeof item.geometry.rings !== 'undefined') {\n        graphicOptions = {\n          geometry: {\n            rings: item.geometry.rings,\n            \"spatialReference\": { \"wkid\": sr.wkid }\n          }\n        };\n      } else if (typeof item.geometry.paths !== 'undefined') {\n        graphicOptions = {\n          geometry: {\n            paths: item.geometry.paths,\n            \"spatialReference\": { \"wkid\": sr.wkid }\n          }\n        };\n      } else if (typeof item.geometry.points !== 'undefined') {\n        graphicOptions = {\n          geometry: {\n            points: item.geometry.points,\n            \"spatialReference\": { \"wkid\": sr.wkid }\n          }\n        };\n      } else {\n        graphicOptions = {\n          geometry: new Point(item.geometry.x, item.geometry.y, item.geometry.spatialReference)\n        };\n      }\n      return graphicOptions;\n    },\n\n    flashFeatures: function flashFeatures() {\n      this._map.graphics.clear();\n      this.flashGraphics(this.graphics);\n    },\n\n    flashSingle: function flashSingle(graphic) {\n      if (typeof graphic.symbol === 'undefined') {\n        var cls2 = new SimpleLineSymbol(SimpleLineSymbol.STYLE_NULL, new Color(0, 0, 0, 0), 0);\n        var symColor = this.color.toRgb();\n        graphic.setSymbol(new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE, 9, cls2, new Color([symColor[0], symColor[1], symColor[2], 0.5])));\n      }\n      this.flashGraphics([graphic]);\n    },\n\n    flashGraphics: function flashGraphics(graphics) {\n      for (var i = 0; i < graphics.length; i++) {\n        var g = graphics[i];\n        this._flashFeature(g);\n      }\n      setTimeout(lang.hitch(this, this._clearFeatures), 1100);\n    },\n\n    _flashFeature: function _flashFeature(feature) {\n      var symbol;\n      if (feature.geometry) {\n        var color = Color.fromHex(this._styleColor);\n        var color2 = lang.clone(color);\n        color2.a = 0.4;\n        if (typeof feature.symbol !== 'undefined') {\n          symbol = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE, feature.symbol.size, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, color, 1), color2);\n        }\n      }\n      if (typeof symbol !== 'undefined') {\n        var g = new Graphic(feature.geometry, symbol);\n        this._map.graphics.add(g);\n        var dShape = g.getDojoShape();\n        if (dShape) {\n          fx.animateStroke({\n            shape: dShape,\n            duration: 700,\n            color: {\n              start: dShape.strokeStyle.color,\n              end: dShape.strokeStyle.color\n            },\n            width: {\n              start: 18,\n              end: 0\n            }\n          }).play();\n          setTimeout(this._clearFeature, 850, g);\n        }\n      }\n    },\n\n    _clearFeatures: function _clearFeatures() {\n      this._map.graphics.clear();\n    },\n\n    _clearFeature: function _clearFeature(f) {\n      var gl = f.getLayer();\n      gl.remove(f);\n    },\n\n    setColor: function setColor(color) {\n      this.color = color;\n    },\n\n    setStyleColor: function setStyleColor(color) {\n      this._styleColor = color;\n    },\n\n    cancelPendingRequests: function cancelPendingRequests() {\n      console.log(\"Cancel Query...\");\n      if (this.queryPending) {\n        this.cancelRequest = true;\n      }\n      this.removeEventListeners();\n    },\n\n    removeEventListeners: function removeEventListeners() {\n      if (this.extentChangeSignal) {\n        this.extentChangeSignal.remove();\n        this.extentChangeSignal = null;\n      }\n      if (this.clickSignal) {\n        this.clickSignal.remove();\n        this.clickSignal = null;\n      }\n    },\n\n    // cluster features\n    clusterFeatures: function clusterFeatures() {\n      this.clear();\n      if (this._map === null) {\n        this._map = this._parent.map;\n      }\n      if (this._map.infoWindow.isShowing) {\n        this._map.infoWindow.hide();\n      }\n      var features = this._features;\n      var total = 0;\n      if (typeof features !== 'undefined') {\n        if (features.length > 0 && (this.visible || this.requiresReload)) {\n          var clusterSize = this.clusterSize;\n          this.clusterGraphics = [];\n          var sr = this._map.spatialReference;\n          var mapExt = this._map.extent;\n          var o = new Point(mapExt.xmin, mapExt.ymax, sr);\n\n          var rows = Math.ceil(this._map.height / clusterSize);\n          var cols = Math.ceil(this._map.width / clusterSize);\n          var distX = mapExt.getWidth() / this._map.width * clusterSize;\n          var distY = mapExt.getHeight() / this._map.height * clusterSize;\n\n          for (var r = 0; r < rows; r++) {\n            for (var c = 0; c < cols; c++) {\n              var x1 = o.x + distX * c;\n              var y2 = o.y - distY * r;\n              var x2 = x1 + distX;\n              var y1 = y2 - distY;\n\n              var ext = new Extent(x1, y1, x2, y2, sr);\n\n              var cGraphics = [];\n              for (var i in features) {\n                var feature = features[i];\n                if (ext.contains(feature.geometry)) {\n                  total += 1;\n                  cGraphics.push(feature);\n                }\n              }\n              if (cGraphics.length > 0) {\n                var cPt = this.getClusterCenter(cGraphics);\n                this.clusterGraphics.push({\n                  center: cPt,\n                  graphics: cGraphics\n                });\n              }\n            }\n          }\n\n          //add cluster to map\n          for (var g in this.clusterGraphics) {\n            var clusterGraphic = this.clusterGraphics[g];\n            var count = clusterGraphic.graphics.length;\n            var data = clusterGraphic.graphics;\n            var label = utils.localizeNumber(count);\n            var size = label.length * 19;\n            var size2 = size;\n            size += 5;\n\n            var fnt = new Font();\n            fnt.family = \"Arial\";\n            fnt.size = \"16px\";\n            var symText = new TextSymbol(label, fnt, this.countColor);\n            symText.setOffset(0, -4);\n\n            var testSize;\n            if (this.symbolData && this.symbolData.symbol) {\n              if (this.symbolData.symbol.size) {\n                testSize = this.symbolData.symbol.size;\n              } else if (this.symbolData.symbol.width) {\n                var w = this.symbolData.symbol.width;\n                var h = this.symbolData.symbol.height;\n                testSize = w >= h ? w : h;\n              }\n            } else if (this.icon.width) {\n              size = this.icon.width >= size ? this.icon.width + 5 : size;\n              size = this.icon.height >= size ? this.icon.height + 5 : size;\n              size2 = this.icon.width >= size2 ? this.icon.width + 1 : size2;\n              size2 = this.icon.height >= size2 ? this.icon.height + 1 : size2;\n            } else if (this.icon.size) {\n              testSize = this.icon.size;\n            }\n\n            if (testSize) {\n              size = testSize >= size ? testSize + 5 : size;\n              size2 = testSize >= size2 ? testSize + 1 : size2;\n            }\n\n            if (size2 >= size) {\n              size += size2 - size === 0 ? 4 : size2 - size + 5;\n            }\n\n            this._setSymbols(size + 15, size);\n\n            var attr = {\n              Count: count,\n              Data: data\n            };\n            if (count > 1) {\n              if (typeof this.symbolData !== 'undefined') {\n                if (this.symbolData.symbolType !== 'CustomSymbol') {\n                  this.add(new Graphic(clusterGraphic.center, this.csym, attr));\n                  if (this.displayFeatureCount) {\n                    this.add(new Graphic(clusterGraphic.center, symText, attr));\n                  } else {\n                    this.add(new Graphic(clusterGraphic.center, this.csym3, attr));\n                  }\n                } else {\n                  this.add(new Graphic(clusterGraphic.center, this.csym, attr));\n                  if (this.displayFeatureCount) {\n                    this.add(new Graphic(clusterGraphic.center, symText, attr));\n                  } else {\n                    this.add(new Graphic(clusterGraphic.center, this.psym, attr));\n                  }\n                }\n              } else {\n                this.add(new Graphic(clusterGraphic.center, this.csym, attr));\n                if (this.displayFeatureCount) {\n                  this.add(new Graphic(clusterGraphic.center, symText, attr));\n                } else {\n                  this.add(new Graphic(clusterGraphic.center, this.psym, attr));\n                }\n              }\n            } else {\n              var pt = clusterGraphic.graphics[0].geometry;\n              var _g;\n              if (this.renderer) {\n                if ((this.renderer.hasOwnProperty(\"getSymbol\") || this.renderer.hasOwnProperty(\"symbol\")) && this.symbolData.symbolType === \"LayerSymbol\") {\n                  _g = new Graphic(pt, null, attr.Data[0].attributes, this.infoTemplate);\n                } else if (this.symbolData.symbolType === \"EsriSymbol\") {\n                  _g = new Graphic(pt, jsonUtils.fromJson(this.symbolData.symbol), attr, this.infoTemplate);\n                } else if (this.symbolData.symbolType !== \"LayerSymbol\") {\n                  _g = new Graphic(pt, this.psym, attr, this.infoTemplate);\n                } else {\n                  if (this.renderer.symbol) {\n                    _g = new Graphic(pt, null, attr, this.infoTemplate);\n                  } else {\n                    _g = new Graphic(pt, this.psym, attr, this.infoTemplate);\n                  }\n                }\n                if (typeof _g !== 'undefined') {\n                  this.add(_g);\n                }\n              }\n            }\n          }\n        }\n        this._updateNode(this.showAllFeatures ? features.length : total);\n      }\n    },\n\n    _updateNode: function _updateNode(total) {\n      if (!this.hidePanel) {\n        var updateNode;\n        if (this.node) {\n          this.node.innerHTML = utils.localizeNumber(total ? total : 0);\n          updateNode = this.node.parentNode;\n        } else {\n          if (this.legendNode) {\n            updateNode = this.legendNode.previousSibling;\n          }\n        }\n        this.updateExpand(updateNode, total && total > 0 && this.visible ? false : true);\n      }\n    },\n\n    _setSymbols: function _setSymbols(size, size2) {\n      var symColor = this.color.toRgb();\n      var fsp;\n      var style;\n      var lineWidth;\n      if (typeof this.symbolData !== 'undefined') {\n        var c;\n        //need to make a marker from the fill properties\n        if (this.backgroundClusterSymbol === \"custom\") {\n          c = symColor;\n        } else {\n          fsp = jsonUtils.fromJson(this.backgroundClusterSymbol);\n\n          if (fsp.outline.color.a === 0 || fsp.outline.width === 0) {\n            style = SimpleLineSymbol.STYLE_NULL;\n            lineWidth = 0;\n          } else {\n            style = SimpleLineSymbol.STYLE_SOLID;\n            lineWidth = fsp.outline.width;\n          }\n        }\n\n        if (fsp) {\n          var cls = SimpleLineSymbol(style, fsp.outline.color, lineWidth);\n          c = fsp.color.toRgb();\n          this.csym = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE, size, cls, new Color([c[0], c[1], c[2], 0.75]));\n        } else {\n          this.csym = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE, size, null, new Color([c[0], c[1], c[2], 0.75]));\n        }\n\n        var path = this.symbolData.s;\n        if (path && path.indexOf(\"${appPath}\") > -1) {\n          var pathName = window.location.pathname.replace('index.html', '');\n          path = this.symbolData.s.replace(\"${appPath}\", window.location.origin + pathName);\n        } else if (this.symbolData.s) {\n          path = this.symbolData.s;\n        } else {\n          path = this.icon.imageData;\n        }\n        if (path && this.symbolData.iconType === \"CustomIcon\") {\n          var _h, _w;\n          if (this.symbolData.symbol && this.symbolData.symbol.height) {\n            _h = this.symbolData.symbol.height;\n          }\n          if (this.symbolData.symbol && this.symbolData.symbol.width) {\n            _w = this.symbolData.symbol.width;\n          }\n          if (_h && _w) {\n            _h = _w > _h ? _w : _h;\n            _w = _h;\n          } else {\n            _h = this.symbolData.icon.height ? this.symbolData.icon.height : size2;\n            _w = this.symbolData.icon.width ? this.symbolData.icon.width : size2;\n          }\n          this.psym = new PictureMarkerSymbol(path, _h, _w);\n        } else if (path && this.symbolData.iconType === \"LayerIcon\") {\n          this.psym = jsonUtils.fromJson(this.symbolData.symbol);\n        } else {\n          if (this.icon.type === 'esriPMS') {\n            this.psym = this.icon;\n          } else {\n            var sls = SimpleLineSymbol(this.icon.outline.style, this.icon.outline.color, this.icon.outline.width);\n            this.psym = new SimpleMarkerSymbol(this.icon.style, this.icon.size, sls, this.icon.color);\n          }\n        }\n\n        //options for cluster with 1\n        this.csym2 = lang.clone(this.psym);\n        this.csym3 = lang.clone(this.csym2);\n        if (typeof this.csym2.xoffset !== 'undefined') {\n          this.csym3.xoffset = 0;\n        }\n        if (typeof this.csym2.yoffset !== 'undefined') {\n          this.csym3.yoffset = 0;\n        }\n      } else {\n        //options for cluster with more than 1\n        var cls1 = new SimpleLineSymbol(SimpleLineSymbol.STYLE_NULL, new Color(0, 0, 0, 0), 0);\n        this.csym = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE, size, cls1, new Color([symColor[0], symColor[1], symColor[2], 0.5]));\n        this.psym = new PictureMarkerSymbol(this.icon.url, size - 10, size - 10);\n\n        //options for cluster with 1\n        this.psym2 = new PictureMarkerSymbol(this.icon.url, size2 - 7, size2 - 7);\n        var cls2 = new SimpleLineSymbol(SimpleLineSymbol.STYLE_NULL, new Color(0, 0, 0, 0), 0);\n        this.csym2 = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE, size2, cls2, new Color([symColor[0], symColor[1], symColor[2], 0.5]));\n      }\n    },\n\n    _setupSymbols: function _setupSymbols() {\n      if (typeof this.symbolData !== 'undefined') {\n        this.countColor = this.symbolData._highLightColor;\n        this.backgroundClusterSymbol = this.symbolData.clusterSymbol;\n        this.icon = this.symbolData.icon;\n        if (this.symbolData.symbolType === \"LayerSymbol\") {\n          if (this._parentLayer.renderer) {\n            if (this._parentLayer.renderer.toJson) {\n              this.renderer = this._parentLayer.renderer;\n            } else {\n              this.renderer = renderUtils.fromJson(this._parentLayer.renderer);\n            }\n          } else if (this._testRenderer) {\n            this.renderer = renderUtils.fromJson(this._testRenderer);\n          } else if (this.symbolData.renderer) {\n            if (this.symbolData.renderer.toJson) {\n              this.renderer = this.symbolData.renderer;\n            } else {\n              this.renderer = renderUtils.fromJson(this.symbolData.renderer);\n            }\n          }\n        } else {\n          this.renderer = new SimpleRenderer(jsonUtils.fromJson(this.symbolData.symbol));\n        }\n        var symColor = this.color.toRgb();\n        var cls = new SimpleLineSymbol(SimpleLineSymbol.STYLE_NULL, new Color(0, 0, 0, 0), 0);\n        this._singleSym = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE, 9, cls, new Color([symColor[0], symColor[1], symColor[2], 0.5]));\n      }\n    },\n\n    getLayer: function getLayer() {\n      return this;\n    },\n\n    getClusterCenter: function getClusterCenter(graphics) {\n      var xSum = 0;\n      var ySum = 0;\n      var count = graphics.length;\n      array.forEach(graphics, function (graphic) {\n        xSum += graphic.geometry.x;\n        ySum += graphic.geometry.y;\n      }, this);\n      var cPt = new Point(xSum / count, ySum / count, graphics[0].geometry.spatialReference);\n      return cPt;\n    },\n\n    destroy: function destroy() {\n      this._clear();\n      this.removeEventListeners();\n    },\n\n    _clear: function _clear() {\n      this.clear();\n      this._features = [];\n    },\n\n    _updateEnd: function _updateEnd() {\n      if (this.url) {\n        this.loadData(this.url);\n      }\n    }\n\n  });\n\n  return clusterLayer;\n});\n//# sourceMappingURL=ClusterLayer.js.map\n"]}